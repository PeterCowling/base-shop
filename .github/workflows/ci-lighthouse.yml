name: Lighthouse CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: lhci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect app changes
    if: >-
      ${{
        github.event_name != 'pull_request' ||
        github.base_ref != 'main' ||
        !contains(join(github.event.pull_request.labels.*.name, ','), 'promote-app:') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:brikette') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:shop') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:skylar')
      }}
    # Always run so downstream jobs with `needs: [changes]` aren't skipped on push.
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      shop_skylar: ${{ steps.filter.outputs.shop_skylar }}
      brikette: ${{ steps.brikette-filter.outputs.brikette }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect app-impacting changes for LHCI
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git diff --name-only "origin/${{ github.base_ref }}...HEAD" > /tmp/changed-files.txt 2>/dev/null || echo "" > /tmp/changed-files.txt
          else
            git diff --name-only "${{ github.event.before }}..${{ github.sha }}" > /tmp/changed-files.txt 2>/dev/null || echo "" > /tmp/changed-files.txt
          fi
          node scripts/ci/path-classifier.cjs --config lighthouse --paths-file /tmp/changed-files.txt --format outputs >> "$GITHUB_OUTPUT"
      - name: Detect Brikette changes for LHCI
        id: brikette-filter
        run: |
          if grep -qE '^apps/brikette/|^lighthouserc\.brikette' /tmp/changed-files.txt 2>/dev/null; then
            echo "brikette=true" >> "$GITHUB_OUTPUT"
          else
            echo "brikette=false" >> "$GITHUB_OUTPUT"
          fi

  lhci:
    name: Lighthouse (${{ matrix.config }})
    needs: [changes]
    # Run on all pushes to main. For PRs, only run when:
    # - Shop/Skylar or Brikette paths changed, or
    # - The PR has a `run-lhci` label.
    if: |
      (
        github.event_name != 'pull_request' ||
        github.base_ref != 'main' ||
        !contains(join(github.event.pull_request.labels.*.name, ','), 'promote-app:') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:brikette') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:shop') ||
        contains(github.event.pull_request.labels.*.name, 'promote-app:skylar')
      ) &&
      (
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
        (
          needs.changes.outputs.shop_skylar == 'true' ||
          needs.changes.outputs.brikette == 'true' ||
          contains(github.event.pull_request.labels.*.name, 'run-lhci')
        )
      )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        config:
          [
            lighthouserc.shop.json,
            lighthouserc.shop.desktop.json,
            lighthouserc.skylar.json,
            lighthouserc.skylar.desktop.json,
            lighthouserc.brikette.json,
            lighthouserc.brikette.desktop.json,
          ]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo

      - name: Build apps for LHCI
        run: |
          pnpm --filter @apps/cover-me-pretty... --filter @apps/skylar... --filter @apps/brikette... build

      - name: Setup Chrome for LHCI
        id: chrome
        uses: browser-actions/setup-chrome@v1

      - name: Run LHCI (mobile/desktop via matrix)
        env:
          LHCI_USERNAME: ${{ secrets.LHCI_USERNAME }}
          LHCI_PASSWORD: ${{ secrets.LHCI_PASSWORD }}
          CHROME_PATH: ${{ steps.chrome.outputs.chrome-path }}
        run: pnpm dlx @lhci/cli@0.15.1 autorun --config=${{ matrix.config }} --upload.target=temporary-public-storage

      - name: Upload LHCI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lhci-${{ matrix.config }}
          path: .lighthouseci/**
