---
Type: Fact-Find
Outcome: Planning
Status: Active
Domain: Automation
Workstream: Mixed
Created: 2026-02-10
Last-updated: 2026-02-10
Last-reviewed: 2026-02-10
Deep-Dive-Date: 2026-02-10
Relates-to charter: docs/business-os/business-os-charter.md
Feature-Slug: email-autodraft-world-class-upgrade
Deliverable-Type: multi-deliverable
Execution-Track: mixed
Primary-Execution-Skill: lp-do-build
Supporting-Skills: draft-email, ops-inbox
Related-Plan: docs/plans/email-autodraft-world-class-upgrade-plan.md  <!-- not yet created; will be generated by /lp-do-plan -->
Business-Unit: BRIK
Card-ID: BRIK-ENG-0020
---

# Email Autodraft World-Class Upgrade Fact-Find Brief

## Scope
### Summary
Audit and upgrade the Brikette email autodraft system from deterministic template assembly to policy-safe, high-quality responses for high-stakes guest communication (especially cancellation/refund and non-refundable disputes), while keeping Gmail + MCP workflow continuity.

### Goals
- Raise draft quality from template adequacy to policy-safe, context-aware, professional communication.
- Reduce and then remove Google Apps Script dependency from core queueing/sending.
- Add robust handling for high-stakes categories (non-refundable, refund denial, payment disputes, cancellation edge cases).
- Align classification, template taxonomy, quality checks, and workflow transitions.
- Establish measurable quality and safety gates.

### Non-goals
- Fully autonomous sending without human review.
- Replacing Gmail as mailbox platform.
- Broad multi-language expansion in first phase (focus on EN first, preserve IT/ES baseline support).
- Rebuilding unrelated reception/marketing systems.

### Constraints and Assumptions
- Preserve human-in-loop review before send.
- Keep MCP interfaces backward compatible where practical (`packages/mcp-server/src/tools/gmail.ts`).
- No shortcut quality fixes; enforceable guardrails are required.
- Existing label-driven operational flow remains the live baseline (`.claude/skills/ops-inbox/SKILL.md`).
- Working direction confirmed by sponsor on 2026-02-10: hybrid architecture is preferred (deterministic for routine scenarios, richer composition path for sensitive scenarios).
- Policy posture confirmed on 2026-02-10: non-refundable bookings receive no concessions/refunds. Language can be softened, but policy meaning is fixed.

## Evidence Method and Labels
To separate facts from interpretation:
- `[Fact]` = directly verifiable from code/docs/tests.
- `[Inference]` = reasoned conclusion from facts.
- `[Estimate]` = directional estimate; not instrumented.

## Reproducibility and Caveats
| Item | Value | Confidence | Method | Caveat |
|---|---|---|---|---|
| Template corpus size | 38 templates, 19 categories | High | Parsed `packages/mcp-server/data/email-templates.json` | Category names are inconsistent, so category-level analysis can be noisy. |
| Pipeline fixture count | 36 fixtures total | High | Parsed `packages/mcp-server/src/__tests__/pipeline-integration.test.ts` | Static fixture mix only; does not prove production mix. |
| Customer fixture count in full pipeline block | 31 fixtures (`requiresResponse && scenarioType !== "system"`) | High | Parsed fixture fields in same file and matched filter logic at `packages/mcp-server/src/__tests__/pipeline-integration.test.ts:685` | Still test-only distribution. |
| Cancellation fixture share (scenarioType) | 2/36 (5.6%) | High | Regex count on `scenarioType` values | Uses test fixture taxonomy, not live inbox labels. |
| Cancellation fixture share (expectedCategory) | 4/36 (11.1%) | High | Regex count on `expectedCategory` values | Same limitation as above. |
| Quality pass threshold in integration test | `>= 0.9` | High | Assertion in `packages/mcp-server/src/__tests__/pipeline-integration.test.ts:734` | Threshold exists, but quality semantics are limited by check design. |
| Actual local pass rate re-run in this session | Unknown | High | Targeted jest attempts blocked by workspace module collisions (`.open-next`, `.worktrees/do-not-use`) | This doc treats pass-rate claims as conditional, not absolute. |
| Operator friction time cost | ~8-15 minutes per 10-email session | Medium-Low | `[Estimate]` based on workflow step decomposition from `.claude/skills/ops-inbox/SKILL.md:25` onward | Not instrumented in telemetry; treat as directional until measured. |

## Evidence Audit (Current State)
### Entry Points
- `packages/mcp-server/src/tools/gmail.ts`
- `packages/mcp-server/src/tools/draft-interpret.ts`
- `packages/mcp-server/src/tools/draft-generate.ts`
- `packages/mcp-server/src/tools/draft-quality-check.ts`
- `.claude/skills/ops-inbox/SKILL.md`
- `apps/reception/src/services/useBookingEmail.ts`
- `apps/reception/src/services/useEmailGuest.ts`
- `apps/reception/src/app/api/mcp/booking-email/route.ts`
- `apps/brikette-scripts/src/email-monitor/Code.gs`

### Key Data and Contract Notes
- Generator input accepts rich `EmailActionPlan` fields, but generation logic largely uses scenario + text and template ranking (`packages/mcp-server/src/tools/draft-generate.ts:30`, `packages/mcp-server/src/tools/draft-generate.ts:223`).
- Quality gate currently relies on structural checks and keyword coverage (`packages/mcp-server/src/tools/draft-quality-check.ts:168`, `packages/mcp-server/src/tools/draft-quality-check.ts:211`).
- Workflow state is Gmail-label centric with in-memory lock sidecar (`packages/mcp-server/src/tools/gmail.ts:72`, `packages/mcp-server/src/tools/gmail.ts:581`).

## Deep Findings
### F1. Generation underuses available action-plan intelligence
- `[Fact]` `draft_generate` selects templates and assembles body from template text (`packages/mcp-server/src/tools/draft-generate.ts:231`, `packages/mcp-server/src/tools/draft-generate.ts:241`).
- `[Fact]` `handleDraftGuideRead()` and `handleVoiceExamplesRead()` are called but return values are not consumed (`packages/mcp-server/src/tools/draft-generate.ts:259`).
- `[Fact]` Knowledge resources are reduced to count-style summaries (`items:n`, `keys:n`) via `loadKnowledgeSummaries` (`packages/mcp-server/src/tools/draft-generate.ts:129`).
- `[Inference]` The system already extracts richer signals than it uses for composition quality.
- Confidence: High.

### F2. No entity grounding for booking-specific decisions
- `[Fact]` Generator schema does not include booking entity fields (booking type, payment status, cancellation window, prior concessions); it expects normalized text + scenario (`packages/mcp-server/src/tools/draft-generate.ts:30`).
- `[Fact]` Reception booking route is a thin pass-through to `sendBookingEmail` (`apps/reception/src/app/api/mcp/booking-email/route.ts:5`).
- `[Inference]` Sensitive replies can remain generic when booking-specific facts are needed.
- Confidence: High.

### F3. Quality gate is structurally useful but semantically shallow
- `[Fact]` Question coverage check uses `every(question)` but inside each question uses `keywords.some(...)`; a single matched keyword can satisfy a multi-part question (`packages/mcp-server/src/tools/draft-quality-check.ts:172`, `packages/mcp-server/src/tools/draft-quality-check.ts:177`).
- `[Fact]` Contradiction check only detects `not` near commitment tokens (`packages/mcp-server/src/tools/draft-quality-check.ts:193`).
- `[Fact]` Current failed checks focus on presence/format (plaintext, html, signature, required link, prohibited claims) (`packages/mcp-server/src/tools/draft-quality-check.ts:223`).
- `[Inference]` The gate catches many structural defects but can miss factual completeness and tone quality.
- Confidence: High.

### F4. Template quality distribution appears misaligned with risk level
- `[Fact]` Corpus has 38 templates with only 2 explicit `cancellation` templates (`packages/mcp-server/data/email-templates.json`).
- `[Fact]` High-stakes templates include language that can read rigid or defensive in hardship scenarios (for example "pre-paid, non-refundable" and irreversible framing) (`packages/mcp-server/data/email-templates.json`).
- `[Estimate]` Prior A/B/C/D grading is directional and should be treated as provisional until a documented rubric is run by multiple reviewers.
- `[Inference]` High-stakes scenario coverage and tone calibration need targeted rewrite and policy controls.
- Confidence: Medium (because grading was expert judgment, not fully rubric-instrumented yet).

### F5. Intent/scenario parsing is heuristic-heavy for a high-stakes role
- `[Fact]` Questions are split by `?` (`packages/mcp-server/src/tools/draft-interpret.ts:257`).
- `[Fact]` Requests use three regex patterns with first-match semantics (`packages/mcp-server/src/tools/draft-interpret.ts:271`, `packages/mcp-server/src/tools/draft-interpret.ts:273`).
- `[Fact]` Scenario classifier is ordered regex with fixed confidence outputs (`packages/mcp-server/src/tools/draft-interpret.ts:406`).
- `[Inference]` Multi-intent and nuanced edge cases can be compressed into a single coarse class.
- Confidence: High.

### F6. Google Apps Script remains in live-path dependencies
- `[Fact]` Reception hook still falls back to GAS endpoint when MCP flag is disabled (`apps/reception/src/services/useBookingEmail.ts:120`, `apps/reception/src/services/useBookingEmail.ts:142`).
- `[Fact]` `useEmailGuest` still sends directly to GAS endpoint (`apps/reception/src/services/useEmailGuest.ts:35`).
- `[Fact]` Inbox monitoring is GAS-based (`apps/brikette-scripts/src/email-monitor/Code.gs:116`, `apps/brikette-scripts/src/email-monitor/Code.gs:259`).
- `[Inference]` Architecture remains partially split across runtime stacks.
- Confidence: High.

### F7. Workflow and operability constraints remain
- `[Fact]` Process flow requires multiple sequential stages per email (`.claude/skills/ops-inbox/SKILL.md:25`, `.claude/skills/ops-inbox/SKILL.md:80`, `.claude/skills/ops-inbox/SKILL.md:157`).
- `[Fact]` Queue listing currently performs per-message metadata fetch and per-thread checks in loop (`packages/mcp-server/src/tools/gmail.ts:464`, `packages/mcp-server/src/tools/gmail.ts:479`).
- `[Estimate]` Session overhead estimate (8-15 min per 10 emails) is directional until measured.
- Confidence: Medium.

### F8. State, test, and consistency risks exist around current implementation
- `[Fact]` Processing lock state is in-memory map with stale fallback based on message `internalDate` (`packages/mcp-server/src/tools/gmail.ts:420`, `packages/mcp-server/src/tools/gmail.ts:581`).
- `[Fact]` Knowledge resource includes hardcoded room/menu details and explicit sync TODO (`packages/mcp-server/src/resources/brikette-knowledge.ts:116`, `packages/mcp-server/src/resources/brikette-knowledge.ts:172`).
- `[Fact]` Template taxonomy is heterogeneous (19 categories) while interpret classifier emits coarse categories (`packages/mcp-server/data/email-templates.json`, `packages/mcp-server/src/tools/draft-interpret.ts:406`).
- Confidence: High.

## Risk Register
| Risk | Probability | Impact | Why it matters | Mitigation direction |
|---|---|---|---|---|
| Policy/tone misfire in sensitive cancellations | Medium-High | High | Can trigger complaints/chargebacks/reputation damage | Add policy decision layer, empathy + completeness checks, mandatory review tier for sensitive cases. |
| Dual-stack operations (Node + GAS) drift | High | Medium-High | Inconsistent behavior and troubleshooting complexity | Migrate to MCP-primary with timed fallback deprecation and explicit kill switch. |
| False confidence from current quality pass metrics | High | High | Could ship poor high-stakes drafts with "green" signals | Rebalance regression corpus and strengthen evaluator criteria before relying on pass rates. |
| Hardcoded knowledge drift | Medium | Medium | Drafts can cite outdated facts | Replace hardcoded segments with generated JSON or runtime source-of-truth ingestion. |
| Queue lock/stale handling edge cases | Medium | Medium | Can cause duplicate processing or stuck states | Persist lock metadata or strengthen label-state reconciliation with deterministic recovery. |

## Questions
### Resolved
- Q: Is GAS still in critical paths?
  - A: Yes. Evidence in reception send hooks and inbox monitor script.
- Q: Is current generation policy-aware composition by design?
  - A: No. It is deterministic template-led generation plus shallow rule checks.
- Q: Can incorrect cancellation variant selection happen?
  - A: Yes. Hard-rule category behavior and template ordering can bias early candidates.
- Q: Should hybrid architecture be treated as working direction for planning?
  - A: Yes. Confirmed by sponsor on 2026-02-10; this brief now frames it as a factual planning constraint rather than an unresolved architecture vote.
- Q: What exception policy should apply for non-refundable hardship cases?
  - A: No concessions ever. Outcome is fixed: no refund/exception for non-refundable bookings.
  - Note: Canonical wording should align with the existing Gmail template and be mirrored in local templates/repo assets.
- Q: What tone policy should apply for negative outcomes (refund denied/no reinstatement)?
  - A: Factual and professional, but not cold. Soften phrasing, not policy meaning.
- Q: How should multilingual handling work in phase 1 for sensitive scenarios?
  - A: EN only.
- Q: For phase 1, should GAS be retained as a time-boxed fallback, or removed completely at cutover?
  - A: Hard cut to MCP-only at release (no fallback window).
- Q: What minimum booking context is mandatory before composing sensitive drafts?
  - A: Balanced set: booking type + payment status + cancellation deadline + prior staff commitments.
- Q: What operator UX tradeoff is acceptable for context capture?
  - A: No upfront context step; reviewer validates/edit drafts after compilation.
- Q: Which source is canonical for non-refundable/no-refund response wording?
  - A: Gmail template text is canonical source.

### Open (User Input Requested)
1. What escalation thresholds define `HIGH` and `CRITICAL`?
   - Current accepted trigger set:
     - `HIGH`: cancellation/refund dispute, chargeback hint, repeated complaint, vulnerable circumstance mentioned.
     - `CRITICAL`: legal threat, regulator/platform escalation threat, public-media threat, high-value dispute, explicit accusation of misconduct/fraud.
   - Remaining decision needed: set the high-value dispute amount threshold (EUR).
2. Do you want the canonical Gmail non-refundable template text copied into repo now (so local + live are synchronized)?
   - If yes: provide/paste the exact Gmail template text for import.

## Provisional Confidence Inputs (for /lp-do-plan)
These are handoff inputs, not final plan commitments.
- Implementation: 74%
- Approach: 81%
- Impact: 78%
- Delivery-Readiness: 73%
- Testability: 62%

Rationale summary:
- Confidence is constrained by open policy decisions, limited semantic quality evaluation, and current fixture/test signal limitations.
- Confidence should be recalculated in `/lp-do-plan` after open questions are answered.

## Planning Boundary (Fact-Find vs Planning)
The following are explicitly planning-owned and intentionally not finalized in this lp-do-fact-find:
- Final phase gates and milestone definitions.
- Atomic task decomposition and dependency graph.
- CI thresholds for new evaluator gates.
- Rollout sequencing and go/no-go criteria.

## Appendix A - Planning Hypotheses (Moved from Main Body)
These are retained as planning inputs only. They are intentionally non-atomic and must be decomposed in `/lp-do-plan`.

- Hypothesis A1: Wire unused `EmailActionPlan` fields into generation and quality checks.
- Hypothesis A2: Replace count-only knowledge summaries with usable cited knowledge snippets.
- Hypothesis A3: Upgrade question-answer validation from global keyword presence to per-question coverage.
- Hypothesis A4: Rewrite high-stakes templates (cancellation/refund/dispute) against an explicit tone-policy rubric.
- Hypothesis A5: Add missing high-stakes scenario coverage (medical hardship, dispute workflow, overbooking handling, accessibility requests).
- Hypothesis A6: Introduce escalation-tier routing and policy decision objects before composition.
- Hypothesis A7: Unify taxonomy across interpret/rank/templates/quality.
- Hypothesis A8: Improve `/ops-inbox` operator ergonomics (evidence display, batch handling for low-risk routines, escalation-first queueing).
- Hypothesis A9: Migrate to MCP-only send/monitor path and retire GAS.

## Appendix B - Repro Commands Used in this Fact-Find
```bash
# Template corpus counts
node -e 'const fs=require("fs");const t=JSON.parse(fs.readFileSync("packages/mcp-server/data/email-templates.json","utf8"));console.log(t.length)'

# Fixture distribution checks
node -e 'const fs=require("fs");const s=fs.readFileSync("packages/mcp-server/src/__tests__/pipeline-integration.test.ts","utf8");console.log([...s.matchAll(/scenarioType:\s*"([^"]+)"/g)].length)'

# Local test run attempt (blocked by workspace collisions in this environment)
pnpm exec jest --config ./jest.config.cjs --runTestsByPath packages/mcp-server/src/__tests__/pipeline-integration.test.ts --maxWorkers=2
```
