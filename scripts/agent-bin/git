#!/usr/bin/env bash
set -euo pipefail

# This wrapper is intended for agent shells only (see scripts/agents/with-git-guard.sh).
# It blocks a small set of destructive/history-rewriting commands that have caused
# accidental rollbacks and lost work.

wrapper_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
real_git=""

IFS=":" read -r -a path_entries <<< "${PATH:-}"
for dir in "${path_entries[@]}"; do
  [[ -z "$dir" ]] && continue
  if [[ "$(cd "$dir" 2>/dev/null && pwd)" == "$wrapper_dir" ]]; then
    continue
  fi
  if [[ -x "${dir}/git" ]]; then
    real_git="${dir}/git"
    break
  fi
done

if [[ -z "$real_git" ]]; then
  echo "ERROR: unable to locate real git binary on PATH" >&2
  exit 127
fi

deny() {
  local why="$1"
  shift

  echo "------------------------------------------------------------------" >&2
  echo "GIT COMMAND BLOCKED (agent guard)" >&2
  echo "------------------------------------------------------------------" >&2
  echo "" >&2
  echo "Reason: ${why}" >&2
  echo "" >&2
  echo "Command:" >&2
  printf "  git"
  for arg in "$@"; do
    printf " %q" "$arg"
  done
  echo "" >&2
  echo "" >&2
  echo "Safer alternatives:" >&2
  echo "  - Make a checkpoint commit, then revert if needed" >&2
  echo "  - Use integrator mode (writer lock + guard): scripts/agents/integrator-shell.sh" >&2
  echo "  - Read: docs/git-safety.md" >&2
  echo "" >&2
  exit 1
}

is_bulk_pathspec() {
  local pathspec="$1"

  # Repo-wide patterns (always unsafe for agents).
  case "$pathspec" in
    "."|":/"|":/."|":/*")
      return 0
      ;;
  esac

  # Pathspec magic / globs can expand to many files.
  # Examples: `src/**`, `*.ts`, `:(glob)apps/**`, etc.
  if [[ "$pathspec" == *":("* ]]; then
    return 0
  fi
  if [[ "$pathspec" == *"*"* || "$pathspec" == *"?"* || "$pathspec" == *"["* || "$pathspec" == *"]"* ]]; then
    return 0
  fi

  # Directories imply multiple files (bulk discard).
  if [[ "$pathspec" == */ || ( -e "$pathspec" && -d "$pathspec" ) ]]; then
    return 0
  fi

  return 1
}

subcommand="${1:-}"

case "$subcommand" in
  worktree)
    deny "git worktree adds extra checkouts; Base-Shop workflow forbids worktrees." "$@"
    ;;
  reset)
    for arg in "$@"; do
      case "$arg" in
        --hard|--soft|--mixed|--merge|--keep)
          deny "git reset with mode flags rewrites state and can lose work." "$@"
          ;;
      esac
    done
    ;;
  clean)
    has_f="0"
    has_d="0"
    for arg in "$@"; do
      [[ "$arg" == "-f" || "$arg" == "--force" ]] && has_f="1"
      [[ "$arg" == "-d" ]] && has_d="1"
      [[ "$arg" == "-fd" || "$arg" == "-df" ]] && { has_f="1"; has_d="1"; }
    done
    if [[ "$has_f" == "1" && "$has_d" == "1" ]]; then
      deny "git clean -fd permanently deletes untracked files." "$@"
    fi
    ;;
  push)
    for arg in "$@"; do
      case "$arg" in
        --force|-f|--force-with-lease)
          deny "force-push rewrites remote history and can destroy teammates' work." "$@"
          ;;
      esac
    done
    ;;
  rebase)
    deny "rebase rewrites history; use merge commits via PRs instead." "$@"
    ;;
  commit)
    for arg in "$@"; do
      case "$arg" in
        --amend)
          deny "amend rewrites history; prefer a new commit and merge via PR." "$@"
          ;;
      esac
    done
    ;;
  checkout)
    # Only block checkout when used as a discard operation (pathspec form):
    #   git checkout -- <pathspec...>
    args=("$@")
    pathspecs=()
    for i in "${!args[@]}"; do
      if [[ "${args[$i]}" == "--" ]]; then
        pathspecs=("${args[@]:$((i + 1))}")
        break
      fi
    done

    if [[ ${#pathspecs[@]} -gt 0 ]]; then
      if [[ ${#pathspecs[@]} -gt 1 ]]; then
        deny "bulk discard via git checkout -- <pathspec...> is forbidden for agents." "$@"
      fi
      for pathspec in "${pathspecs[@]}"; do
        if is_bulk_pathspec "$pathspec"; then
          deny "bulk discard pathspec detected for git checkout." "$@"
        fi
      done
    fi
    ;;
  restore)
    # git restore is a discard operation by default (worktree). Allow index-only restores
    # (e.g. `git restore --staged <file>`) but block any bulk discard patterns.
    args=("$@")
    has_staged="0"
    has_worktree="0"
    has_pathspec_from_file="0"

    for arg in "${args[@]}"; do
      [[ "$arg" == "--staged" ]] && has_staged="1"
      [[ "$arg" == "--worktree" ]] && has_worktree="1"
      [[ "$arg" == "--pathspec-from-file" || "$arg" == --pathspec-from-file=* ]] && has_pathspec_from_file="1"
    done

    if [[ "$has_pathspec_from_file" == "1" ]]; then
      deny "git restore --pathspec-from-file can discard many files; forbidden for agents." "$@"
    fi

    touches_worktree="0"
    if [[ "$has_worktree" == "1" || "$has_staged" == "0" ]]; then
      touches_worktree="1"
    fi

    # Collect pathspecs. Prefer `--` delimiter; otherwise parse non-option args,
    # skipping values for the few common options that take a parameter.
    pathspecs=()
    saw_double_dash="0"
    for i in "${!args[@]}"; do
      if [[ "${args[$i]}" == "--" ]]; then
        saw_double_dash="1"
        pathspecs=("${args[@]:$((i + 1))}")
        break
      fi
    done

    if [[ "$saw_double_dash" == "0" ]]; then
      i=1
      while [[ $i -lt ${#args[@]} ]]; do
        arg="${args[$i]}"
        case "$arg" in
          --source|-s|--pathspec-from-file)
            # Skip option value
            i=$((i + 2))
            continue
            ;;
          --source=*|--pathspec-from-file=*)
            i=$((i + 1))
            continue
            ;;
          --)
            # Shouldn't happen here, but keep safe
            i=$((i + 1))
            continue
            ;;
        esac

        if [[ "$arg" == -* ]]; then
          i=$((i + 1))
          continue
        fi

        pathspecs+=("$arg")
        i=$((i + 1))
      done
    fi

    if [[ "$touches_worktree" == "1" ]]; then
      if [[ ${#pathspecs[@]} -gt 1 ]]; then
        deny "bulk discard via git restore <pathspec...> is forbidden for agents." "$@"
      fi
      for pathspec in "${pathspecs[@]}"; do
        if is_bulk_pathspec "$pathspec"; then
          deny "bulk discard pathspec detected for git restore." "$@"
        fi
      done
    fi
    ;;
  stash)
    deny "stash hides work and increases rollback risk in a multi-agent repo." "$@"
    ;;
esac

exec "$real_git" "$@"
