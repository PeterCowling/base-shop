"use strict";(self.webpackChunk_apps_storybook=self.webpackChunk_apps_storybook||[]).push([[295],{"../../packages/ui/src/components/upload/UploaderSurface.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__,q:()=>UploaderSurface});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react/jsx-runtime.js"),react__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react/index.js"),_atoms_shadcn__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("../../packages/ui/src/components/atoms/shadcn/index.ts"),_atoms__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("../../packages/ui/src/components/atoms/index.ts"),_utils_style__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("../../packages/ui/src/utils/style/index.ts"),_acme_i18n__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("../../packages/i18n/src/index.ts");const ACCEPT="image/*,video/*";function UploaderSurface(props){const{inputRef,pendingFile,progress,error,isValid,isVideo,requiredOrientation,onDrop,onFileChange,openFileDialog}=props,[dragActive,setDragActive]=(0,react__WEBPACK_IMPORTED_MODULE_1__.useState)(!1),suppressClickFromKeyboardRef=(0,react__WEBPACK_IMPORTED_MODULE_1__.useRef)(!1),t=(0,_acme_i18n__WEBPACK_IMPORTED_MODULE_5__.c3)();return(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{tabIndex:0,role:"button","aria-label":t("upload.dropHelp"),"aria-describedby":"uploader-feedback",onClick:()=>{suppressClickFromKeyboardRef.current?suppressClickFromKeyboardRef.current=!1:openFileDialog()},onDragOver:e=>e.preventDefault(),onDragEnter:()=>setDragActive(!0),onDragLeave:()=>setDragActive(!1),onDrop:e=>{setDragActive(!1),onDrop(e)},onKeyDown:e=>{const key=e.key;"Enter"!==key&&" "!==key&&"Spacebar"!==key&&"Space"!==key||(suppressClickFromKeyboardRef.current=!0,e.preventDefault(),openFileDialog(),setTimeout(()=>{suppressClickFromKeyboardRef.current=!1},0))},className:(0,_utils_style__WEBPACK_IMPORTED_MODULE_4__.cn)("rounded border-2 border-dashed p-4 text-center",dragActive&&"ring-2 ring-primary/60 bg-primary/5"),children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("input",{ref:inputRef,type:"file",accept:ACCEPT,capture:"environment",className:"hidden",onChange:onFileChange}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("p",{className:"mb-2",children:t("upload.dragDropOr")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_atoms_shadcn__WEBPACK_IMPORTED_MODULE_2__.$n,{type:"button",onClick:openFileDialog,className:"h-auto px-3 py-1 text-sm",children:t("upload.browse")}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{id:"uploader-feedback",role:"status","aria-live":"polite",children:[pendingFile&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("p",{className:"text-muted-foreground mt-2 text-sm",children:pendingFile.name}),progress&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("p",{className:"mt-2 text-sm",children:[t("upload.uploading")," ",progress.done,"/",progress.total]}),error&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_atoms__WEBPACK_IMPORTED_MODULE_3__.Fc,{variant:"danger",tone:"soft",heading:error,className:"mt-2"}),!1===isValid&&!isVideo&&(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_atoms__WEBPACK_IMPORTED_MODULE_3__.Fc,{variant:"warning",tone:"soft",heading:t("upload.orientationWrong",{required:requiredOrientation}),className:"mt-2"})]})]})}const __WEBPACK_DEFAULT_EXPORT__=UploaderSurface;UploaderSurface.__docgenInfo={description:"",methods:[],displayName:"UploaderSurface",props:{inputRef:{required:!0,tsType:{name:"RefObject",elements:[{name:"union",raw:"HTMLInputElement | null",elements:[{name:"HTMLInputElement"},{name:"null"}]}],raw:"RefObject<HTMLInputElement | null>"},description:""},pendingFile:{required:!0,tsType:{name:"union",raw:"File | null",elements:[{name:"File"},{name:"null"}]},description:""},progress:{required:!0,tsType:{name:"union",raw:"UploadProgress | null",elements:[{name:"UploadProgress"},{name:"null"}]},description:""},error:{required:!1,tsType:{name:"string"},description:""},isValid:{required:!0,tsType:{name:"union",raw:"boolean | null",elements:[{name:"boolean"},{name:"null"}]},description:""},isVideo:{required:!0,tsType:{name:"boolean"},description:""},requiredOrientation:{required:!0,tsType:{name:"z.infer",elements:[{name:"imageOrientationSchema"}],raw:"z.infer<typeof imageOrientationSchema>"},description:""},onDrop:{required:!0,tsType:{name:"signature",type:"function",raw:"(e: React.DragEvent<HTMLDivElement>) => void",signature:{arguments:[{type:{name:"ReactDragEvent",raw:"React.DragEvent<HTMLDivElement>",elements:[{name:"HTMLDivElement"}]},name:"e"}],return:{name:"void"}}},description:""},onFileChange:{required:!0,tsType:{name:"signature",type:"function",raw:"(e: React.ChangeEvent<HTMLInputElement>) => void",signature:{arguments:[{type:{name:"ReactChangeEvent",raw:"React.ChangeEvent<HTMLInputElement>",elements:[{name:"HTMLInputElement"}]},name:"e"}],return:{name:"void"}}},description:""},openFileDialog:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""}}}},"../../packages/ui/src/hooks/useFileUpload.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Ay:()=>hooks_useFileUpload,lN:()=>useFileUpload});var jsx_runtime=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react/index.js"),react_dom=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react-dom/index.js"),useImageOrientationValidation=__webpack_require__("../../packages/ui/src/hooks/useImageOrientationValidation.ts");function validateFilePolicy(file,allowedMimePrefixes,maxBytes){if(maxBytes&&file.size>maxBytes)return`File too large (>${Math.round(maxBytes/1048576)}MB)`;if(allowedMimePrefixes.length&&file.type){if(!allowedMimePrefixes.some(p=>file.type.startsWith(p)))return`Unsupported file type: ${file.type}`}}function isSafeHttpUrl(raw){try{const scheme=`${new URL(raw).protocol}`.toLowerCase();return"javascript:"!==scheme&&"data:"!==scheme&&("http:"===scheme||"https:"===scheme)}catch(e){return!1}}const t=s=>s;async function ingestExternalUrl(url,opts){var _opts_allowExternalUrl;const allowExternalUrl=null!==(_opts_allowExternalUrl=opts.allowExternalUrl)&&void 0!==_opts_allowExternalUrl?_opts_allowExternalUrl:()=>!0;if(!isSafeHttpUrl(url))return{file:null,error:t("Blocked URL scheme"),handled:"url"};if(!allowExternalUrl(url))return{file:null,error:t("External URL not allowed by policy"),handled:"url"};try{const res=await fetch(url,{mode:"cors"});if(!res.ok)throw new Error(`Failed to fetch resource (${res.status})`);const ct=res.headers.get("content-type")||"";if(opts.allowedMimePrefixes.length&&ct){if(!opts.allowedMimePrefixes.some(p=>ct.startsWith(p)))throw new Error(`Unsupported content-type: ${ct}`)}const blob=await res.blob();if(opts.maxBytes&&blob.size>opts.maxBytes)throw new Error(`File too large (>${Math.round(opts.maxBytes/1048576)}MB)`);const name=(()=>{try{const u=new URL(url);return u.pathname.split("/").filter(Boolean).pop()||"asset"}catch(e){return"asset"}})();return{file:new File([blob],name,{type:blob.type||ct||"application/octet-stream"}),handled:"url"}}catch(err){return{file:null,error:err instanceof Error?err.message:String(err),handled:"url"}}}async function ingestFromText(text,opts){const url=function extractUrlFromText(text){try{const trimmed=text.trim();if(isSafeHttpUrl(trimmed))return trimmed;const m=trimmed.match(/https?:\/\/[^\s]+/i);return m&&isSafeHttpUrl(m[0])?m[0]:null}catch(e){return null}}(text)||"";return!url&&text?{file:null,handled:"text"}:url?ingestExternalUrl(url,opts):{file:null,handled:"none"}}var UploaderSurface=__webpack_require__("../../packages/ui/src/components/upload/UploaderSurface.tsx");const DEFAULT_PREFIXES=["image/","video/"];function useFileUpload(options){var _pendingFile_type;const{shop,requiredOrientation,onUploaded}=options,[pendingFile,setPendingFile]=(0,react.useState)(null),[altText,setAltText]=(0,react.useState)(""),[tags,setTags]=(0,react.useState)(""),[progress,setProgress]=(0,react.useState)(null),[error,setError]=(0,react.useState)(),inputRef=(0,react.useRef)(null),uploadingRef=(0,react.useRef)(!1),[isUploading,setIsUploading]=(0,react.useState)(!1);var _options_allowExternalUrl;const allowExternalUrl=null!==(_options_allowExternalUrl=options.allowExternalUrl)&&void 0!==_options_allowExternalUrl?_options_allowExternalUrl:()=>!0,allowedMimePrefixes=(0,react.useMemo)(()=>{var _options_allowedMimePrefixes;return null!==(_options_allowedMimePrefixes=options.allowedMimePrefixes)&&void 0!==_options_allowedMimePrefixes?_options_allowedMimePrefixes:DEFAULT_PREFIXES},[options.allowedMimePrefixes]),maxBytes=Number.isFinite(options.maxBytes)?options.maxBytes:26214400;var _pendingFile_type_startsWith;const isVideo=null!==(_pendingFile_type_startsWith=null==pendingFile||null===(_pendingFile_type=pendingFile.type)||void 0===_pendingFile_type?void 0:_pendingFile_type.startsWith("video/"))&&void 0!==_pendingFile_type_startsWith&&_pendingFile_type_startsWith,{actual:rawActual,isValid:rawValid}=(0,useImageOrientationValidation.M)(isVideo?null:pendingFile,requiredOrientation),actual=isVideo?null:rawActual,isValid=!!isVideo||rawValid,handleUpload=(0,react.useCallback)(async()=>{if(uploadingRef.current)return;if(!pendingFile)return;if(!1===isValid)return void setError(actual?`Image orientation mismatch: expected ${requiredOrientation}, got ${actual}`:`Image orientation mismatch: expected ${requiredOrientation}`);uploadingRef.current=!0,setIsUploading(!0),(0,react_dom.flushSync)(()=>setProgress({done:0,total:1}));const{item,error}=await async function uploadToCms({shop,requiredOrientation,file,altText,tagsCsv}){const fd=new FormData;if(fd.append("file",file),altText&&fd.append("altText",altText),tagsCsv){const tagList=tagsCsv.split(",").map(t=>t.trim()).filter(Boolean);tagList.length&&fd.append("tags",JSON.stringify(tagList))}try{const res=await fetch(`/cms/api/media?shop=${shop}&orientation=${requiredOrientation}`,{method:"POST",body:fd}),data=await res.json();if(!res.ok)throw new Error(data.error||res.statusText);return{item:data}}catch(err){return err instanceof Error?{error:err.message}:{}}}({shop,requiredOrientation,file:pendingFile,altText,tagsCsv:tags});item?(null==onUploaded||onUploaded(item),setError(void 0)):error&&setError(error),(0,react_dom.flushSync)(()=>setProgress(null)),setPendingFile(null),setAltText(""),setTags(""),uploadingRef.current=!1,setIsUploading(!1)},[pendingFile,altText,tags,shop,requiredOrientation,onUploaded,actual,isValid]),onDrop=(0,react.useCallback)(e=>{var _e_dataTransfer_files,_e_dataTransfer_files_;e.preventDefault();const file=null!==(_e_dataTransfer_files_=null===(_e_dataTransfer_files=e.dataTransfer.files)||void 0===_e_dataTransfer_files?void 0:_e_dataTransfer_files[0])&&void 0!==_e_dataTransfer_files_?_e_dataTransfer_files_:null;if(!file)return;const policyError=validateFilePolicy(file,allowedMimePrefixes,maxBytes);policyError?setError(policyError):(setPendingFile(file),setAltText(""),setTags(""))},[allowedMimePrefixes,maxBytes]),onFileChange=(0,react.useCallback)(e=>{const file=function firstFileFromChange(e){var _e_target_files,_e_target_files_;return null!==(_e_target_files_=null===(_e_target_files=e.target.files)||void 0===_e_target_files?void 0:_e_target_files[0])&&void 0!==_e_target_files_?_e_target_files_:null}(e);if(!file)return;const policyError=validateFilePolicy(file,allowedMimePrefixes,maxBytes);policyError?setError(policyError):(setPendingFile(file),setAltText(""),setTags(""))},[allowedMimePrefixes,maxBytes]),openFileDialog=(0,react.useCallback)(()=>{var _inputRef_current;null===(_inputRef_current=inputRef.current)||void 0===_inputRef_current||_inputRef_current.click()},[]),uploader=(0,jsx_runtime.jsx)(UploaderSurface.A,{inputRef,pendingFile,progress,error,isValid,isVideo,requiredOrientation,onDrop,onFileChange,openFileDialog});return{pendingFile,altText,setAltText,tags,setTags,actual,isValid,progress,error,handleUpload,isUploading,inputRef,openFileDialog,onDrop,onFileChange,processDataTransfer:async e=>{try{var _dt_files;const dt=e.dataTransfer;if(!dt)return"none";var _dt_files_;const file=null!==(_dt_files_=null===(_dt_files=dt.files)||void 0===_dt_files?void 0:_dt_files[0])&&void 0!==_dt_files_?_dt_files_:null;if(file){const policyError=validateFilePolicy(file,allowedMimePrefixes,maxBytes);return policyError?(setError(policyError),"none"):(setPendingFile(file),setAltText(""),setTags(""),"file")}const url=dt.getData("text/uri-list");if(!url){const text=dt.getData("text/plain"),{file:ingestedFile,error,handled}=await ingestFromText(text,{allowedMimePrefixes,maxBytes,allowExternalUrl});return"text"===handled?"text":ingestedFile?(setPendingFile(ingestedFile),setAltText(""),setTags(""),"url"):(error&&setError(error),"none")}if(url){const ok=await(async url=>{setProgress({done:0,total:1});const{file,error}=await ingestExternalUrl(url,{allowedMimePrefixes,maxBytes,allowExternalUrl});return file?(setPendingFile(file),setAltText(""),setTags(""),setProgress(null),!0):(error&&setError(error),setProgress(null),!1)})(url);return ok?"url":"none"}return"none"}catch(e){return"none"}},uploader}}const hooks_useFileUpload=useFileUpload},"../../packages/ui/src/hooks/useImageOrientationValidation.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{M:()=>useImageOrientationValidation});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("../../node_modules/.pnpm/next@15.3.5_@babel+core@7.28.4_@opentelemetry+api@1.9.0_@playwright+test@1.53.2_babel-p_5f4009eaaa2f46513e879f269f75344a/node_modules/next/dist/compiled/react/index.js");function useImageOrientationValidation(file,required){const[actual,setActual]=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(null);(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(()=>{if(!file)return void setActual(null);const url=URL.createObjectURL(file),img=new Image;img.onload=()=>{const orientation=img.width>=img.height?"landscape":"portrait";setActual(orientation),URL.revokeObjectURL(url)},img.onerror=()=>{setActual(null),URL.revokeObjectURL(url)},img.src=url},[file]);return{actual,isValid:null===actual?null:actual===required}}}}]);