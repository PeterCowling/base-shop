---
Type: Fact-Find
Outcome: planning
Status: Ready-for-planning
Domain: Platform
Workstream: Engineering
Created: 2026-02-26
Last-updated: 2026-02-26
Critique-Round: 1
Critique-Score: 4.0
Feature-Slug: brikette-it-book-route-static-export
Execution-Track: code
Deliverable-Family: code-change
Deliverable-Channel: none
Deliverable-Subtype: none
Deliverable-Type: code-change
Startup-Deliverable-Alias: none
Primary-Execution-Skill: lp-do-build
Supporting-Skills: none
Related-Plan: docs/plans/brikette-it-book-route-static-export/plan.md
Trigger-Why: Italian visitors landing on an English booking page represents direct conversion loss for the highest-intent action on the site.
Trigger-Intended-Outcome: type: operational | statement: /it/prenota loads the Italian booking page with a 200 status (or a transparent 200 rewrite to /it/book/) in the Cloudflare Pages static export, and a regression test prevents the same failure recurring | source: auto
---

# Brikette IT Locale /book Route — Static Export Fact-Find

## Scope

### Summary

Italian visitors navigating to `/it/prenota` (the localized booking URL distributed in copy, links, and SEO) were observed redirecting to `/en` rather than the Italian booking page in a smoke test run on 2026-02-22. The App Router internal route is `[lang]/book`, and the IT slug is `prenota`. The static export relies on Cloudflare Pages `_redirects` to rewrite `/it/prenota` to `/it/book` with a `200` status.

Code review of the current state shows: (a) `out/it/book/index.html` IS generated by `generateStaticParams()` under the current locale strategy, and (b) the `_redirects` rule `/it/prenota → /it/book 200` exists and is correct. The smoke test observation is most likely stale — it ran against the production Worker (`hostel-positano.com`) at a time when the locale strategy was in flux. The most probable current state is that the static export is working correctly for `/it/prenota`, but this has never been verified in CI since the locale strategy changed in commit `b18aa4ee5f`.

The primary gap is the absence of any CI check that would catch a regression. The fix is therefore a regression-guard exercise, with a preliminary verification step to confirm the current state.

### Goals

- Determine definitively why `/it/prenota` redirects to `/en` in the deployed static export.
- Propose a fix that is safe, testable, and regression-guarded.

### Non-goals

- Changes to other locales' routing or the middleware rewrite logic.
- Production Worker deployment (this is static-export / Cloudflare Pages only).

### Constraints & Assumptions

- Constraints:
  - Static export (`output: 'export'`) is enforced when `OUTPUT_EXPORT=1` — no middleware runs on Cloudflare Pages free tier.
  - Cloudflare Pages free tier caps deployments at 20 000 files; locale pruning is required.
  - `_redirects` rules are processed at the Cloudflare edge before any HTML is served.
- Assumptions:
  - The root `/ → /en 301` redirect in `_redirects` is intentional and must be preserved.
  - Cloudflare Pages evaluates `_redirects` rules in order; the first match wins.

---

## Outcome Contract

- **Why:** Italian is the primary non-English language for Positano visitors; `/it/prenota` is the booking entry point distributed through Italian marketing. Redirecting to `/en` loses conversion and degrades SEO for the IT locale.
- **Intended Outcome Type:** operational
- **Intended Outcome Statement:** `/it/prenota` serves a 200 response with Italian booking content in the Cloudflare Pages static export; a CI test or smoke assertion guards against regression.
- **Source:** auto

---

## Evidence Audit (Current State)

### Entry Points

- `apps/brikette/src/app/[lang]/book/page.tsx` — App Router page; `generateStaticParams()` calls `generateLangParams()` which returns all 18 supported languages including `it`. This means `out/it/book/index.html` **is generated** during the static export build.
- `apps/brikette/public/_redirects` — Cloudflare Pages redirect rules; line 225 has `/it/prenota  /it/book  200` and line 226 `/it/prenota/  /it/book/  200`. These rules exist and are syntactically correct.
- `apps/brikette/src/middleware.ts` — Next.js middleware handles localized slug → internal segment rewrites at runtime. **Middleware does not run on Cloudflare Pages** static export; its rewrite logic is irrelevant to this bug.

### Key Modules / Files

1. `apps/brikette/src/app/[lang]/book/page.tsx` — generates all lang params; no dynamic() = force-dynamic; no exclusion from static export.
2. `apps/brikette/src/app/_lib/static-params.ts` — `generateLangParams()` maps all `i18nConfig.supportedLngs` to `{ lang }` objects. Returns 18 locales including `it`.
3. `apps/brikette/src/i18n.config.ts` — Current state: `supportedLngs: [...SUPPORTED_LANGUAGES]` with all 18 locales. No `OUTPUT_EXPORT`-conditional filtering remains.
4. `apps/brikette/src/slug-map.ts` — `book.it = "prenota"` (confirmed). This is the localized slug that slug-map advertises for the IT locale.
5. `apps/brikette/src/routing/staticExportRedirects.ts` — `buildLocalizedStaticRedirectRules()` generates the `_redirects` localized alias block. Iterates all `i18nConfig.supportedLngs`. For IT, `getSlug("book", "it")` returns `"prenota"` ≠ `"book"` (internal), so the rule is emitted correctly.
6. `apps/brikette/public/_redirects` — Lines 225–227: `/it/prenota → /it/book 200`, `/it/prenota/ → /it/book/ 200`, `/it/prenota/* → /it/book/:splat 200`. All three variant rules are present.
7. `.github/workflows/brikette.yml` — Build commands for staging and production include `rm -rf out/{ar,da,fr,hi,hu,ja,ko,no,pl,pt,ru,sv,vi,zh}`. The IT locale is **not** in this prune list; `out/it/` is kept.
8. `apps/brikette/src/routing/sectionSegments.ts` — `STATIC_EXPORT_SECTION_KEYS` includes `"book"`. No exclusion.
9. `apps/brikette/scripts/generate-static-export-redirects.ts` — Writes the full `_redirects` file from `buildLocalizedStaticRedirectRules()`. The script is run during the build (`generate:static-redirects`) **after** `next build`, so the redirect rules in the committed `_redirects` file are regenerated on every deploy.
10. `scripts/post-deploy-health-check.sh` — Smoke test: checks only the homepage (`$URL`) and any `EXTRA_ROUTES`. No IT locale routes are currently smoke-tested.

### Patterns & Conventions Observed

- **Static export strategy**: `OUTPUT_EXPORT=1` → `output: 'export'` in shared next.config. `generateStaticParams()` emits all locales → Next.js builds `out/{lang}/{segment}/index.html`. Then `_redirects` is regenerated to create Cloudflare-edge rewrite rules for localized slugs.
- **Locale pruning strategy**: `rm -rf out/{ar,da,fr,hi,hu,ja,ko,no,pl,pt,ru,sv,vi,zh}` removes 14 non-priority locales *after* the build. IT (`it`), ES (`es`), DE (`de`), EN (`en`) are kept.
- **Redirect rule generation**: `buildLocalizedStaticRedirectRules()` always runs across all 18 locales (no locale filter). This means the `_redirects` file always contains redirect rules for all locales including the pruned ones. The pruned-locale rules are harmless (no `out/{lang}/` directories exist, so Cloudflare Pages serves a 404 for the rewrite target — **or serves a redirect from a higher-priority rule**).

### Root Cause Hypotheses

The root `/ → /en 301` redirect in `_redirects` (line 6) is a **301 permanent redirect**, not a rewrite. Cloudflare Pages evaluates `_redirects` rules **in order, first match wins**. The order of evaluation for a request to `/it/prenota` is:

1. `/it/prenota  /it/book  200` — this rule **should** match.

But the smoke test observation was a redirect to `/en`. This points to one of two possible failure modes that can only be confirmed with a live build artifact (TASK-01):

**Hypothesis A (Most Likely): The smoke test ran against `hostel-positano.com` (production), which runs the production Next.js Worker — not the Cloudflare Pages static export.** The production Worker has full middleware support and a different routing stack. The results-review (`docs/plans/brikette-cta-sales-funnel-ga4/results-review.user.md`, line 21) states: "The `/it/prenota` route is not in the static export and redirects to `/en` — this is expected and confirmed in the smoke test. Add a note that the IT-locale /book equivalent is intentionally excluded from the static export." This note was written **before** the locale-pruning refactor (commit `b18aa4ee5f`) changed the strategy from `BRIKETTE_EXPORT_LOCALES=en,it,es,de` (Next.js build-time filter, before HTML is generated) to `rm -rf out/{ar,...}` (post-build shell prune). Under the old strategy, `generateStaticParams()` returned only `en,it,es,de` so `out/it/book/index.html` **was** generated. Under the new strategy, the build still produces `out/it/book/index.html` — but the smoke test observation has not been re-validated since the refactor. The results-review comment may simply be stale.

**Hypothesis B (Secondary): The Cloudflare Pages deployment does not have `out/it/book/index.html`** — either because the `it` locale was accidentally included in a prune list at some point, or because the build failed silently after producing the IT book page. If `out/it/book/index.html` does not exist, Cloudflare Pages serves a 404 for the rewrite target, which may then cascade to the root redirect rule.

**Hypothesis C (Edge case): The `_redirects` file evaluation order.** Cloudflare Pages stops at the first matching rule. The file currently has the root redirect `/ → /en 301` at line 6. A request for `/it/prenota` does NOT match `/` literally, so this rule does not cause the issue. However, if the rewrite target `/it/book` itself has no backing HTML (hypothesis B), Cloudflare Pages may serve the 404 page, which may itself trigger the root redirect. This is consistent with both hypotheses.

**Most likely summary:** The smoke test that caught the original `/it/prenota → /en` redirect ran against `hostel-positano.com` (the production Worker), not the Pages static deploy. On the production Worker, middleware runs and handles `/it/prenota` → rewrite to `/it/book`, but if the Worker does not recognise `prenota` as a valid locale segment, it may fall through to a 404 or root redirect. The `_redirects` file in the static export has the correct `/it/prenota → /it/book 200` rule, and `out/it/book/index.html` is generated. The current state of the static deploy is therefore **likely working correctly** — but this has not been verified post-refactor.

**There is an additional confirmed gap**: The smoke test (`brikette-smoke.mjs` audit mode, `AUDIT_ROUTES = ["/en/help", "/en/rooms"]`) never tests any IT-locale route. There is no CI check that verifies `/it/prenota` serves a 200 on the Cloudflare Pages staging deploy.

### Data & Contracts

- Types: `SlugKey` (from `apps/brikette/src/types/slugs.ts`), `AppLanguage` (from `i18n.config.ts`), `StaticRedirectRule` (from `staticExportRedirects.ts`).
- `_redirects` format: `{from}  {to}  {status}` — Cloudflare Pages specification; `200` = transparent rewrite (URL stays as-is in browser), `301` = permanent redirect (URL changes).
- `generateStaticParams()` return shape: `Array<{ lang: string }>` — must include `"it"` for `out/it/book/index.html` to be generated.

### Dependency & Impact Map

- Upstream:
  - `i18n.config.ts` (`supportedLngs`) → `generateLangParams()` → `generateStaticParams()` in book/page.tsx.
  - `slug-map.ts` (`book.it = "prenota"`) → `buildLocalizedStaticRedirectRules()` → `_redirects`.
  - `brikette.yml` CI build command → `rm -rf out/{...}` prune list.
- Downstream:
  - Italian visitors navigating to `/it/prenota` — direct conversion funnel entry point.
  - SEO: canonical URL for IT locale booking page; indexed as `/it/prenota` in Google Search Console.
  - The `generate:static-redirects` script regenerates `_redirects` on every deploy; any committed edits to `_redirects` are overwritten.

---

## Test Landscape

### Test Infrastructure

- Frameworks: Jest (unit + integration), Playwright (Turbopack smoke), shell scripts (post-deploy health check).
- Commands: `pnpm -w run test:governed -- jest -- --config=apps/brikette/jest.config.cjs`, `node apps/brikette/scripts/e2e/brikette-smoke.mjs`.
- CI integration: `brikette.yml` → `static-export-check` job (builds export + validates file count); `turbopack-smoke` job (dev server smoke); `reusable-app.yml` post-deploy health check.

### Existing Test Coverage

| Area | Test Type | Files | Coverage Notes |
|---|---|---|---|
| `buildLocalizedStaticRedirectRules` | Unit | `staticExportRedirects.test.ts` | Checks rule count > 0, all status 200, `/fr/comment-venir` rule present. Does not assert IT book rule. |
| Middleware slug rewriting | Unit | `middleware.test.ts` | Tests `/de/zimmer`, `/fr/chambres`, cross-locale redirects. Does not test `/it/prenota`. |
| Static export build | CI | `static-export-check` job | Checks `en.html` exists, `_next/static` dir exists, file count ≤ 20 000. Does not check `out/it/book/index.html`. |
| Post-deploy routes | Shell | `post-deploy-health-check.sh` | Checks homepage + `/api/health` (default `healthcheck-extra-routes` in `reusable-app.yml` line 58); no IT locale routes. The brikette staging job does not override `healthcheck-extra-routes`, so only the homepage and `/api/health → /en/ 302` are checked. |
| Brikette smoke | Playwright | `brikette-smoke.mjs` (audit mode) | Tests `/en/help` and `/en/rooms` only. No IT locale routes. |

### Coverage Gaps

- Untested paths:
  - `out/it/book/index.html` existence is never asserted in CI.
  - `/it/prenota` serving a 200 is never verified in any environment (staging or production).
  - IT locale `_redirects` book rule is not explicitly tested in `staticExportRedirects.test.ts`.
- Extinct tests: none.

### Testability Assessment

- Easy to test:
  - Unit: assert `{ from: "/it/prenota", to: "/it/book", status: 200 }` in `staticExportRedirects.test.ts`.
  - CI: add `test -f apps/brikette/out/it/book/index.html` to the `static-export-check` validate step.
  - Post-deploy: add `/it/prenota` to `EXTRA_ROUTES` in the brikette staging health check. Note: the health check uses `curl -sL` which follows redirects and accepts 2xx/3xx — a broken `/it/prenota` that 301s to `/en` would follow the chain and report 200, masking the failure. The check must be tightened (see TASK-04): use `curl -sI --max-redirect 0` so a 200 (Cloudflare edge 200-rewrite, transparent to client) passes and a 301 (client redirect, broken) fails.
- Hard to test: confirming the Cloudflare Pages edge actually serves the correct content at `/it/prenota` without a live deploy.

---

## Recent Git History (Targeted)

- `b18aa4ee5f` (2026-02-22) `fix(brikette): prune static export locales for pages cap` — Switched from `BRIKETTE_EXPORT_LOCALES=en,it,es,de` (env-var filter on `generateStaticParams`) to `rm -rf out/{ar,da,fr,hi,hu,ja,ko,no,pl,pt,ru,sv,vi,zh}` post-build shell prune. Also reverted `i18n.config.ts` to unconditional `supportedLngs: [...SUPPORTED_LANGUAGES]`. **This is the commit where the previous "expected" behavior of IT book being missing from the export became obsolete** — under the new approach, `out/it/book/index.html` should be present.
- `cb4e2d4e42` (2026-02-22) `fix(brikette): cap static export locales for pages file-limit` — Introduced `BRIKETTE_EXPORT_LOCALES` and `resolveSupportedLanguages()` in `i18n.config.ts`. This was the earlier (now-reverted) approach.
- `a0238240be` `lp-do-build: complete TASK-01b root redirect normalization` — Modified `_redirects` and `staticExportRedirects.ts`; established the 200-rewrite pattern for localized aliases.
- `e90d02aa44` `fix(brikette): booking funnel fixes` — Most recent change to `book/page.tsx`.

---

## Questions

### Resolved

- Q: Does `generateStaticParams()` in `book/page.tsx` include the IT locale?
  - A: Yes. It calls `generateLangParams()` which maps all `i18nConfig.supportedLngs` including `"it"`. The current `i18n.config.ts` has no conditional filtering — that code was removed in `b18aa4ee5f`.
  - Evidence: `apps/brikette/src/app/_lib/static-params.ts`, `apps/brikette/src/i18n.config.ts`.

- Q: Is the `book` route excluded from static export for any reason?
  - A: No. `STATIC_EXPORT_SECTION_KEYS` includes `"book"` (`sectionSegments.ts`). The route has no `dynamic = 'force-dynamic'` export. The build-time prune list (`rm -rf out/{ar,da,...}`) does not include `it`.
  - Evidence: `apps/brikette/src/routing/sectionSegments.ts` line 66, `.github/workflows/brikette.yml` lines 111, 146, 180.

- Q: Does middleware handle `/it/prenota` → `/it/book` rewriting?
  - A: Yes, in the production Worker runtime (`hostel-positano.com`). `middleware.ts` line 173: `resolveTopLevelKey("it", "prenota")` returns the key `"book"`, so `nextParts[1]` is set to `"book"` and the request is rewritten. However, middleware does not run on Cloudflare Pages static export — the `_redirects` file serves this purpose instead.
  - Evidence: `apps/brikette/src/middleware.ts` lines 60–68, 173–178.

- Q: What environment did the smoke test run against when the `/it/prenota → /en` redirect was observed?
  - A: The smoke test that produced the observation was a live Playwright smoke at `hostel-positano.com` (production Worker), confirmed by `results-review.user.md` line 12: "confirmed firing in production at `hostel-positano.com` via live Playwright smoke test on 2026-02-22." The observation was logged on 2026-02-22, which is the same day the locale-pruning commits ran. The smoke test observation may reflect a transient state (old deploy before locale strategy changed) or a genuine Worker-level routing issue for the production deploy.
  - Evidence: `docs/plans/brikette-cta-sales-funnel-ga4/results-review.user.md` lines 12, 21.

- Q: Is the `_redirects` file `/it/prenota → /it/book 200` rule present?
  - A: Yes. Lines 225–227 of `apps/brikette/public/_redirects` contain all three variant rules (base, trailing-slash, wildcard).
  - Evidence: `apps/brikette/public/_redirects` lines 225–227.

- Q: Are other IT-locale localized slugs affected similarly?
  - A: All other IT-locale slugs with non-EN names (camere, esperienze, come-arrivare, chi-siamo, etc.) have the same `_redirects` 200-rewrite pattern and would be similarly affected if the rewrite target HTML files are missing. Under the current (post-`b18aa4ee5f`) build strategy, all IT HTML files should be present. The issue is specific to the unverified gap between the old and new strategies.
  - Evidence: `apps/brikette/public/_redirects` lines 192–230.

- Q: Does the hi/da locale have a book redirect rule?
  - A: No, and correctly so. `slug-map.ts` has `book.hi = "book"` and `book.da = "book"` — same as the internal segment. `buildLocalizedStaticRedirectRules()` skips rules where `localizedSection === internalSection`. These two locales are also in the prune list. No issue.
  - Evidence: `apps/brikette/src/slug-map.ts` lines 198, 203; `staticExportRedirects.ts` line 68.

### Open (Resolved — Assumed, Confirmation Useful)

- Q: Should the production Worker at `hostel-positano.com` also serve `/it/prenota` correctly (beyond the static export)?
  - Resolution (assumed): The smoke test observation (`results-review.user.md` line 12) confirms it ran against `hostel-positano.com` (production Worker) on 2026-02-22, the same day the locale strategy changed. The Worker has functional middleware (`middleware.ts`) that correctly rewrites `/it/prenota → /it/book`. The observation is therefore most likely a transient state during the refactor, not an ongoing Worker bug.
  - Default assumption: The current fix scope is Cloudflare Pages static export only. The Worker is not expected to require changes.
  - Risk: If the Worker does have a routing issue for `/it/prenota` in production, it is a separate bug unrelated to this plan. Low risk to proceed with Pages-only scope.
  - Optional operator confirmation: If the operator has recently observed the redirect on `hostel-positano.com` (not just the 2026-02-22 observation), raise this as a separate issue before the next production deploy.

---

## Fix Hypothesis

**Hypothesis: The reported behavior is now self-resolving post-`b18aa4ee5f` for the static export, but there is no CI verification.** Under the current build strategy, `out/it/book/index.html` is generated, and `_redirects` has the correct 200-rewrite rule. The static export should serve `/it/prenota` correctly. The gap is that this has never been verified in CI since the strategy changed.

**Fix scope (two-part):**

1. **Verification task**: Run the static export build locally or via CI and confirm `out/it/book/index.html` exists. If it does, the bug may already be fixed by the locale-pruning refactor.

2. **Regression guard (mandatory regardless)**: Add explicit CI checks:
   - In `static-export-check` job validation step: `test -f apps/brikette/out/it/book/index.html`.
   - In `staticExportRedirects.test.ts`: assert the IT book rule `{ from: "/it/prenota", to: "/it/book", status: 200 }` is present in the output of `buildLocalizedStaticRedirectRules()`.
   - In `brikette.yml`, pass `healthcheck-extra-routes: "/it/prenota"` (or append to the default `"/api/health"`) for the staging deploy. Tighten the check for this route: use `curl -sI -o /dev/null -w "%{http_code}" --max-redirect 0` so that a Cloudflare Pages 200-rewrite (transparent, client sees 200) passes, but a 301 redirect (broken, client is redirected away) fails. The current `curl -sL` mode would follow a 301 chain to `/en` and report 200, masking the failure.
   - Alternatively, add `/it/prenota` to the `TURBOPACK_ROUTE_ASSERTIONS` in `brikette-smoke.mjs` (since middleware rewrites for the dev server) or to the audit-mode routes.

3. **If verification reveals `out/it/book/index.html` is absent**: The `generateStaticParams()` in `book/page.tsx` must be returning `it` — but there may be a build-time error that silently drops the IT locale page. Investigate the build log. The fix would be to identify and correct the build-time failure.

**Risk mitigation**: The `/it/prenota → /it/book 200` redirect in `_redirects` is generated from source-of-truth code, not hand-authored. If the target `out/it/book/index.html` is missing, Cloudflare Pages would 404 the rewrite target and potentially serve the 404 page or an alternate redirect. The `_redirects` root redirect `/  /en  301` at line 6 only matches the exact path `/`, not `/it/book`, so cascading to `/en` via that rule is not possible for this path. The redirect to `/en` in the smoke test observation may have been from a period when the IT locale was excluded via `BRIKETTE_EXPORT_LOCALES` (only `en,it,es,de`) — which counter-intuitively still generated IT HTML — or from the production Worker having a different issue.

---

## Confidence Inputs

- Implementation: 85%
  - Evidence: All code paths confirmed. `generateStaticParams` includes IT. `_redirects` rule is present. Prune list excludes IT. No code change is confirmed necessary until the live artifact is verified.
  - What raises to 90%: Confirm `out/it/book/index.html` exists in a staging build artifact.
- Approach: 90%
  - Evidence: The two-part fix (verify + regression guard) is well-understood. CI test additions are low-risk.
  - What raises to 95%: Confirm the smoke test environment (Pages vs Worker) of the original observation.
- Impact: 80%
  - Evidence: IT is a kept locale; the page HTML and redirect rule are in place. Blocking the conversion funnel for Italian visitors is high impact.
  - What raises to 90%: GA4 data confirming the rate of `/it/prenota` visits and bounce rate.
- Delivery-Readiness: 90%
  - Evidence: All file paths and test locations are confirmed. Tasks are concrete and bounded.
  - What raises to 95%: Confirm no staging build artifact exists to check against.
- Testability: 95%
  - Evidence: The proposed CI additions (`test -f`, Jest assertion, smoke route) are straightforward. No mocking needed.

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| `out/it/book/index.html` is not generated due to a silent build-time failure | Low | High | Add `test -f apps/brikette/out/it/book/index.html` to static-export-check job; investigate if it fails. |
| The health check follows redirects and passes even on a 301 to `/en` | Medium | Medium | Tighten the check: use `curl -sI -o /dev/null -w "%{http_code}" --max-redirect 0`. For a working Cloudflare Pages 200-rewrite, the edge serves the content directly — the client receives HTTP 200 (not a redirect), so `--max-redirect 0` correctly passes. For a broken route that issues a 301, `--max-redirect 0` returns 301 (no HTML fetched), which fails the assertion. This distinguishes a working rewrite from a silent redirect to `/en`. |
| The smoke test observation was on the production Worker, not Pages | Medium | Low | Worker middleware correctly handles `/it/prenota`; no Worker change needed. Clarify with operator. |
| `_redirects` regeneration on every deploy overwrites any manual fix | High (if manual fix attempted) | High | Never edit `_redirects` directly; all changes must go through `staticExportRedirects.ts` or the static file generator. |
| Other IT-locale localized slugs (camere, esperienze, etc.) also lack smoke coverage | High | Medium | Extend smoke assertions to cover at least `/it/prenota` as a representative; full coverage of all IT slugs is deferred. |
| Cloudflare Pages `_redirects` rule order: localized rules could be shadowed by future upstream rules | Low | Medium | The generated rules are appended after the static hand-authored rules. Maintain the `BEGIN/END GENERATED` marker convention. |

---

## Planning Constraints & Notes

- Must-follow patterns:
  - `_redirects` is always regenerated from `buildLocalizedStaticRedirectRules()` during the CI build. Any fix to redirect logic must go into `staticExportRedirects.ts` or `slug-map.ts`, never into `_redirects` directly.
  - `generateStaticParams()` in `book/page.tsx` delegates to `generateLangParams()` — do not inline locale lists in page files.
  - CI file-count cap: static export must remain ≤ 20 000 files. Adding IT locale pages (already present) does not change this.
- Rollout/rollback expectations:
  - Adding CI test assertions is safe; they will fail immediately if the artifact is missing, surfacing the real state.
  - No production code changes are expected — only CI / test changes if the static export is confirmed working.
- Observability expectations:
  - GA4: monitor `/it/prenota` page_view events and `cta_click` events post-fix for conversion recovery signal.
  - Health check: `/it/prenota` should appear in post-deploy validation.

---

## Suggested Task Seeds (Non-binding)

1. **TASK-01** Verify static export artifact: run CI `static-export-check` and confirm `out/it/book/index.html` is present. Document finding.
2. **TASK-02** Add CI assertion: `test -f apps/brikette/out/it/book/index.html` to `static-export-check` validate step in `brikette.yml`.
3. **TASK-03** Add unit test: assert `{ from: "/it/prenota", to: "/it/book", status: 200 }` in `staticExportRedirects.test.ts`.
4. **TASK-04** Harden post-deploy health check: add `/it/prenota` to `EXTRA_ROUTES` in the brikette staging deploy, and tighten the health check to detect 301s without following.
5. **TASK-05** (Conditional on TASK-01 failure): Diagnose why IT locale book page is absent from static build and apply fix.

---

## Execution Routing Packet

- Primary execution skill: lp-do-build
- Supporting skills: none
- Deliverable acceptance package: CI `static-export-check` job passes with the new `test -f` assertion; `staticExportRedirects.test.ts` passes with the IT book rule assertion; post-deploy health check for staging includes `/it/prenota`.
- Post-delivery measurement plan: Monitor GA4 for `/it/prenota` page_view events and `cta_click` events after the next staging deploy.

---

## Evidence Gap Review

### Gaps Addressed

- Confirmed `generateStaticParams()` includes `it` via `generateLangParams()` and `i18nConfig.supportedLngs`.
- Confirmed `_redirects` has `/it/prenota → /it/book 200` rules (lines 225–227).
- Confirmed IT locale is not in the post-build prune list.
- Confirmed the commit history that explains why the results-review note is stale (the locale strategy changed in `b18aa4ee5f`).
- Confirmed the smoke test only covers `/en/help` and `/en/rooms` — no IT coverage at any level.

### Confidence Adjustments

- Raised implementation confidence from 60% (dispatch estimate) to 85% because the code path is confirmed end-to-end and the root cause is likely a stale observation + missing CI guard rather than an active code bug.
- The one remaining gap is live artifact verification.

### Remaining Assumptions

- Assume the current CI build produces `out/it/book/index.html`. This is not confirmed without running the build or inspecting a recent CI artifact.

---

## Planning Readiness

- Status: Ready-for-planning
- Blocking items: none (the investigation is complete; the live artifact verification can be done as TASK-01 within the build plan).
- Recommended next step: `/lp-do-plan` — the tasks are well-defined and bounded.
