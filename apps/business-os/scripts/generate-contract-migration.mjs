import { readFileSync, writeFileSync } from "node:fs";
import { fileURLToPath } from "node:url";
import path from "node:path";

import matter from "gray-matter";

function main() {
  const here = path.dirname(fileURLToPath(import.meta.url));
  const repoRoot = path.resolve(here, "../../..");

  const sourcePath = path.join(
    repoRoot,
    "docs/business-os/startup-loop/contract-migration.yaml"
  );
  const outPath = path.join(
    repoRoot,
    "apps/business-os/src/lib/contract-migration.generated.ts"
  );

  const raw = readFileSync(sourcePath, "utf8");
  const parsed = matter(raw);

  if (!parsed.data || typeof parsed.data !== "object") {
    throw new Error(
      "contract-migration.yaml front matter parsed to empty object; expected YAML data"
    );
  }

  const header = `/*\n * AUTO-GENERATED by apps/business-os/scripts/generate-contract-migration.mjs\n * Source: ${path
    .relative(repoRoot, sourcePath)
    .replace(/\\\\/g, "/")}\n *\n * Do not edit this file directly. Edit the YAML source and re-run the generator.\n */\n\n`;

  const body =
    "export const CONTRACT_MIGRATION_CONFIG = " +
    JSON.stringify(parsed.data, null, 2) +
    " as const;\n";

  const next = header + body;

  // Avoid churn if no meaningful changes.
  let prev = "";
  try {
    prev = readFileSync(outPath, "utf8");
  } catch {
    // ok
  }

  if (prev !== next) {
    writeFileSync(outPath, next, "utf8");
  }
}

main();
