name: Core Platform CI

on:
  push:
    paths-ignore:
      - 'apps/skylar/**'
      - 'apps/cms/**'
      - '.github/workflows/skylar.yml'
      - '.github/workflows/cms.yml'
  pull_request:
    paths-ignore:
      - 'apps/skylar/**'
      - 'apps/cms/**'
      - '.github/workflows/skylar.yml'
      - '.github/workflows/cms.yml'

concurrency:
  group: core-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      shop: ${{ steps.filter.outputs.shop }}
      docs: ${{ steps.filter.outputs.docs }}
      plans: ${{ steps.filter.outputs.plans }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect E2E-impacting changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            shop:
              - 'apps/cover-me-pretty/**'
              - 'apps/cms/**'
              - 'packages/platform-core/**'
              - 'packages/ui/**'
              - 'packages/config/**'
              - 'packages/i18n/**'
              - 'packages/shared-utils/**'
            docs:
              - 'docs/**'
            plans:
              - 'docs/plans/**'

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Audit dependencies
        run: |
          echo "::group::Running pnpm audit"
          pnpm audit --audit-level=high --ignore GHSA-p6mc-m468-83gw
          echo "::endgroup::"

  dep-alignment:
    name: Dependency Alignment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Check dependency version alignment
        run: node scripts/check-dep-alignment.mjs

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Check dependency licenses
        run: node scripts/check-licenses.mjs

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Restore Tailwind color report cache
        uses: actions/cache@v4
        with:
          path: tools/eslint-baselines/ds-no-raw-tailwind-color.report.json
          key: tailwind-color-report-${{ github.sha }}
          restore-keys: |
            tailwind-color-report-${{ github.ref_name }}-
            tailwind-color-report-
      - name: Lint (standard)
        run: pnpm lint
      - name: Lint (raw Tailwind color baseline)
        run: pnpm run lint:no-raw-tailwind-color:check
        timeout-minutes: 5
        env:
          LINT_TIMEOUT_MS: 240000
      - name: Lint (exceptions governance)
        run: pnpm run lint:exceptions
      - name: Docs lint
        if: needs.changes.outputs.docs == 'true'
        run: pnpm run docs:lint
      - name: Plans lint
        if: needs.changes.outputs.plans == 'true'
        run: pnpm run plans:lint
      - name: Template lint (email)
        run: pnpm --filter @acme/mcp-server lint:templates
      - name: Agent manifest validation
        run: node scripts/validate-agent-manifest.js
      - name: Token validation
        run: pnpm validate:tokens
      - name: Token drift report
        run: pnpm tokens:drift
      - name: Token drift check
        run: pnpm tokens:drift:check
      - name: Token contrast validation
        run: pnpm tokens:contrast:check

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Typecheck
        run: pnpm typecheck

  test:
    name: Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Runtime contract manifest tests
        run: |
          pnpm --filter @acme/template-app test -- --testPathPattern runtimeContractManifest.test.ts
          pnpm --filter @apps/cover-me-pretty test -- --testPathPattern runtimeContractManifest.test.ts
      - name: Unit tests
        run: pnpm test:affected
      - uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info


  bos-mirror-guard:
    name: Business OS Mirror Guard
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect Business OS doc changes
        id: bos_filter
        uses: dorny/paths-filter@v3
        with:
          predicate-quantifier: 'every'
          filters: |
            bos_guarded:
              - 'docs/business-os/**'
              - '!docs/business-os/README.md'
              - '!docs/business-os/business-os-charter.md'
              - '!docs/business-os/MANUAL_EDITS.md'
              - '!docs/business-os/scans/**'
              - '!docs/business-os/strategy/**'
              - '!docs/business-os/people/**'
      - name: Validate BOS mirror edits
        if: steps.bos_filter.outputs.bos_guarded == 'true'
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_BRANCH: ${{ github.head_ref }}
          PR_ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ "${PR_BRANCH}" != bos-export/* ]]; then
            echo "Business OS data is managed in D1. Use the UI or API. Manual edits to docs/business-os/ are not allowed."
            echo "Expected PR branch to start with bos-export/."
            exit 1
          fi

          if [[ "${PR_ACTOR}" != "github-actions[bot]" ]]; then
            echo "Business OS data is managed in D1. Use the UI or API. Manual edits to docs/business-os/ are not allowed."
            echo "Expected PR actor github-actions[bot], got ${PR_ACTOR}."
            exit 1
          fi

          if [[ -z "${PR_BODY:-}" ]]; then
            echo "Business OS data is managed in D1. Use the UI or API. Manual edits to docs/business-os/ are not allowed."
            echo "PR body missing Export-Run-ID marker."
            exit 1
          fi

          RUN_ID=$(echo "${PR_BODY}" | sed -n 's/^Export-Run-ID:[[:space:]]*//p' | head -n 1)
          if [[ -z "${RUN_ID}" ]]; then
            echo "Business OS data is managed in D1. Use the UI or API. Manual edits to docs/business-os/ are not allowed."
            echo "PR body missing Export-Run-ID marker."
            exit 1
          fi

          gh api "/repos/${REPO}/actions/runs/${RUN_ID}" > /tmp/bos-run.json
          STATUS=$(jq -r '.status' /tmp/bos-run.json)
          CONCLUSION=$(jq -r '.conclusion' /tmp/bos-run.json)

          if [[ "${STATUS}" != "completed" || "${CONCLUSION}" != "success" ]]; then
            echo "Business OS data is managed in D1. Use the UI or API. Manual edits to docs/business-os/ are not allowed."
            echo "Export run ${RUN_ID} is not completed successfully (status=${STATUS}, conclusion=${CONCLUSION})."
            exit 1
          fi
  storybook-visual:
    name: Storybook Visual Regression
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Install Playwright browser
        run: pnpm exec playwright install chromium
      - name: Visual regression (themes/modes)
        run: pnpm run storybook:visual

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, typecheck, test, storybook-visual]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_DATABASE_URL: ${{ secrets.NEXT_PUBLIC_FIREBASE_DATABASE_URL }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
          NEXTAUTH_SECRET: build-nextauth-secret-32-chars-long-string!
        run: pnpm build

  e2e:
    name: E2E (shop subset)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [changes, build]
    if: needs.changes.outputs.shop == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: E2E (shop subset)
        run: pnpm e2e:shop

  release:
    name: Release to staging
    needs: [build, e2e]
    # Run release even if e2e was skipped (no shop changes)
    if: always() && github.ref_name == 'main' && needs.build.result == 'success' && (needs.e2e.result == 'success' || needs.e2e.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      # ADMIN-04: Decrypt SOPS secrets before build
      - name: Decrypt secrets
        uses: ./.github/actions/decrypt-secrets
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}
          require-key: true
          require-any: true
          environment: production

      # ADMIN-05: Validate environment before deploy
      - name: Validate deploy environment
        run: |
          chmod +x scripts/validate-deploy-env.sh
          ./scripts/validate-deploy-env.sh
        shell: bash

      - name: Build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_DATABASE_URL: ${{ secrets.NEXT_PUBLIC_FIREBASE_DATABASE_URL }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
          NEXTAUTH_SECRET: build-nextauth-secret-32-chars-long-string!
        run: pnpm build
      - name: Deploy to staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: pnpm exec next-on-pages deploy --project-name base-shop --branch staging
      - name: Post-Deploy Health Check
        if: success()
        run: |
          chmod +x scripts/post-deploy-health-check.sh
          ./scripts/post-deploy-health-check.sh base-shop --staging
        shell: bash
        env:
          EXTRA_ROUTES: "/api/health"
          MAX_RETRIES: "10"
          RETRY_DELAY: "6"
