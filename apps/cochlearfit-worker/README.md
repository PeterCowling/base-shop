# CochlearFit Worker

Cloudflare Worker that powers CochlearFit checkout APIs.

## Catalog Source Of Truth

The Worker catalog is generated at build time from shop data files:

- `data/shops/cochlearfit/products.json`
- `data/shops/cochlearfit/variants.json`
- `data/shops/cochlearfit/inventory.json`

The generated output is:

- `apps/cochlearfit-worker/src/worker-catalog.generated.ts`

This file is generated by `scripts/bundle-worker-catalog.ts` and is intentionally ignored by git.

## Build Pipeline

The Worker package runs the catalog bundler automatically before key commands:

- `pnpm --filter @apps/cochlearfit-worker dev`
- `pnpm --filter @apps/cochlearfit-worker typecheck`
- `pnpm --filter @apps/cochlearfit-worker lint`
- `pnpm --filter @apps/cochlearfit-worker build`

You can also run the bundler directly from the repo root:

```bash
node --import tsx scripts/bundle-worker-catalog.ts
```

Optional args:

```bash
node --import tsx scripts/bundle-worker-catalog.ts --data-dir data/shops/cochlearfit --out apps/cochlearfit-worker/src/worker-catalog.generated.ts
```

## Validation Rules

The bundler fails fast when:

- any required JSON file is missing
- a file is not a JSON array
- a variant references an unknown `productSlug`
- a `stripePriceId` is missing or does not start with `price_`

Note: placeholder `price_...` IDs are format-valid but must be replaced with real Stripe Price IDs before launch.

## Updating The Catalog

1. Edit the `data/shops/cochlearfit/*.json` files.
2. Run `pnpm --filter @apps/cochlearfit-worker build`.
3. Confirm `apps/cochlearfit-worker/src/worker-catalog.generated.ts` was regenerated.

