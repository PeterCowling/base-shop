#!/usr/bin/env bash
set -euo pipefail

# Agent safety wrapper for turbo.
# Blocks unscoped `turbo run test` fan-out by default.

wrapper_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
real_turbo=""
real_pnpm=""

IFS=":" read -r -a path_entries <<< "${PATH:-}"
for dir in "${path_entries[@]}"; do
  [[ -z "$dir" ]] && continue
  if [[ "$(cd "$dir" 2>/dev/null && pwd)" == "$wrapper_dir" ]]; then
    continue
  fi
  if [[ -z "$real_turbo" && -x "${dir}/turbo" ]]; then
    real_turbo="${dir}/turbo"
  fi
  if [[ -z "$real_pnpm" && -x "${dir}/pnpm" ]]; then
    real_pnpm="${dir}/pnpm"
  fi
  if [[ -n "$real_turbo" && -n "$real_pnpm" ]]; then
    break
  fi
done

if [[ -z "$real_turbo" && -z "$real_pnpm" ]]; then
  echo "ERROR: unable to locate real turbo or pnpm binary on PATH" >&2
  exit 127
fi

run_real_turbo() {
  if [[ -n "$real_turbo" ]]; then
    exec "$real_turbo" "$@"
  fi
  exec "$real_pnpm" exec turbo "$@"
}

if [[ "${BASESHOP_ALLOW_BROAD_TESTS:-}" == "1" ]]; then
  run_real_turbo "$@"
fi

has_scope="0"
is_run_test="0"

for ((i=1; i<=$#; i++)); do
  arg="${!i}"
  case "$arg" in
    --affected|--filter|--filter=*|--only)
      has_scope="1"
      ;;
  esac
  if [[ "$arg" == "run" ]]; then
    next_i=$((i+1))
    if [[ $next_i -le $# ]]; then
      next_arg="${!next_i}"
      if [[ "$next_arg" == "test" ]]; then
        is_run_test="1"
      fi
    fi
  fi
done

if [[ "$is_run_test" == "1" && "$has_scope" == "0" ]]; then
  echo "------------------------------------------------------------------" >&2
  echo "BLOCKED: turbo command guard" >&2
  echo "------------------------------------------------------------------" >&2
  echo "" >&2
  echo "Reason: Unscoped 'turbo run test' can fan out across many packages." >&2
  echo "" >&2
  echo "Safer alternatives:" >&2
  echo "  - turbo run test --affected" >&2
  echo "  - turbo run test --filter=./apps/cms" >&2
  echo "  - BASESHOP_ALLOW_BROAD_TESTS=1 turbo run test" >&2
  echo "" >&2
  exit 1
fi

run_real_turbo "$@"
