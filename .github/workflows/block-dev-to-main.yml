name: Release Flow Guard

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - reopened
      - synchronize

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: release-flow-guard-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  block-dev-to-main:
    if: ${{ github.event.pull_request.head.ref == 'dev' && github.event.pull_request.base.ref == 'main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Close disallowed PR shape
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const body = [
              "Closing automatically: `dev -> main` is blocked for this repository.",
              "",
              "Use the release flow:",
              "- `dev -> staging`",
              "- `staging -> main`",
              "",
              "Helper scripts:",
              "- `scripts/git/ship-to-staging.sh`",
              "- `scripts/git/promote-to-main.sh`",
            ].join("\\n");

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body,
            });

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr.number,
              state: "closed",
            });

            core.setFailed("Blocked disallowed release path: dev -> main.");
