name: Auto PR (Zero-Touch)

on:
  push:
    branches:
      - "work/**"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  ensure-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Guard (work/** only)
        if: ${{ !startsWith(github.ref, 'refs/heads/work/') }}
        run: |
          echo "::error::This workflow is only valid for branches under refs/heads/work/**." >&2
          echo "Select a work/** branch, or push to a work/** branch to trigger automatically." >&2
          exit 1
      - name: Ensure PR exists
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = process.env.GITHUB_REF_NAME;
            const head = `${owner}:${branch}`;
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head,
              base: "main",
              per_page: 1,
            });
            let pr = pulls[0];
            if (!pr) {
              const title = `Auto PR: ${branch}`;
              const body = [
                "Zero-touch PR created automatically.",
                "",
                "- Auto-merge is enabled when checks pass.",
                "- PRs auto-close on failing checks or staleness.",
              ].join("\n");
              const created = await github.rest.pulls.create({
                owner,
                repo,
                head: branch,
                base: "main",
                title,
                body,
              });
              pr = created.data;
            }
            core.setOutput("number", String(pr.number));
      - name: Ensure zero-touch label
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number(process.env.PR_NUMBER);
            const labels = [
              {
                name: "zero-touch",
                color: "0e8a16",
                description: "Agent-managed PRs: auto-merge + auto-close policies",
              },
              {
                name: "keep-open",
                color: "d4c5f9",
                description: "Prevent auto-close for zero-touch PRs",
              },
            ];
            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({ owner, repo, ...label });
              } catch (error) {
                if (error.status !== 422) {
                  throw error;
                }
              }
            }
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: number,
              labels: ["zero-touch"],
            });
      - name: Enable auto-merge (best effort)
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number(process.env.PR_NUMBER);
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: number,
            });
            try {
              await github.graphql(
                `
                  mutation EnableAutoMerge($pullRequestId: ID!) {
                    enablePullRequestAutoMerge(
                      input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }
                    ) {
                      pullRequest {
                        number
                      }
                    }
                  }
                `,
                { pullRequestId: pr.node_id }
              );
            } catch (error) {
              core.warning(`Auto-merge not enabled: ${error.message}`);
            }
