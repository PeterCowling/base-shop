generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Shop {
  id    String @id
  /// @type {import("../../types/src/Shop").Shop}
  data  Json
  pages Page[]
  sections SectionTemplate[]
}

model Page {
  id     String @id @default(cuid())
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId String
  slug   String
  data   Json
}

/// Reusable Sections (templates) curated per shop and inserted into pages
model SectionTemplate {
  id        String @id @default(cuid())
  shop      Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  shopId    String
  label     String
  status    String // "draft" | "published"
  tags      Json?
  thumbnail String?
  data      Json

  @@index([shopId])
  @@index([shopId, status])
}

model RentalOrder {
  id                 String   @id
  shop               String
  sessionId          String
  deposit            Int
  expectedReturnDate String?
  startedAt          String
  returnedAt         String?
  refundedAt         String?
  damageFee          Int?
  customerId         String?
  riskLevel          String?
  riskScore          Int?
  flaggedForReview   Boolean? @default(false)
  trackingNumber     String?
  labelUrl           String?
  returnStatus       String?
  returnDueDate      String?
  returnReceivedAt   String?
  lateFeeCharged     Int?
  fulfilledAt        String?
  shippedAt          String?
  deliveredAt        String?
  cancelledAt        String?
  refundTotal        Int?
  status             String?
  currency           String?
  subtotalAmount     Int?
  taxAmount          Int?
  shippingAmount     Int?
  discountAmount     Int?
  totalAmount        Int?
  cartId             String?
  stripePaymentIntentId       String?
  stripeChargeId              String?
  stripeBalanceTransactionId  String?
  stripeCustomerId            String?

  /// CAT-01: Line items for this order with inventory allocation tracking.
  /// JSON array of OrderLineItem: { sku, productId?, variantAttributes, quantity, previousQuantity?, nextQuantity? }
  lineItems          Json?

  @@unique([shop, sessionId])
  @@unique([shop, trackingNumber])
  @@index([customerId])
}

model SubscriptionUsage {
  id         String @id @default(cuid())
  shop       String
  customerId String
  month      String
  shipments  Int    @default(0)

  @@unique([shop, customerId, month])
}

model CustomerProfile {
  customerId String @id
  name       String
  email      String
}

model CustomerIdentity {
  id                 String   @id @default(cuid())
  issuer             String
  subject            String
  internalCustomerId String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([issuer, subject])
  @@unique([internalCustomerId])
  @@index([internalCustomerId])
}

model CustomerStripeMapping {
  id                 String   @id @default(cuid())
  internalCustomerId String
  stripeCustomerId   String
  environment        String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([internalCustomerId, environment])
  @@unique([stripeCustomerId, environment])
  @@index([internalCustomerId])
}

model CustomerMfa {
  customerId String  @id
  secret     String
  enabled    Boolean @default(false)
}

model User {
  id                   String    @id
  email                String    @unique
  passwordHash         String
  role                 String
  resetToken           String?
  resetTokenExpiresAt  DateTime?
  emailVerified        Boolean   @default(false)
  stripeSubscriptionId String?
}

model InventoryItem {
  id                String   @id @default(cuid())
  shopId            String
  sku               String
  productId         String
  quantity          Int
  variantAttributes Json
  lowStockThreshold Int?
  wearCount         Int?
  wearAndTearLimit  Int?
  maintenanceCycle  Int?
  variantKey        String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([shopId, sku, variantKey])
  @@index([shopId])
  @@index([shopId, sku])
}

model ReturnLogistics {
  id   Int  @id
  data Json
}

model ReverseLogisticsEvent {
  id        String @id @default(cuid())
  shop      String
  sessionId String
  event     String
  createdAt String

  @@index([shop])
}

model Setting {
  shop String @id
  data Json
}

model SettingDiff {
  id        String @id @default(cuid())
  shop      String
  timestamp String
  diff      Json

  @@index([shop])
}

model StripeWebhookEvent {
  /// Stripe event id.
  id        String   @id
  shop      String
  type      String
  /// "processed" | "failed" (kept as string for backward-compatible evolution).
  status    String
  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
  @@index([status])
  @@index([updatedAt])
}

// ============================================================
// Central Inventory (LAUNCH-13b)
// Source of truth for inventory across all shops.
// Per-shop inventory is derived from central + routing rules.
// ============================================================

model CentralInventoryItem {
  id                String   @id @default(cuid())
  sku               String
  productId         String
  variantKey        String
  variantAttributes Json
  quantity          Int
  lowStockThreshold Int?
  wearCount         Int?
  wearAndTearLimit  Int?
  maintenanceCycle  Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  routings InventoryRouting[]

  @@unique([sku, variantKey])
  @@index([sku])
  @@index([productId])
}

model InventoryRouting {
  id                     String               @id @default(cuid())
  centralInventoryItemId String
  centralInventoryItem   CentralInventoryItem @relation(fields: [centralInventoryItemId], references: [id], onDelete: Cascade)
  shopId                 String
  /// Allocation mode: "all" routes all stock, "fixed" uses allocatedQuantity, "percentage" uses allocatedPercent
  allocationMode         String               @default("all")
  /// Fixed quantity allocated to this shop (when allocationMode = "fixed")
  allocatedQuantity      Int?
  /// Percentage of stock allocated to this shop (when allocationMode = "percentage")
  allocatedPercent       Int?
  /// Priority for allocation when stock is limited (lower = higher priority)
  priority               Int                  @default(0)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([centralInventoryItemId, shopId])
  @@index([shopId])
  @@index([centralInventoryItemId])
}

model InventoryHold {
  id          String    @id @default(cuid())
  shopId      String
  status      String    // "active" | "committed" | "released" | "expired"
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  committedAt DateTime?
  releasedAt  DateTime?
  expiredAt   DateTime?

  items InventoryHoldItem[]

  @@index([shopId])
  @@index([status])
  @@index([expiresAt])
}

model InventoryHoldItem {
  id                String        @id @default(cuid())
  holdId            String
  hold              InventoryHold @relation(fields: [holdId], references: [id], onDelete: Cascade)
  shopId            String
  sku               String
  productId         String
  variantKey        String
  variantAttributes Json
  quantity          Int

  @@index([holdId])
}
