---
Type: Documentation
Domain: Business OS
Status: Legacy (Local-Only)
Created: 2026-01-28
Last-updated: 2026-01-31
Superseded-by: D1 database-backed architecture (docs/plans/database-backed-business-os-plan.md)
---

# Business OS Repository Operations (Legacy)

**⚠️ LEGACY:** This document describes the **git worktree pattern** which is now **local-only** and **not used in hosted deployments**. The canonical storage for Business OS cards and ideas is now **Cloudflare D1**. Git exports are generated by CI (hourly) for audit purposes.

For current architecture, see:
- `docs/business-os/business-os-charter.md` (canonical storage model)
- `docs/plans/database-backed-business-os-plan.md` (D1 implementation)

---

## Legacy Architecture (Local Development Only)

### Dedicated Worktree

Phase 0 **local development** used a **dedicated git worktree** for write operations:

```
/Users/pete/base-shop/               (main dev checkout)
/Users/pete/base-shop-business-os-store/  (dedicated worktree)
```

**Why a separate worktree? (Historical context)**
- Prevented pollution of the dev checkout
- Allowed dev work to continue while writes happened
- Clean separation between UI dev and data writes

**Why deprecated:**
- Cloudflare Pages has no writable git checkout in runtime
- D1 database provides faster, more reliable storage
- Git export (CI-based) provides audit trail without runtime coupling

### Work Branch (Legacy)

All writes used to commit to: `work/business-os-store`

**Current:** D1 writes only; git exports commit to `work/business-os-export` (CI job)

## Setup (Legacy, Local Dev Only)

**⚠️ NOT NEEDED FOR HOSTED DEPLOYMENT**

Hosted deployment uses D1 database. This setup is only for local development using the legacy git-based writer.

### Initialize Worktree

```bash
# From apps/business-os/
./scripts/setup-worktree.sh
```

This creates the worktree and checks out the work branch.

### Verify Setup

```bash
cd ../base-shop-business-os-store
git status
# Should show: On branch work/business-os-store
# Should show: nothing to commit, working tree clean
```

## Write Operations (Legacy)

**⚠️ REPLACED BY D1 DATABASE WRITES**

For current write operations, see:
- `packages/platform-core/src/repositories/businessOs.server.ts` (D1 repositories)
- `apps/business-os/src/app/api/*/route.ts` (API routes)

### Legacy Save (Local Commit)

1. Write file to worktree
2. `git add <file>`
3. `git commit -m "message"`
4. **No push** - stays local

**Replaced by:** D1 database insert/update

### Legacy Sync (Push to Remote)

1. `git fetch origin`
2. `git merge origin/work/business-os-store` (if exists)
3. `git merge origin/main`
4. `git push origin work/business-os-store`

**Replaced by:** Hourly CI job exports D1 to `work/business-os-export` branch

### Conflict Handling

If conflicts occur during Sync:
- Worktree enters conflict state
- Further writes are **blocked**
- User must resolve manually:
  ```bash
  cd ../base-shop-business-os-store
  # Fix conflicts in files
  git add <resolved-files>
  git commit
  # Or abort:
  git merge --abort
  ```

## API Routes (Current - D1 Database)

### POST /api/ideas

Create a new idea (D1 database write).

**Request:**
```json
{
  "business": "BRIK",
  "content": "# Idea Title\n\nIdea description...",
  "tags": ["tag1", "tag2"]
}
```

**Response:**
```json
{
  "success": true,
  "ideaId": "BRIK-OPP-0003",
  "message": "Idea created successfully"
}
```

**Legacy behavior:** Used to write to git worktree and return `commitHash` and `filePath`. Now writes to D1 database only.

### POST /api/sync (Legacy, Removed)

**⚠️ DEPRECATED:** This endpoint is no longer used. Git exports are handled by CI (GitHub Actions hourly job).

## Error Handling

### Worktree Not Initialized

**Error:**
```json
{
  "error": "Worktree not initialized",
  "hint": "Run: apps/business-os/scripts/setup-worktree.sh"
}
```

**Fix:** Run setup script.

### Worktree Has Uncommitted Changes

**Error:**
```json
{
  "error": "Worktree has uncommitted changes. Commit or discard them first."
}
```

**Fix:**
```bash
cd ../base-shop-business-os-store
git status
# Either commit or discard changes
```

### Merge Conflict

**Error:**
```json
{
  "error": "Merge conflict with main branch. Resolve conflicts manually.",
  "needsManualResolution": true
}
```

**Fix:**
```bash
cd ../base-shop-business-os-store
git status
# See conflicted files
# Edit files to resolve conflicts
git add <resolved-files>
git commit -m "Resolve merge conflict"
# Then retry Sync
```

### Authentication Failed

**Error:**
```json
{
  "error": "Push failed: authentication required"
}
```

**Fix:**
```bash
# Ensure git credentials are configured
gh auth login
# Or configure HTTPS credentials
git config --global credential.helper osxkeychain
```

## Security

### Authorization

All writes are checked against the path allowlist:
- **Allowed:** `docs/business-os/**`
- **Denied:** All other paths

See: `apps/business-os/src/lib/auth/authorize.ts`

### Git Credentials

Phase 0: Uses existing git credential helper (e.g., `osxkeychain`)
- No credentials stored in app
- No environment variables needed
- Uses system git configuration

### Commit Authorship

Commits include co-authorship:
```
Add idea: BRIK-OPP-0003

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

## Debugging

### Check Worktree Status

```bash
cd ../base-shop-business-os-store
git status
git log --oneline -10
```

### View Uncommitted Changes

```bash
cd ../base-shop-business-os-store
git diff
git diff --staged
```

### Check Remote Status

```bash
cd ../base-shop-business-os-store
git fetch origin
git log origin/main..HEAD
```

### Reset Worktree (Caution)

```bash
cd ../base-shop-business-os-store
git reset --hard origin/main
git clean -fd
```

**Warning:** This discards all local changes!

## Phase 1+ Considerations (D1-Backed Architecture)

### Multi-User Support

Phase 1+ will require:
- User authentication (GitHub OAuth)
- User-scoped authorization (business-level access control)
- Optimistic locking (via `updated_at` timestamp checks)
- Conflict resolution UI

### Concurrency

Phase 1+ concurrency handled by:
- D1 database transactions (native SQLite concurrency)
- Optimistic locking on card/idea updates
- No git conflicts (git export is read-only mirror)

### Hosted Deployment

**✅ RESOLVED:** Hosted deployment uses Cloudflare D1 (no writable git checkout needed).
- Production: Cloudflare Pages + D1 binding
- Local dev: `wrangler pages dev` with local D1
- Git export: GitHub Actions hourly job (separate from runtime)

## References

**Current Architecture:**
- Plan: `docs/plans/database-backed-business-os-plan.md`
- Repositories: `packages/platform-core/src/repositories/businessOs.server.ts`
- D1 Schema: `apps/business-os/db/migrations/`
- Security: `docs/business-os/security.md`

**Legacy (Local-Only):**
- Writer: `apps/business-os/src/lib/repo-writer.ts` (git worktree, no longer used in hosted)
- Setup: `apps/business-os/scripts/setup-worktree.sh` (local dev only)
