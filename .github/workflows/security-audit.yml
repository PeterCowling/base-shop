name: Security Audit

on:
  schedule:
    # Run weekly on Monday at midnight UTC
    - cron: '0 0 * * 1'
  pull_request:
    paths:
      - 'pnpm-lock.yaml'
      - '**/package.json'
  push:
    branches:
      - main
    paths:
      - 'pnpm-lock.yaml'
      - '**/package.json'
  workflow_dispatch: # Allow manual trigger

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: ./.github/actions/setup-repo

      - name: Run security audit (Critical)
        id: audit-critical
        run: |
          pnpm audit --audit-level=critical || echo "CRITICAL_VULNERABILITIES=true" >> $GITHUB_ENV
        continue-on-error: true

      - name: Run security audit (High)
        id: audit-high
        run: |
          pnpm audit --audit-level=high > audit-report.txt 2>&1 || true
          cat audit-report.txt

      - name: Run security audit (Moderate)
        id: audit-moderate
        run: |
          pnpm audit --audit-level=moderate > audit-report-full.txt 2>&1 || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: |
            audit-report.txt
            audit-report-full.txt
          retention-days: 90

      - name: Comment on PR with audit results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditOutput = 'No audit report generated';
            try {
              auditOutput = fs.readFileSync('audit-report.txt', 'utf8');
            } catch (e) {
              console.log('Could not read audit report');
            }

            const body = `## ðŸ”’ Security Audit Results

            ${auditOutput.substring(0, 5000)}

            ${auditOutput.length > 5000 ? '\n\n... (truncated, see full report in artifacts)' : ''}

            ---
            ðŸ“Š **Review the full audit report in the workflow artifacts**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail on critical vulnerabilities
        if: env.CRITICAL_VULNERABILITIES == 'true'
        run: |
          echo "::error::Critical security vulnerabilities found!"
          exit 1
