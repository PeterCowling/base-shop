# Card Operations Helper

Shared helper for creating and managing Business OS cards. **D1 is the source of truth.** Skills must use the agent API and must **not** write markdown files directly.

## Fail-Closed Rule (Mandatory)

If any API call fails, **stop and surface the error**. Do **not** fall back to writing markdown or scanning the repo.

## API Prerequisites

- `BOS_AGENT_API_BASE_URL`
  - Prod: `https://business-os.peter-cowling1976.workers.dev`
  - Local: `http://localhost:3020`
- `BOS_AGENT_API_KEY`
- Header: `X-Agent-API-Key: <value>`

### Example WebFetch (pseudo)

```json
{
  "method": "POST",
  "url": "${BOS_AGENT_API_BASE_URL}/api/agent/cards",
  "headers": {
    "X-Agent-API-Key": "${BOS_AGENT_API_KEY}",
    "Content-Type": "application/json"
  },
  "body": {
    "business": "BRIK",
    "title": "Example title",
    "description": "Short description",
    "lane": "Fact-finding",
    "priority": "P3",
    "owner": "Pete"
  }
}
```

## Card ID Format

**Format:** `<BUSINESS>-ENG-<SEQUENCE>`

- `BUSINESS`: Business unit code (BRIK, PLAT, PIPE, BOS)
- `ENG`: Card type (always "ENG" for engineering cards)
- `SEQUENCE`: 4-digit zero-padded number (e.g., 0001, 0002, ..., 0999, 1000)

**Examples:**
- `BRIK-ENG-0001`
- `PLAT-ENG-0023`
- `PIPE-ENG-0005`

## ID Allocation (API)

Call the API. You may either:
1) **Use the ID returned by `POST /api/agent/cards`** (recommended), or
2) **Call `POST /api/agent/allocate-id`** if you must know the ID before creating the card.

### Allocate ID (if needed)

```json
{
  "method": "POST",
  "url": "${BOS_AGENT_API_BASE_URL}/api/agent/allocate-id",
  "headers": {
    "X-Agent-API-Key": "${BOS_AGENT_API_KEY}",
    "Content-Type": "application/json"
  },
  "body": {
    "business": "PLAT",
    "type": "card"
  }
}
```

Response:
```json
{ "id": "PLAT-ENG-0023" }
```

## Card Storage (Generated)

Markdown files are generated by the export job. Do not create or edit:
- `docs/business-os/cards/<ID>.user.md`
- `docs/business-os/cards/<ID>.agent.md`

## Card Create Payload (API)

`POST /api/agent/cards`

```json
{
  "business": "BRIK",
  "title": "Card title",
  "description": "Short description", // or use "content"
  "content": "# Title\n\nBody...",     // optional
  "lane": "Fact-finding",
  "priority": "P3",
  "owner": "Pete",
  "proposedLane": "Planned",         // optional
  "tags": ["tag1", "tag2"],           // optional
  "dueDate": "2026-02-02",            // optional
  "Feature-Slug": "feature-slug",     // optional
  "Last-Progress": "2026-02-02",      // optional
  "Plan-Link": "docs/plans/foo.md"    // optional
}
```

Response:
```json
{ "success": true, "cardId": "BRIK-ENG-0001", "message": "Card created" }
```

## Step-by-Step Card Creation (API)

### 1) Create the card

Call `POST /api/agent/cards` and use the returned `cardId`.

### 2) Create stage docs (if needed)

Use `POST /api/agent/stage-docs` with the `cardId` and stage type.

### 3) Update cards (PATCH)

Use `PATCH /api/agent/cards/:id` with JSON Merge Patch and optimistic concurrency.

## Idempotency

Always avoid creating duplicate cards.

### Check by Card-ID (Primary)

Use `GET /api/agent/cards/:id`:

```json
{
  "method": "GET",
  "url": "${BOS_AGENT_API_BASE_URL}/api/agent/cards/PLAT-ENG-0023",
  "headers": { "X-Agent-API-Key": "${BOS_AGENT_API_KEY}" }
}
```

If 200 → use existing card. If 404 → create new card.

### Check by Feature-Slug (Fallback)

If you have a `Feature-Slug`, list cards for the business and scan the response:

```json
{
  "method": "GET",
  "url": "${BOS_AGENT_API_BASE_URL}/api/agent/cards?business=PLAT",
  "headers": { "X-Agent-API-Key": "${BOS_AGENT_API_KEY}" }
}
```

Then check for matching `Feature-Slug` or `Plan-Link` in returned cards. If found, use that card.

## Related Writes (API)

When skills also create ideas or stage docs, use the agent APIs:
- `POST /api/agent/ideas`
- `POST /api/agent/stage-docs`

**Fail-closed:** if any API call fails, stop and report the error. Do not write markdown.
