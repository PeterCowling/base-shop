---
Type: Investigation-Artifact
Status: Complete
Created: 2026-02-17
Task: TASK-13
Plan: docs/plans/startup-loop-marketing-sales-capability-gap-audit/plan.md
---

# Stage Addressing Surface Map (2026-02-17)

## Purpose

Maps all surfaces that parse, enforce, or consume startup-loop stage addressing. This artifact feeds TASK-18 (fail-closed stage addressing implementation) and identifies which surfaces must adopt `*_label` and `*_display` fields when label-first addressing is introduced.

## Classification Key

| Class | Meaning |
|---|---|
| `authoritative` | Canonical source; other surfaces must align to this |
| `generated` | Derived deterministically from an `authoritative` source; do not edit directly |
| `consumer` | Reads stage IDs/names but does not define them |
| `legacy` | Contains hardcoded stage-name duplication that should be replaced by a generated consumer |

---

## Surface Map (14 files)

| # | File | Class | Stage-addressing role | Duplication risk |
|---|---|---|---|---|
| 1 | `docs/business-os/startup-loop/loop-spec.yaml` | **authoritative** | Runtime stage IDs and graph spec. The `id:` field per stage is the stable contract for all downstream surfaces. | None — this is the ID source |
| 2 | `docs/business-os/startup-loop/stage-operator-dictionary.yaml` | **authoritative** | Operator naming source of truth: `label_operator_short`, `label_operator_long`, `name_machine`, `aliases`, `display_order`. Created TASK-14. | None — this is the naming source |
| 3 | `.claude/skills/startup-loop/SKILL.md` | **authoritative** | Command contract enforcement: `--stage <S#>` (submit), `current_stage: <S#>` (run packet). Enforces addressing at skill/instruction level — not code-validated. Stage list duplicated inline (expected: instruction-level documentation). | Stage list inline (expected duplication for skill readability) |
| 4 | `docs/business-os/startup-loop/_generated/stage-operator-map.json` | **generated** | Alias index (`alias_index`) + stage display fields. Generated by TASK-15 from `stage-operator-dictionary.yaml`. Provides `alias_index` for alias→ID resolution. | None — generated |
| 5 | `docs/business-os/startup-loop/_generated/stage-operator-table.md` | **generated** | Markdown operator table for docs consumption. Generated by TASK-15. | None — generated |
| 6 | `scripts/src/startup-loop/derive-state.ts` | **consumer + legacy** | `STAGE_NAMES` record (hardcoded, lines ~52-70): maps stage IDs to display names. Used for `name:` field in `StageState`. Should be replaced by consuming `stage-operator-map.json` alias/display fields. `ALL_STAGE_IDS` is alpha-sorted (deterministic). | **STAGE_NAMES hardcoded — duplication of loop-spec `name:` fields** |
| 7 | `packages/mcp-server/src/tools/loop.ts` | **consumer + legacy** | Primary executable enforcement point. `STARTUP_LOOP_STAGES` const (hardcoded 17-item tuple). `loopStatusInputSchema` requires `current_stage` for all 14 loop tools. Policy map requires `contextRequired: ["business", "runId", "current_stage"]` across all tools. | **STARTUP_LOOP_STAGES hardcoded — duplication of loop-spec stage IDs** |
| 8 | `packages/mcp-server/src/tools/policy.ts` | **consumer** | `allowedStages` in `ToolPolicy` (zod schema). Enforces stage-level access control. Consumes stage IDs via policy map in `loop.ts`. No stage-name duplication. | None |
| 9 | `packages/mcp-server/src/tools/bos.ts` | **consumer** | Requires `current_stage` in input context per policy enforcement. Does not define or duplicate stage IDs. | None |
| 10 | `packages/mcp-server/src/tools/analytics-sunset.ts` | **consumer** | Requires `current_stage` per policy context. Does not define or duplicate stage IDs. | None |
| 11 | `scripts/check-startup-loop-contracts.sh` | **consumer** | Contract lint (SQ-01, SQ-09, SQ-14). Validates that loop-spec stage IDs appear in SKILL.md and workflow guide. Uses `current_stage` as bash variable internally for loop iteration (not stage-addressing). Checks `stage_id` via `rg` scan. | None — reads, does not duplicate |
| 12 | `docs/business-os/startup-loop-workflow.user.md` | **consumer** | Operator workflow; stage status table uses stage IDs as row keys. Code-first stage labels visible to operators (UX gap, per naming UX fact-find). | None — display only |
| 13 | `packages/mcp-server/src/__tests__/startup-loop-tools.integration.test.ts` | **consumer** | Integration tests for stage addressing and `current_stage` behavior across tool calls. | None |
| 14 | `packages/mcp-server/src/__tests__/loop-tools.test.ts` | **consumer** | Unit tests for loop tool input validation including `current_stage`. | None |

---

## Questions Answered

### Q1: Where is stage addressing actually parsed and enforced today?

Two enforcement layers exist — skill-level (instruction-based) and code-level (executable):

| Layer | Surface | Mechanism | Strength |
|---|---|---|---|
| Skill-level | `.claude/skills/startup-loop/SKILL.md` | Prompt instruction: `--stage <S#>` and `current_stage: <S#>` in run packet | Advisory; not validated by code |
| Code-level (primary) | `packages/mcp-server/src/tools/loop.ts` | Zod `loopStatusInputSchema` requires `current_stage`; policy map enforces `contextRequired` | Hard; rejects malformed requests |
| Code-level (policy) | `packages/mcp-server/src/tools/policy.ts` | `allowedStages` field per tool policy; `STRICT_TOOL_PREFIXES` controls enforcement mode | Hard for `bos_`, `loop_`, `exp_`, `ops_` prefixed tools |
| Lint-level | `scripts/check-startup-loop-contracts.sh` | Checks SQ-01/SQ-09: stage IDs in loop-spec appear in SKILL.md and workflow guide | Weak (bash string match, not schema validation) |

**Conclusion:** Addressing is currently **skill-only for command parsing** (`--stage <S#>`), **code-enforced for API calls** (`current_stage` in MCP tools). There is no resolver between free-form input and canonical stage ID — alias/label addressing must be added at the MCP input layer.

### Q2: Which surfaces emit or consume run-packet stage fields and must adopt `*_label` and `*_display`?

Run packet currently has:
- `current_stage: <S#>` — required field in SKILL.md contract

No `current_stage_display` or `current_stage_label` fields exist today.

Surfaces that must be updated when `*_label` and `*_display` are added:

| Surface | Change required | Priority |
|---|---|---|
| `.claude/skills/startup-loop/SKILL.md` | Add `current_stage_label: <label_operator_short>` to run packet template | **High** — defines the contract |
| `packages/mcp-server/src/tools/loop.ts` | Add `current_stage_label` optional field to output schemas; add alias resolver at input | **High** — executable contract |
| `scripts/src/startup-loop/derive-state.ts` | Replace `STAGE_NAMES` with import from generated map; emit `name_display` and `label_operator_short` | **Medium** — state derivation consumer |
| `docs/business-os/startup-loop-workflow.user.md` | Stage status table can reference `label_operator_short` for display | **Low** — docs update after code stabilizes |

### Q3: Which stage-name maps are duplicated and should be replaced by generated output?

| Duplication location | Current value | Should consume |
|---|---|---|
| `scripts/src/startup-loop/derive-state.ts:STAGE_NAMES` | Hardcoded 17-entry record mapping stage IDs → display names | `docs/business-os/startup-loop/_generated/stage-operator-map.json` → `stages[].name_machine` or `label_operator_short` |
| `packages/mcp-server/src/tools/loop.ts:STARTUP_LOOP_STAGES` | Hardcoded 17-item tuple of stage IDs | `docs/business-os/startup-loop/_generated/stage-operator-map.json` → `alias_index` keys filtered to stage IDs, or generated TypeScript constant |
| `.claude/skills/startup-loop/SKILL.md:Stage Model` | Stage list inline | Expected documentation duplication; not a code risk |

---

## Recommended Enforcement Boundary

**Single recommended boundary: MCP server tool input validation in `packages/mcp-server/src/tools/loop.ts`.**

Rationale:
1. This is the only executable enforcement point that validates stage addressing at runtime across all 14 loop tools.
2. All operator commands (`start`, `status`, `submit`, `advance`) ultimately produce API calls that pass through this layer.
3. `loopStatusInputSchema` already requires `current_stage` — extending it to accept `stage_alias` is additive and backwards-compatible.
4. The alias index is already available in `_generated/stage-operator-map.json` and can be loaded at server startup for O(1) lookup.
5. Centralizing at this boundary means all tools inherit alias/label resolution without per-tool changes.

**Alternative considered:** Skill-level (SKILL.md) pre-resolution before the API call. Rejected because: skill instructions are advisory and not code-validated; adding alias logic in SKILL.md text creates maintenance burden across future skill updates with no runtime guarantee.

---

## Migration Risk: Strict `--stage-label` Compatibility

Strict `--stage-label` addressing (exact label-to-ID lookup) has the highest migration risk of the three addressing modes:

| Risk | Severity | Detail |
|---|---|---|
| Label instability | **High** | `label_operator_short` values (≤28 chars) are not contractually frozen across dictionary version bumps. A label change breaks all callers using `--stage-label`. |
| Naming divergence | **Medium** | `STAGE_NAMES` in `derive-state.ts` values differ from `label_operator_long` in the dictionary (e.g., "Channel strategy + GTM" vs "S6B — Channel strategy + GTM"). No single canonical label string exists across all surfaces today. |
| Case/whitespace sensitivity | **Medium** | Label matching is case-sensitive and whitespace-sensitive. Any formatting difference creates a silent miss. |
| Backwards incompatibility | **High** | All current callers use `--stage <S#>`. `--stage-label` cannot replace the primary contract; it must be additive. |

**Recommendation for TASK-18:**
- `--stage <S#>` — keep as primary contract, never break
- `--stage-alias <alias>` — preferred new addressing mode; resolved via `alias_index` in generated map; lower stability risk than labels
- `--stage-label <text>` — strict additive mode only; resolve via `label_operator_short` exact match from generated map; emit deprecation warning if label is ambiguous or unmapped; fail-closed (error, not silent fallback) when unresolved

---

## Validation

- **VC-01 PASS:** 14 files classified with class and rationale (≥8 required). ✅
- **VC-02 PASS:** Exactly one enforcement boundary selected (MCP server `loop.ts` input validation) with alternatives considered and rejected. ✅
