---
Type: Fact-Find
Outcome: planning
Status: Ready-for-planning
Domain: BOS
Workstream: Engineering
Created: 2026-02-26
Last-updated: 2026-02-26
Feature-Slug: ideas-classifier-queue-wiring-and-report
Execution-Track: code
Deliverable-Family: code-change
Deliverable-Channel: none
Deliverable-Subtype: none
Deliverable-Type: code-change
Startup-Deliverable-Alias: none
Primary-Execution-Skill: lp-do-build
Supporting-Skills: none
Related-Plan: docs/plans/ideas-classifier-queue-wiring-and-report/plan.md
Trigger-Source: direct-operator-decision: classifier (lp-do-ideas-classifier.ts) is complete but its output is not yet wired into the queue scheduler, dispatch schema, report generator, or HTML report
artifact: fact-find
---

# Ideas Classifier Queue Wiring and Report Fact-Find Brief

## Scope
### Summary
The `lp-do-ideas-classifier.ts` module (implemented as of 2026-02-26) produces a complete `IdeaClassification` record with 8-tier priority, urgency (U0–U3), effort, proximity, and `reason_code`. However, three downstream consumers still use the old 3-tier priority (`P1/P2/P3`) or author-written `suggested_action` text rather than the canonical classification fields:

1. **Trial queue scheduler** (`lp-do-ideas-trial-queue.ts`): `planNextDispatches()` sorts by `entry.packet.priority` (old 3-tier: `"P1" | "P2" | "P3"`) using a simple `priorityBaseScore()` function. It has no concept of `effective_priority_rank`, `urgency`, or `effort`.
2. **Dispatch schema** (`lp-do-ideas-dispatch.schema.json`): `priority` field is still typed as `enum: ["P1", "P2", "P3"]`. The 8-tier classifier fields (`priority_tier`, `urgency`, `effort`, `reason_code`) are absent.
3. **Generator** (`generate-process-improvements.ts`): calls `classifyIdea()` per idea but only writes `priority_tier` and `own_priority_rank` onto `ProcessImprovementItem`. The `urgency`, `effort`, `proximity`, and `reason_code` fields from `IdeaClassification` are discarded.
4. **HTML report** (`process-improvements.user.html`): sections ideas by `suggested_action` (Act/Investigate/Defer) which is free-text. It only shows the `priority_tier` badge but does not group by canonical tier or show urgency.
5. **Existing idea data** (`docs/business-os/_data/process-improvements.json`): 37 idea items have `priority_tier` and `own_priority_rank` but not `urgency`, `effort`, `proximity`, or `reason_code`.

### Goals
- (A) Update `planNextDispatches()` in `lp-do-ideas-trial-queue.ts` to sort on `(is_expedite flag/U0-U1 urgency, effective_priority_rank, urgency_rank, effort_rank, created_at, idea_id)` using classifier output when available, falling back to old 3-tier for packets without classification.
- (B) Add `priority_tier`, `urgency`, `effort`, and `reason_code` fields to the dispatch schema (`lp-do-ideas-dispatch.schema.json`) as optional additional properties while retaining backward-compatible `priority` enum.
- (C) Update `generate-process-improvements.ts` to emit `urgency`, `effort`, `proximity`, and `reason_code` fields onto `ProcessImprovementItem` (extend the interface and the classifier call).
- (D) Re-run `classifyIdea()` over all existing ideas in `process-improvements.json` and persist the four new fields — this is accomplished by running the generator after the interface change.
- (E) Update the HTML report render logic to group ideas by canonical priority tier (P0/P0R/P1/P1M/P2/P3/P4/P5) and urgency (U0/U1/U2/U3), replacing the `suggested_action` grouping.

### Non-goals
- Phase 4 prerequisite inheritance (effective_priority_rank from parent idea) — explicitly deferred in classifier design.
- Changing the 3-tier `priority` field on `TrialDispatchPacket` — backward compatibility must be preserved.
- Changing the queue's core state machine, dedup logic, or telemetry.
- Live-mode wiring of the classifier to dispatch production.

### Constraints & Assumptions
- Constraints:
  - `TrialDispatchPacket.priority` is `"P1" | "P2" | "P3"` in the TypeScript type (`lp-do-ideas-trial.ts` line 145) — this cannot change without a migration.
  - The `planNextDispatches()` scheduler receives `QueueEntry` objects which carry the original packet, not an `IdeaClassification` record. Classification data is attached via an optional `classification` field on `QueueEntry` (not on `TrialDispatchPacket`) — see Resolved Q1 below.
  - The HTML report is generated by injecting `IDEA_ITEMS`, `RISK_ITEMS`, `PENDING_REVIEW_ITEMS` JS arrays into the existing HTML; the render JS function is embedded in the committed `process-improvements.user.html` and must be edited there directly — it persists across generator runs because the generator only replaces data array assignments, not the render JS.
  - The JSON schema uses `"additionalProperties": false` — new fields require explicit property declarations.
- Assumptions:
  - The queue scheduler change can be additive: when `IdeaClassification` fields are not available on a packet (old-style), fall back to old 3-tier base score. This preserves full backward compat.
  - The `ProcessImprovementItem` interface extension will naturally cause all existing ideas to gain the new fields when the generator is re-run (since `classifyIdea()` always produces them).

## Outcome Contract

- **Why:** The classifier is complete but its output has no effect on queue ordering or report grouping. This wiring step is the natural next step to make the classification policy actually drive work selection and operator visibility.
- **Intended Outcome Type:** operational
- **Intended Outcome Statement:** Queue scheduler uses effective_priority_rank+urgency+effort sort key from classifier output; report groups ideas by canonical tier and urgency; all existing ideas have full classification fields.
- **Source:** operator

## Evidence Audit (Current State)

### Entry Points
- `scripts/src/startup-loop/lp-do-ideas-trial-queue.ts` — `planNextDispatches()` method (line 755): sorts by old 3-tier `priority` field via `priorityBaseScore()` (line 307–318)
- `scripts/src/startup-loop/generate-process-improvements.ts` — `collectProcessImprovements()` (line 457): calls `classifyIdea()` per idea (lines 559–573) but only writes `priority_tier` and `own_priority_rank`
- `docs/business-os/process-improvements.user.html` — `render()` function (line 857): groups by `suggested_action` text (lines 903–929)

### Key Modules / Files
1. `scripts/src/startup-loop/lp-do-ideas-classifier.ts` — Pure classifier, exports `classifyIdea()`, `IdeaClassification`, `IdeaClassificationInput`. No file I/O. Decision tree at lines 633–715. Urgency admission at lines 530–579.
2. `scripts/src/startup-loop/lp-do-ideas-trial-queue.ts` — Queue class, `planNextDispatches()` (line 755), `ScheduledDispatch` interface (lines 54–62), `priorityBaseScore()` (lines 307–318), `computeSchedulingScore()` (lines 320–328).
3. `scripts/src/startup-loop/generate-process-improvements.ts` — `ProcessImprovementItem` interface (lines 22–36), `sortIdeaItems()` (lines 366–381), classifier call (lines 559–573).
4. `docs/business-os/startup-loop/ideas/lp-do-ideas-dispatch.schema.json` — JSON schema with `priority: { enum: ["P1","P2","P3"] }` (line 120–124), `additionalProperties: false` (line 217).
5. `docs/business-os/process-improvements.user.html` — Static HTML with embedded JS; `render()` and `renderItem()` functions contain the grouping logic.
6. `scripts/src/startup-loop/__tests__/lp-do-ideas-trial-queue.test.ts` — Existing tests cover enqueue/advance/dedup; no tests for `planNextDispatches()` with classifier sort keys.
7. `scripts/src/startup-loop/__tests__/generate-process-improvements.test.ts` — Existing tests cover idea collection and HTML injection; needs updating for new fields.
8. `scripts/src/startup-loop/__tests__/lp-do-ideas-classifier.test.ts` — 33 tests covering full decision tree. Pure unit tests, no file I/O.
9. `docs/business-os/_data/process-improvements.json` — 37 idea items, currently with `priority_tier` + `own_priority_rank` only (no `urgency`, `effort`, `proximity`, `reason_code`).

### Data & Contracts
- Types/schemas/events:
  - `IdeaClassification` (classifier output): `priority_tier`, `proximity`, `urgency`, `effort`, `reason_code`, `effective_priority_rank`, `own_priority_rank`, plus evidence fields.
  - `ProcessImprovementItem`: currently `priority_tier?: string`, `own_priority_rank?: number` — needs `urgency?: string`, `effort?: string`, `proximity?: string | null`, `reason_code?: string`.
  - `ScheduledDispatch`: `{ dispatch_id, lane, priority: "P1"|"P2"|"P3", age_hours, score }` — needs augmentation or a separate sort key map.
  - `lp-do-ideas-dispatch.schema.json`: `additionalProperties: false` requires explicit `priority_tier`, `urgency`, `effort`, `reason_code` property declarations to add classifier fields without schema validation errors.
- Persistence:
  - `docs/business-os/_data/process-improvements.json` — written by generator CLI, checked by drift check.
  - `docs/business-os/process-improvements.user.html` — written by generator CLI using `replaceArrayAssignment()`.
- API/contracts:
  - Generator exports `ProcessImprovementItem` type and `collectProcessImprovements()` — changing the interface is a source-visible breaking change in TypeScript but the data file format is JSON (backward compatible with old readers).

### Dependency & Impact Map
- Upstream dependencies:
  - `classifyIdea()` in classifier — pure function, no change needed.
  - `TrialDispatchPacket.priority` ("P1"|"P2"|"P3") — must remain as the fallback for packets not enriched by classification.
- Downstream dependents:
  - `lp-do-ideas-trial-queue.test.ts` — existing tests for `planNextDispatches()` use old priority values; must be updated.
  - `generate-process-improvements.test.ts` — tests for `ProcessImprovementItem` shape must be updated.
  - `runCheck()` / `--check` mode — drift check will correctly catch when data file needs regeneration.
  - Any code reading `ProcessImprovementItem.suggested_action` for grouping (only the HTML render, which is also being changed).
- Likely blast radius:
  - TypeScript: `ProcessImprovementItem` interface change affects only `generate-process-improvements.ts` and its tests.
  - Queue scheduler: `planNextDispatches()` and its callers. The function is non-mutating so test coverage is the only risk.
  - HTML report: the JS render logic is embedded in the generated HTML file; changes go in `generate-process-improvements.ts` template section (there is no separate template file — the HTML is the template).
  - JSON schema: `additionalProperties: false` means any invalid new property will cause schema validation to fail. Must add explicit property declarations.

### Test Landscape
#### Test Infrastructure
- Frameworks: Jest (scripts package)
- Commands: `pnpm -w run test:governed -- jest -- --config=scripts/jest.config.cjs --testPathPattern=<pattern>`
- CI integration: runs as part of scripts package tests

#### Existing Test Coverage
| Area | Test Type | Files | Coverage Notes |
|---|---|---|---|
| Classifier decision tree | Unit | `lp-do-ideas-classifier.test.ts` | 33 TCs covering all rules, urgency, rank, metadata |
| Queue enqueue/advance/dedup | Unit | `lp-do-ideas-trial-queue.test.ts` | Covers state machine, telemetry, dedup; `planNextDispatches()` has tests but uses old priority field |
| Generator collect/inject/check | Unit | `generate-process-improvements.test.ts` | Covers idea collection and HTML injection |

#### Coverage Gaps
- Untested paths:
  - `planNextDispatches()` sort behaviour when classification fields are present alongside old priority — no test exercises the new sort key.
  - `ProcessImprovementItem` with `urgency`, `effort`, `proximity`, `reason_code` fields — new tests needed.
  - HTML render grouping by priority tier — the render JS is not unit-tested (embedded in HTML).
- Extinct tests:
  - Tests that assert `planNextDispatches()` sorts only on old P1/P2/P3 base score — these will need updating for the new sort contract.

#### Testability Assessment
- Easy to test: `ProcessImprovementItem` interface changes (unit tests in existing test file), `planNextDispatches()` sort behaviour (injectable clock, deterministic inputs).
- Hard to test: HTML render JS (embedded in HTML string; no DOM in Jest by default). Accepted as visual-only validation.
- Test seams needed: `planNextDispatches()` needs an injectable classification lookup map or the `QueueEntry` packet to carry classifier fields.

### Recent Git History (Targeted)
- `generate-process-improvements.ts` — `043db31918` "feat(process-improvements): sort and badge ideas by canonical priority tier" — added `own_priority_rank` and `priority_tier` to `ProcessImprovementItem`; added `sortIdeaItems()`. This is the most recent change and is the direct predecessor to this work.
- `lp-do-ideas-classifier.ts` — `6282567ca1` "feat(bos): add IdeaClassification types and classifyIdea() for advisory phase prioritization" and `29d15c577e` "feat(startup-loop): add canonical idea classifier types and implementation (TASK-01+02)".
- `lp-do-ideas-dispatch.schema.json` — `19b4c203f0` "chore: checkpoint outstanding workspace changes".

## Questions

### Resolved

- Q: Does `planNextDispatches()` need the classifier to classify packets at scheduling time, or can it use pre-computed values?
  - A: Pre-computed. The classification is done at dispatch creation time. **Design decision (committed): use Option B — add optional `classification?: { effective_priority_rank: number; urgency: string; effort: string }` to `QueueEntry` (not to `TrialDispatchPacket`)**. This keeps the packet type and JSON schema unchanged, confining the change to the in-memory queue internals. The scheduler reads `entry.classification` when present; otherwise falls back to `priorityBaseScore(entry.packet.priority)`. Since this is a Phase 1 advisory mode, all current packets will lack these fields and the old sort behaviour is preserved as fallback.
  - Evidence: `lp-do-ideas-trial-queue.ts` line 755–848; `lp-do-ideas-classifier.ts` comments on Phase 1 advisory mode.

- Q: How does the HTML report template work — is it a separate file or embedded in the generator?
  - A: Embedded. The JS render code (`render()`, `renderItem()`, `tierBadge()`, `actionGroup()`, etc.) is part of the committed HTML file (`process-improvements.user.html`). The generator reads the existing HTML, replaces only the `var IDEA_ITEMS = [...];` / `RISK_ITEMS` / `PENDING_REVIEW_ITEMS` array assignments (and the `GEN_TS` variable), then writes the result back. The render JS is not replaced by the generator — it is part of the template. Therefore, to change the grouping logic, the embedded JS in `process-improvements.user.html` must be edited directly (and it will persist across generator runs since the generator does not touch that section).
  - Evidence: `generate-process-improvements.ts` `replaceArrayAssignment()` (line 649–666), `updateProcessImprovementsHtml()` (line 690–705); HTML file line 857–978.

- Q: Should `additionalProperties: false` in the dispatch schema be changed to allow new fields, or should explicit properties be declared?
  - A: Explicit property declarations. The schema is a formal contract and `additionalProperties: false` is intentional to prevent silent field drift. New fields (`priority_tier`, `urgency`, `effort`, `reason_code`) should be declared as optional properties in the schema so they can be present without validation failure. This is fully backward compatible.
  - Evidence: `lp-do-ideas-dispatch.schema.json` line 217.

- Q: Will re-running the generator be sufficient to backfill existing ideas with the new classification fields (Task D)?
  - A: Yes. `collectProcessImprovements()` re-runs `classifyIdea()` on every idea sourced from `results-review.user.md` files on every generator invocation. Once `ProcessImprovementItem` is extended to include `urgency`, `effort`, `proximity`, and `reason_code`, and the generator code writes those fields, all existing ideas will automatically get the new fields on the next generator run. The `process-improvements.json` data file is written fresh each run — it is not an append-only store.
  - Evidence: `generate-process-improvements.ts` lines 559–573 (classifier call), line 820–826 (runCli write path).

### Open (Operator Input Required)
- None. All decisions can be resolved from documented constraints and the existing codebase.

## Confidence Inputs

- Implementation: 95%
  - Evidence: All entry points, types, and integration seams are confirmed. The change is purely additive (new optional fields). The one non-trivial design choice (how to pass classification to the scheduler) has a clear safe path (optional field on QueueEntry/packet or separate lookup).
  - To >=80: Already at 95%.
  - To >=90: Already at 95%.

- Approach: 90%
  - Evidence: The additive/backward-compat approach is well-supported by Phase 1 advisory constraints in the classifier. HTML render change is in-file (not a separate template), which is confirmed.
  - To >=90: Already at 90%.

- Impact: 85%
  - Evidence: The report grouping change is the primary operator-visible impact — canonical tier sections replace author-written action groups. Queue sort change has minimal observable effect on current data since all ideas classify P4/P5/U3 (no evidence fields supplied), so sort order is unchanged in practice today.
  - What would raise to >=90: Operator confirms grouping by canonical tier (with suggested_action retained as secondary label) is the desired UX.

- Delivery-Readiness: 95%
  - Evidence: No external dependencies, no deploy needed, pure TypeScript + JSON + HTML changes. Tests exist and are well-structured.
  - To >=90: Already at 95%.

- Testability: 85%
  - Evidence: All TypeScript logic is testable via Jest. HTML render JS is not unit-testable (embedded in HTML string), but this is accepted given the existing pattern.
  - What would raise to >=90: Add tests for the new `planNextDispatches()` sort path with classifier fields (TC for urgency tiebreaker).

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| HTML render JS edit breaks existing filter/render logic | Low | Medium | The section being changed (the `ideaGroup()` call block) is well-isolated. Change is to section grouping only, not card rendering. |
| `additionalProperties: false` schema causes validation error if new field not declared | Low | Low | Explicit property declarations in schema. No runtime validation of schema in this path — schema is doc-only in Phase 1. |
| `planNextDispatches()` tests break on updated sort contract | Medium | Low | Tests use old priority values; update expected sort orders in tests as part of the task. |
| Generator drift check fails after ProcessImprovementItem change | Low | Low | Running the generator after the change will regenerate data and HTML, aligning the drift check. |
| New tier-based grouping creates near-empty P1–P3 sections and a dominant P4/P5 group (all current ideas lack evidence fields so all classify P4/P5/U3) | Medium | Medium | Keep `suggested_action` as a secondary label within tier-grouped sections; do not remove it entirely. |
| Filter bar business/type state interacts poorly with tier-based section layout (sections may show "0 items" per tier for a filtered business) | Low | Medium | Ensure filter logic applies inside each tier section, not across sections. |

## Planning Constraints & Notes
- Must-follow patterns:
  - `ProcessImprovementItem` interface additions must be optional (`?:`) to preserve backward compat with existing persisted JSON.
  - `planNextDispatches()` fallback to old 3-tier sort must be preserved when classification fields are absent.
  - HTML report JS modifications go in the committed `process-improvements.user.html` (they persist through generator runs since generator only replaces data arrays).
  - Plain-language rule from MEMORY.md: no system-internal nouns in operator-visible body/title text.
- Rollout/rollback expectations:
  - No deploy required. Changes are to local TypeScript scripts and static HTML files.
  - Rollback: git revert.
- Observability expectations:
  - After build: run `pnpm --filter scripts startup-loop:generate-process-improvements` and open the HTML report to verify tier grouping.

## Suggested Task Seeds (Non-binding)
- TASK-01: Extend `ProcessImprovementItem` interface with `urgency`, `effort`, `proximity`, `reason_code` and update the classifier call in `generate-process-improvements.ts` to write them.
- TASK-02: Update `lp-do-ideas-dispatch.schema.json` to add optional `priority_tier`, `urgency`, `effort`, `reason_code` properties (backward-compatible).
- TASK-03: Update `planNextDispatches()` in `lp-do-ideas-trial-queue.ts` to sort on `(urgency_rank, effective_priority_rank, effort_rank, created_at, dispatch_id)` using classification fields when available, with old P1/P2/P3 fallback.
- TASK-04: Update the HTML report render JS in `process-improvements.user.html` to group ideas by canonical priority tier + urgency instead of `suggested_action`.
- TASK-05: Update tests for generator (`ProcessImprovementItem` new fields) and queue scheduler (`planNextDispatches` new sort).
- TASK-06: Re-run the generator (produces updated `process-improvements.json` and HTML with new fields and grouping).

## Execution Routing Packet
- Primary execution skill: lp-do-build
- Supporting skills: none
- Deliverable acceptance package: TypeScript compiles, existing tests pass, new tests added, generator produces updated data file with `urgency`/`effort`/`proximity`/`reason_code` fields on all ideas, HTML report groups by canonical tier.
- Post-delivery measurement plan: Visual inspection of `process-improvements.user.html` after re-generation.

## Evidence Gap Review

### Gaps Addressed
- Confirmed HTML render change location (embedded in HTML file, not a separate template — confirmed by reading `replaceArrayAssignment()` scope).
- Confirmed full classifier output fields (`IdeaClassification` interface — all fields read from source).
- Confirmed `planNextDispatches()` inputs and the fallback path.
- Confirmed `additionalProperties: false` constraint in schema.
- Confirmed existing test files and their coverage scope.

### Confidence Adjustments
- No downward adjustments required. All critical seams are confirmed.

### Remaining Assumptions
- The HTML render JS edit (grouping logic change) requires no unit tests per existing convention (HTML render logic is not unit-tested in this codebase).
- Classifier Phase 1 always produces `urgency`, `effort`, `reason_code` — confirmed from classifier source (lines 725–730).

## Planning Readiness
- Status: Ready-for-planning
- Blocking items: none
- Recommended next step: `/lp-do-plan ideas-classifier-queue-wiring-and-report --auto`
