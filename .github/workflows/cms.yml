name: Deploy CMS

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'apps/cms/**'
      - 'packages/config/**'
      - 'packages/configurator/**'
      - 'packages/date-utils/**'
      - 'packages/email/**'
      - 'packages/email-templates/**'
      - 'packages/i18n/**'
      - 'packages/next-config/**'
      - 'packages/plugins/sanity/**'
      - 'packages/shared-utils/**'
      - 'packages/theme/**'
      - 'packages/telemetry/**'
      - 'packages/zod-utils/**'
      - 'packages/themes/**'
      - 'packages/ui/**'
      - 'packages/platform-core/**'
      - 'packages/lib/**'
      - 'packages/types/**'
      - 'packages/tailwind-config/**'
      - 'packages/design-tokens/**'
      - '.github/workflows/cms.yml'
  pull_request:
    paths:
      - 'apps/cms/**'
      - 'packages/config/**'
      - 'packages/configurator/**'
      - 'packages/date-utils/**'
      - 'packages/email/**'
      - 'packages/email-templates/**'
      - 'packages/i18n/**'
      - 'packages/next-config/**'
      - 'packages/plugins/sanity/**'
      - 'packages/shared-utils/**'
      - 'packages/theme/**'
      - 'packages/telemetry/**'
      - 'packages/zod-utils/**'
      - 'packages/themes/**'
      - 'packages/ui/**'
      - 'packages/platform-core/**'
      - 'packages/lib/**'
      - 'packages/types/**'
      - 'packages/tailwind-config/**'
      - 'packages/design-tokens/**'
      - '.github/workflows/cms.yml'
  workflow_dispatch:

concurrency:
  group: cms-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-typecheck:
    name: Lint & typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Lint
        run: pnpm --filter @apps/cms lint
      - name: Typecheck
        run: pnpm --filter @apps/cms typecheck

  test:
    name: Test (shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Restore Jest/ts-jest caches
        uses: actions/cache@v4
        with:
          path: |
            .ts-jest
            node_modules/.cache/jest
            apps/cms/node_modules/.cache/jest
          key: cms-jest-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-${{ matrix.shard }}
          restore-keys: |
            cms-jest-cache-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}-
      - name: Run tests (shard ${{ matrix.shard }}/4)
        run: |
          pnpm exec jest --ci --runInBand --detectOpenHandles --passWithNoTests \
            --coverage --config apps/cms/jest.config.cjs \
            --shard=${{ matrix.shard }}/4
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cms-coverage-shard-${{ matrix.shard }}
          path: coverage/
          if-no-files-found: ignore

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint-typecheck, test]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}
      - name: Build
        run: pnpm --filter @apps/cms... build

  deploy:
    name: Deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: "${{ github.ref_name == 'staging' && 'staging' || 'production' }}"
      url: "${{ github.ref_name == 'staging' && 'https://staging.cms.pages.dev' || 'https://cms.pages.dev' }}"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      # ADMIN-04: Decrypt SOPS secrets before deploy
      - name: Decrypt secrets
        uses: ./.github/actions/decrypt-secrets
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}
          require-key: true
          require-file: true
          app-path: apps/cms
          environment: "${{ github.ref_name == 'staging' && 'preview' || 'production' }}"

      # ADMIN-05: Validate environment before deploy
      - name: Validate deploy environment
        run: |
          chmod +x scripts/validate-deploy-env.sh
          ./scripts/validate-deploy-env.sh
        shell: bash

      - name: Deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: cd apps/cms && pnpm exec next-on-pages deploy --project-name cms --branch ${{ github.ref_name }}
      - name: Post-Deploy Health Check
        run: |
          chmod +x scripts/post-deploy-health-check.sh
          ./scripts/post-deploy-health-check.sh cms ${{ github.ref_name == 'staging' && '--staging' || '' }}
        env:
          EXTRA_ROUTES: "/api/health"
          MAX_RETRIES: "10"
          RETRY_DELAY: "6"
