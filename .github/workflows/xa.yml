name: Deploy XA (Stealth Staging)

on:
  push:
    branches:
      - staging
    paths:
      - "apps/xa/**"
      - "packages/config/**"
      - "packages/design-system/**"
      - "packages/design-tokens/**"
      - "packages/i18n/**"
      - "packages/lib/**"
      - "packages/next-config/**"
      - "packages/platform-core/**"
      - "packages/telemetry/**"
      - "packages/theme/**"
      - "packages/types/**"
      - "packages/ui/**"
      - "packages/zod-utils/**"
      - "scripts/privacy/**"
      - ".github/workflows/xa.yml"
      - ".github/workflows/reusable-app.yml"
  pull_request:
    paths:
      - "apps/xa/**"
      - "packages/config/**"
      - "packages/design-system/**"
      - "packages/design-tokens/**"
      - "packages/i18n/**"
      - "packages/lib/**"
      - "packages/next-config/**"
      - "packages/platform-core/**"
      - "packages/telemetry/**"
      - "packages/theme/**"
      - "packages/types/**"
      - "packages/ui/**"
      - "packages/zod-utils/**"
      - "scripts/privacy/**"
      - ".github/workflows/xa.yml"
      - ".github/workflows/reusable-app.yml"
  workflow_dispatch: {}

concurrency:
  group: xa-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  staging:
    name: Deploy (staging)
    uses: ./.github/workflows/reusable-app.yml
    with:
      app-filter: "@apps/xa-c"
      build-cmd: >
        pnpm exec turbo run build --filter=@apps/xa-c^... &&
        cd apps/xa &&
        node scripts/build-xa.mjs &&
        pnpm exec opennextjs-cloudflare build &&
        cd ../.. &&
        node scripts/privacy/leakage-scan.mjs
      artifact-path: "apps/xa/.open-next"
      deploy_cmd: >
        cd apps/xa &&
        pnpm exec wrangler deploy
      deploy_enabled: ${{ (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') }}
      project-name: ${{ vars.XA_STAGING_PROJECT || 'xa-site' }}
      environment-name: "xa-staging"
      environment-url: ${{ format('https://{0}.{1}.workers.dev', vars.XA_STAGING_PROJECT || 'xa-site', vars.CF_ACCOUNT_SUBDOMAIN || 'peter-cowling1976') }}
      healthcheck-args: "--staging"
    secrets: inherit
