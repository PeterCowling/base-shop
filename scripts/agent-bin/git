#!/usr/bin/env bash
set -euo pipefail

# Agent git guard wrapper (argv-based).
#
# Policy is evaluated by a shared Node evaluator:
#   scripts/agents/evaluate-git-safety.mjs
#
# Canonical source: docs/git-safety.md (kernel fence)

wrapper_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
repo_root="${BASESHOP_GUARD_REPO_ROOT:-}"

if [[ -z "$repo_root" ]]; then
  # This script lives inside the repo; prefer a fast path over invoking git.
  repo_root="$(cd "${wrapper_dir}/../.." && pwd)"
fi

real_git=""
IFS=":" read -r -a path_entries <<< "${PATH:-}"
for dir in "${path_entries[@]}"; do
  [[ -z "$dir" ]] && continue
  if [[ "$(cd "$dir" 2>/dev/null && pwd)" == "$wrapper_dir" ]]; then
    continue
  fi
  if [[ -x "${dir}/git" ]]; then
    real_git="${dir}/git"
    break
  fi
done

if [[ -z "$real_git" ]]; then
  echo "ERROR: unable to locate real git binary on PATH" >&2
  exit 127
fi

evaluator="${repo_root}/scripts/agents/evaluate-git-safety.mjs"
policy_json="${repo_root}/.agents/safety/generated/git-safety-policy.json"
if [[ ! -f "$evaluator" ]]; then
  echo "ERROR: missing evaluator: ${evaluator}" >&2
  exit 1
fi
if [[ ! -f "$policy_json" ]]; then
  echo "ERROR: missing policy: ${policy_json}" >&2
  exit 1
fi

set +e
node "$evaluator" --policy "$policy_json" -- "$@"
eval_status="$?"
set -e

if [[ "$eval_status" -ne 0 ]]; then
  exit "$eval_status"
fi

exec "$real_git" "$@"
