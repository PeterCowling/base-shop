#!/usr/bin/env bash
set -euo pipefail

# Agent safety wrapper for pnpm.
# Blocks broad test fan-out commands that can overwhelm local machines.

wrapper_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
real_pnpm=""

IFS=":" read -r -a path_entries <<< "${PATH:-}"
for dir in "${path_entries[@]}"; do
  [[ -z "$dir" ]] && continue
  if [[ "$(cd "$dir" 2>/dev/null && pwd)" == "$wrapper_dir" ]]; then
    continue
  fi
  if [[ -x "${dir}/pnpm" ]]; then
    real_pnpm="${dir}/pnpm"
    break
  fi
done

if [[ -z "$real_pnpm" ]]; then
  echo "ERROR: unable to locate real pnpm binary on PATH" >&2
  exit 127
fi

deny() {
  local why="$1"
  shift

  echo "------------------------------------------------------------------" >&2
  echo "BLOCKED: pnpm command guard" >&2
  echo "------------------------------------------------------------------" >&2
  echo "" >&2
  echo "Reason: ${why}" >&2
  echo "" >&2
  echo "Command:" >&2
  printf "  pnpm" >&2
  for arg in "$@"; do
    printf " %q" "$arg" >&2
  done
  echo "" >&2
  echo "" >&2
  echo "Safer alternatives:" >&2
  echo "  - Targeted file test: pnpm --filter <pkg> test -- path/to/file.test.ts" >&2
  echo "  - Affected tests: pnpm test:affected" >&2
  echo "  - Intentional full run: BASESHOP_ALLOW_BROAD_TESTS=1 pnpm test:all" >&2
  echo "" >&2
  exit 1
}

if [[ "${BASESHOP_ALLOW_BROAD_TESTS:-}" == "1" ]]; then
  exec "$real_pnpm" "$@"
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
effective_dir="$PWD"
has_filter="0"
has_recursive="0"
has_turbo_scope="0"
is_pnpm_test="0"
is_turbo_test="0"

for ((i=1; i<=$#; i++)); do
  arg="${!i}"
  case "$arg" in
    --filter|-F|--filter=*|-F=*)
      has_filter="1"
      has_turbo_scope="1"
      ;;
    -r|--recursive)
      has_recursive="1"
      ;;
    --affected|--only)
      has_turbo_scope="1"
      ;;
    -C|--dir)
      next_i=$((i+1))
      if [[ $next_i -le $# ]]; then
        effective_dir="${!next_i}"
      fi
      ;;
    --dir=*)
      effective_dir="${arg#--dir=}"
      ;;
    -w|--workspace-root)
      effective_dir="$repo_root"
      ;;
  esac
done

for ((i=1; i<=$#; i++)); do
  arg="${!i}"
  if [[ "$arg" == "test" || "$arg" == "t" ]]; then
    is_pnpm_test="1"
  fi
  if [[ "$arg" == "run" ]]; then
    next_i=$((i+1))
    if [[ $next_i -le $# ]]; then
      next_arg="${!next_i}"
      if [[ "$next_arg" == "test" || "$next_arg" == "t" ]]; then
        is_pnpm_test="1"
      fi
    fi
  fi
  if [[ "$arg" == "exec" ]]; then
    next_i=$((i+1))
    next2_i=$((i+2))
    next3_i=$((i+3))
    if [[ $next3_i -le $# ]]; then
      next_arg="${!next_i}"
      next2_arg="${!next2_i}"
      next3_arg="${!next3_i}"
      if [[ "$next_arg" == "turbo" && "$next2_arg" == "run" && "$next3_arg" == "test" ]]; then
        is_turbo_test="1"
      fi
    fi
  fi
done

is_workspace_root="0"
if [[ -f "${effective_dir%/}/pnpm-workspace.yaml" ]]; then
  is_workspace_root="1"
fi

is_turbo_test_script="0"
pkg_json="${effective_dir%/}/package.json"
if [[ -f "$pkg_json" ]]; then
  if node -e '
const fs = require("fs");
const file = process.argv[1];
try {
  const parsed = JSON.parse(fs.readFileSync(file, "utf8"));
  const testScript = parsed?.scripts?.test;
  if (typeof testScript === "string" && /\bturbo\s+run\s+test\b/.test(testScript)) {
    process.exit(0);
  }
} catch {}
process.exit(1);
' "$pkg_json" >/dev/null 2>&1; then
    is_turbo_test_script="1"
  fi
fi

if [[ "$is_turbo_test" == "1" && "$has_turbo_scope" == "0" ]]; then
  deny "Unscoped 'turbo run test' fans out across many packages and can overwhelm the machine." "$@"
fi

if [[ "$is_pnpm_test" == "1" ]]; then
  if [[ "$has_recursive" == "1" && "$has_filter" == "0" ]]; then
    deny "Recursive test runs without filters can spawn too many concurrent workers." "$@"
  fi
  if [[ "$has_filter" == "0" && "$is_workspace_root" == "1" && "$is_turbo_test" == "0" ]]; then
    deny "Workspace-root 'pnpm test' is disabled to prevent monorepo test fan-out." "$@"
  fi
  if [[ "$has_filter" == "0" && "$is_turbo_test_script" == "1" ]]; then
    deny "Unscoped 'pnpm test' runs a turbo fan-out test script. Use test:affected or filtered tests." "$@"
  fi
fi

exec "$real_pnpm" "$@"
