# Shop editor refactor research

## Current data flow and error handling

### Identity and core settings
- `ShopEditor` bootstraps the view by invoking `useShopEditorForm`, exposing the `info` object (full `Shop` record), setters, error map, derived token rows, override row controllers, provider lists, and the submit handler for the form render.【F:apps/cms/src/app/cms/shop/[shop]/settings/ShopEditor.tsx†L25-L97】【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorForm.ts†L19-L77】
- Text inputs for `name` and `themeId` share a `handleChange` helper that writes directly into `info`, while most luxury feature toggles call `setInfo` with nested copies of `luxuryFeatures`. Error strings from the shared `errors` map drive `aria-invalid` attributes and inline alerts next to each control.【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorForm.ts†L49-L52】【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L14-L169】

### Provider selection
- Tracking providers are kept in a dedicated state array managed by `useShopEditorForm`. The `ProviderSelect` component renders a native multi-select whose change handler converts the chosen `<option>` elements into values stored through `setTrackingProviders`. Validation errors targeting the `trackingProviders` key display beneath the field.【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorForm.ts†L24-L59】【F:apps/cms/src/app/cms/shop/[shop]/settings/ProviderSelect.tsx†L13-L45】

### Localization and override editing
- `useMappingRows` normalizes initial `filterMappings`, `priceOverrides`, and `localeOverrides` objects into editable `{ key, value }` rows and surfaces `add`, `update`, and `remove` helpers that each service editor consumes for repeatable list management.【F:apps/cms/src/hooks/useMappingRows.ts†L8-L26】
- The `FilterMappings`, `PriceOverrides`, and `LocaleOverrides` components render paired text inputs (plus a locale `<select>` for the latter) that are wired to the row controllers. Each section surfaces its own inline error message based on the `errors` map provided by the submit hook.【F:apps/cms/src/app/cms/shop/[shop]/settings/FilterMappings.tsx†L19-L60】【F:apps/cms/src/app/cms/shop/[shop]/settings/PriceOverrides.tsx†L19-L62】【F:apps/cms/src/app/cms/shop/[shop]/settings/LocaleOverrides.tsx†L19-L65】
- `useShopEditorSubmit` enforces local validation before the network call: filter mappings must have trimmed key/value pairs, price overrides require numeric values, and locale overrides must match an `allowedLocales` list of `en`, `de`, or `it`. Failures populate `validationErrors` that feed the shared `errors` state and abort submission.【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorSubmit.ts†L46-L78】

### Theme token management
- `useShopEditorForm` derives `tokenRows` by diffing `themeDefaults` and `themeOverrides` through `mapThemeTokenRows`, which calculates override status and change flags for display.【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorForm.ts†L44-L47】【F:apps/cms/src/app/cms/shop/[shop]/settings/lib/pageSections.ts†L102-L132】
- The `ThemeTokens` panel renders a `DataTable` from `@ui` with those rows, offers a reset action via a server action form, and serializes `themeDefaults`/`themeOverrides` back into hidden inputs to keep the data in sync with form submission. Errors targeting the JSON blobs appear inline.【F:apps/cms/src/app/cms/shop/[shop]/settings/ThemeTokens.tsx†L22-L85】

### Submission lifecycle and error propagation
- `useShopEditorSubmit` trims row data into plain objects (`buildStringMapping`/`buildNumberMapping`), filters duplicate FormData entries for the repeating field names, and constructs a payload that is validated with `shopSchema.safeParse`. Zod failures are flattened into the shared `errors` map. On success, `updateShop` receives the original `FormData` and the response is used to refresh `info`, provider selections, and the three mapping controllers before clearing errors and flipping `saving` false.【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorSubmit.ts†L12-L137】
- Inline spans remain the only surfaced error UI today. There is no global success or failure toast; the `Save` button simply reflects the `saving` state by disabling while requests are in flight.【F:apps/cms/src/app/cms/shop/[shop]/settings/ShopEditor.tsx†L52-L95】

## Helper validation rules and supporting transforms
- `shopSchema` (CMS layer) requires `name` and `themeId`, normalizes `catalogFilters` strings into trimmed arrays, coerces all boolean toggles from `"on"`, ensures `fraudReviewThreshold` becomes a number, and parses JSON blobs for theme data and the three override maps. The final `.transform` nests the luxury feature booleans under `luxuryFeatures` for consumer parity.【F:apps/cms/src/actions/schemas.ts†L39-L119】
- The locale shortlist baked into `useShopEditorSubmit` matches the global `LOCALES` constant exported by `@acme/types` (`en`, `de`, `it`).【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorSubmit.ts†L50-L72】【F:packages/types/src/constants.ts†L1-L2】
- `useMappingRows` converts initial records to editable arrays and exposes imperative row mutators, which the submit hook later rehydrates from the server response.【F:apps/cms/src/hooks/useMappingRows.ts†L8-L26】【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorSubmit.ts†L117-L134】
- `mapThemeTokenRows` ensures deterministic sorting, override detection, and change highlighting for the theme token grid, while `createThemeTokenColumns` supplies the reset slot used in the UI.【F:apps/cms/src/app/cms/shop/[shop]/settings/lib/pageSections.ts†L102-L132】【F:apps/cms/src/app/cms/shop/[shop]/settings/tableMappers.tsx†L23-L102】
- `@cms/actions/shops.server` simply forwards `updateShop` and related helpers to the service layer without additional validation or transformation, so all client-side shaping must occur before invoking it.【F:apps/cms/src/actions/shops.server.ts†L5-L100】

## Form control inventory and preferred `@ui` replacements
| Location & field | Current control | Role today | Recommended `@ui` components | Notes |
| --- | --- | --- | --- | --- |
| ShopEditor hidden id | `Input type="hidden"` | Preserve shop identifier for submission | Native `<input type="hidden">` (no change) | Can remain outside `FormField` because it is not user-facing.【F:apps/cms/src/app/cms/shop/[shop]/settings/ShopEditor.tsx†L52-L58】 |
| General → Name | `Input` + `<label>` wrapper | Edit display name with inline error text | `FormField` + `Input` with built-in error slot | `FormField` would remove manual `aria-invalid` logic.【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L22-L36】 |
| General → Theme | `Input` + `<label>` wrapper | Set theme id | `FormField` + `Input` | Mirror Name field structure.【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L37-L51】 |
| General → Luxury feature toggles | `Checkbox` inside flex labels | Toggle booleans in `luxuryFeatures` | `FormField` (or `Fieldset` helper) + `Checkbox` | Replace manual span labels with `FormField` legend & description.【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L52-L168】 |
| General → Fraud review threshold | `Input type="number"` | Numeric threshold for fraud review | `FormField` + `Input` with `type="number"` | Could surface validation feedback via `FormField` error prop.【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L103-L119】 |
| SEO → Catalog filters | `Input` + inline span | Accept comma-delimited filters | `FormField` + `Input` | Potential helper text about comma separation fits `FormField` description slot.【F:apps/cms/src/app/cms/shop/[shop]/settings/SEOSettings.tsx†L21-L35】 |
| Provider select | Native `<select multiple>` | Choose tracking providers | Command-based multi-select built from `@ui` `Select`/`Checkbox` with `Chip` summary | Needs a multi-select pattern; chips can surface chosen providers above the trigger.【F:apps/cms/src/app/cms/shop/[shop]/settings/ProviderSelect.tsx†L24-L45】 |
| Filter mappings rows | Two `Input`s + `Button` per row | Map storefront filters to internal keys | `FormField` per row + `Input` pair; `Button` variant="ghost" for remove | Consider `DataTable` or `Repeater` pattern for consistency.【F:apps/cms/src/app/cms/shop/[shop]/settings/FilterMappings.tsx†L27-L55】 |
| Price overrides rows | `Input` (text + number) + `Button` | Override localized pricing | `FormField` per row with `Input` fields; `Button` variants for add/remove | Numeric field could use `Input` with suffix slot if needed.【F:apps/cms/src/app/cms/shop/[shop]/settings/PriceOverrides.tsx†L27-L56】 |
| Locale overrides rows | `Input` + native `<select>` + `Button` | Redirect localized content keys | `FormField` + `Input`; `Select` from `@ui` for locale options; chips for selected locales if multi | Replace hard-coded options with `SelectItem`s bound to LOCALES constant.【F:apps/cms/src/app/cms/shop/[shop]/settings/LocaleOverrides.tsx†L27-L59】 |
| Theme tokens table | `DataTable` + `Button` reset | Inspect and reset theme overrides | Existing `DataTable` (already from `@ui`) + `Button` variant="ghost" | Could wrap reset confirmation in `Dialog` if needed.【F:apps/cms/src/app/cms/shop/[shop]/settings/ThemeTokens.tsx†L22-L63】 |
| Add/remove row actions | `Button` components | Append/remove list items | `Button` with semantic variants (`secondary`, `ghost`, `destructive`) | Aligns with design system tokens for tone.【F:apps/cms/src/app/cms/shop/[shop]/settings/FilterMappings.tsx†L47-L54】【F:apps/cms/src/app/cms/shop/[shop]/settings/PriceOverrides.tsx†L47-L55】【F:apps/cms/src/app/cms/shop/[shop]/settings/LocaleOverrides.tsx†L52-L58】 |
| Form submission | `Button` Save | Submit entire form; disabled while saving | `Button` with loading state + `Toast` for success/error | Add `Toast` feedback triggered from submit hook for consistent messaging.【F:apps/cms/src/app/cms/shop/[shop]/settings/ShopEditor.tsx†L52-L95】 |
| Error feedback | Inline `<span>` text | Surface validation errors per field | `FormField` error slot + global `Toast` for server failures | Centralize error display logic and reduce manual markup.【F:apps/cms/src/app/cms/shop/[shop]/settings/GeneralSettings.tsx†L31-L35】【F:apps/cms/src/app/cms/shop/[shop]/settings/useShopEditorSubmit.ts†L74-L114】 |

## Open questions for refactor follow-up
- Should locale validation move to a shared utility that re-exports `LOCALES` to guarantee parity between client and schema layers?
- Do we want optimistic UI for mapping rows (e.g., disabling save until all rows validate), or keep server-side reconciliation via `setRows` after `updateShop` returns?
- Would centralizing submission through a `useForm` abstraction ease integration with `FormField`/`Toast`, or should we incrementally wrap each section?
