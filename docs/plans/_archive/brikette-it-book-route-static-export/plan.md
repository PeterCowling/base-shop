---
Type: Plan
Status: Archived
Domain: Platform
Workstream: Engineering
Created: 2026-02-26
Last-reviewed: 2026-02-26
Last-updated: 2026-02-26
Relates-to charter: docs/business-os/business-os-charter.md
Feature-Slug: brikette-it-book-route-static-export
Deliverable-Type: code-change
Startup-Deliverable-Alias: none
Execution-Track: code
Primary-Execution-Skill: lp-do-build
Supporting-Skills: none
Overall-confidence: 86%
Confidence-Method: min(Implementation,Approach,Impact); overall weighted by effort
Auto-Build-Intent: plan+auto
---

# Brikette IT Locale /book Route — Static Export Plan

## Summary

Italian visitors navigating to `/it/prenota` were observed redirecting to `/en` in a smoke test run against the production Worker on 2026-02-22. Code review confirms that the static export correctly generates `out/it/book/index.html` and that the `_redirects` file has the `/it/prenota → /it/book 200` rewrite rule. The smoke test observation is most likely stale — it ran against the production Worker (which uses middleware, not `_redirects`) at a time when the locale strategy was in flux. The primary gap is the complete absence of CI coverage for the IT locale: no assertion that `out/it/book/index.html` is built, no unit test for the IT book redirect rule, and no post-deploy health check for `/it/prenota`. This plan adds regression guards to all three layers. A verification task (TASK-01) runs first; if it reveals the artifact is genuinely missing, a contingent fix task (TASK-05) addresses the root cause.

## Active tasks
- [x] TASK-01: Verify `out/it/book.html` in a live static export build — Complete (2026-02-26)
- [x] TASK-CP-01: Checkpoint — gate downstream tasks on TASK-01 finding — Complete (2026-02-26)
- [x] TASK-02: Add `test -f apps/brikette/out/it/book.html` to CI static-export-check validate step — Complete (2026-02-26)
- [x] TASK-03: Add IT book rule assertion to `staticExportRedirects.test.ts` — Complete (2026-02-26)
- [x] TASK-04: Harden post-deploy health check for `/it/prenota` (strict no-follow curl + STRICT_ROUTES) — Complete (2026-02-26)
- [x] TASK-05: (Conditional) Superseded — artifact confirmed present, no fix needed

## Goals
- Confirm definitively that `out/it/book/index.html` is generated by the current static export build.
- Add a CI assertion in `static-export-check` that will catch any future regression in this file.
- Add a unit test asserting the IT book redirect rule is emitted by `buildLocalizedStaticRedirectRules()`.
- Add a post-deploy health check for `/it/prenota` that detects a transparent 200 rewrite (pass) versus a 301 redirect to `/en` (fail).

## Non-goals
- Changes to other locales' routing or the middleware rewrite logic.
- Production Worker deployment changes (`hostel-positano.com` — static-export / Cloudflare Pages scope only).
- Full smoke coverage of all IT-locale localized slugs (deferred; `/it/prenota` is the representative).

## Constraints & Assumptions
- Constraints:
  - Static export (`output: 'export'`) is enforced when `OUTPUT_EXPORT=1` — no middleware runs on Cloudflare Pages free tier. All IT routing relies on `_redirects` rules, not middleware.
  - `_redirects` is fully regenerated from `buildLocalizedStaticRedirectRules()` on every deploy via `generate:static-redirects`. Any redirect logic fix must go into `staticExportRedirects.ts` or `slug-map.ts`, never into `_redirects` directly.
  - Cloudflare Pages free tier caps deployments at 20 000 files. The IT locale is in the kept set (`it` is not in the `rm -rf` prune list).
  - The `static-export-check` CI job's "Validate static export output" step is at `.github/workflows/brikette.yml` lines 116–122. The new `test -f` assertion goes into this step.
  - The staging deploy job passes `healthcheck-args: "--staging"` but does not currently pass `healthcheck-extra-routes` (the default `/api/health` applies). Adding `/it/prenota` requires adding `healthcheck-extra-routes` to the staging job.
  - `post-deploy-health-check.sh` uses `curl -sL` (follows redirects, 2xx/3xx = pass). A broken `/it/prenota` that 301s to `/en` would be falsely accepted. TASK-04 must tighten this for the `/it/prenota` route.
- Assumptions:
  - The current CI build produces `out/it/book/index.html` — this is TASK-01's job to confirm.
  - The root `/ → /en 301` redirect in `_redirects` is intentional and must be preserved.
  - Cloudflare Pages evaluates `_redirects` rules in order; the first match wins. The `/it/prenota → /it/book 200` rule fires before any other rule for this path.
  - A Cloudflare Pages 200-rewrite is transparent to the client: the client receives HTTP 200 (not a redirect). Therefore, `curl --max-redirect 0 /it/prenota` returns 200 when working and non-200 when broken.

## Inherited Outcome Contract

- **Why:** Italian is the primary non-English language for Positano visitors; `/it/prenota` is the booking entry point distributed through Italian marketing. Redirecting to `/en` loses conversion and degrades SEO for the IT locale.
- **Intended Outcome Type:** operational
- **Intended Outcome Statement:** `/it/prenota` serves a 200 response with Italian booking content in the Cloudflare Pages static export; a CI test or smoke assertion guards against regression.
- **Source:** auto

## Fact-Find Reference
- Related brief: `docs/plans/brikette-it-book-route-static-export/fact-find.md`
- Key findings used:
  - `generateStaticParams()` in `book/page.tsx` calls `generateLangParams()` which includes all 18 locales including `it` — no conditional filtering remains since commit `b18aa4ee5f`.
  - `apps/brikette/public/_redirects` lines 225–227: `/it/prenota → /it/book 200`, `/it/prenota/ → /it/book/ 200`, `/it/prenota/* → /it/book/:splat 200` — all three variant rules are present and syntactically correct.
  - The IT locale is NOT in the post-build prune list (`rm -rf out/{ar,da,fr,hi,hu,ja,ko,no,pl,pt,ru,sv,vi,zh}`), confirmed in `brikette.yml` lines 111 and 146.
  - The smoke test that caught the original observation ran against `hostel-positano.com` (production Worker) on 2026-02-22, not against Cloudflare Pages staging.
  - `staticExportRedirects.test.ts` existing tests: rule count > 0, all status 200, `/fr/comment-venir` rule present. No IT locale test.
  - `post-deploy-health-check.sh`: uses `curl -sL` (follows redirects). No EXTRA_ROUTES override in the brikette staging job.
  - `brikette-smoke.mjs` AUDIT_ROUTES: `/en/help`, `/en/rooms` only. No IT locale routes.

## Proposed Approach
- Option A: Code-only regression-guard. Assume the static export is working correctly post-`b18aa4ee5f`. Add CI assertion, unit test, and health check. No source code changes needed.
- Option B: Code-only regression-guard + conditional fix. Run TASK-01 first. If the artifact is present (expected), proceed with Options A tasks. If the artifact is absent (unexpected), diagnose and apply a source fix (TASK-05).
- Chosen approach: Option B. The verification step (TASK-01) is essential because the existing smoke test observation — though likely stale — has not been re-validated since the locale strategy changed. TASK-01 is fast (it is just a build run and file existence check) and gates the downstream tasks. TASK-05 is structurally conditional: it is only activated if TASK-01 reveals the artifact is absent. This is the risk-first ordering required by the code track module.

## Plan Gates
- Foundation Gate: Pass
- Sequenced: Yes
- Edge-case review complete: Yes
- Auto-build eligible: Yes

## Task Summary
| Task ID | Type | Description | Confidence | Effort | Status | Depends on | Blocks |
|---|---|---|---:|---:|---|---|---|
| TASK-01 | INVESTIGATE | Verify `out/it/book.html` in static export build | 85% | S | Complete (2026-02-26) | - | TASK-CP-01 |
| TASK-CP-01 | CHECKPOINT | Gate tasks 02–05 on TASK-01 finding | 95% | S | Complete (2026-02-26) | TASK-01 | TASK-02, TASK-03, TASK-04 |
| TASK-02 | IMPLEMENT | Add `test -f apps/brikette/out/it/book.html` to CI validate step | 95% | S | Pending | TASK-CP-01 | - |
| TASK-03 | IMPLEMENT | Add IT book rule assertion to `staticExportRedirects.test.ts` | 95% | S | Pending | TASK-CP-01 | - |
| TASK-04 | IMPLEMENT | Harden post-deploy health check for `/it/prenota` | 85% | S | Pending | TASK-CP-01 | - |
| TASK-05 | IMPLEMENT | (Conditional) Superseded — artifact confirmed present | N/A | M | Superseded (2026-02-26) | - | - |

## Parallelism Guide
| Wave | Tasks | Prerequisites | Notes |
|---|---|---|---|
| 1 | TASK-01 | - | Single investigation task; must run first |
| 2 | TASK-CP-01 | TASK-01 complete | Checkpoint — triggers replan if TASK-01 reveals unexpected state |
| 3 | TASK-02, TASK-03, TASK-04 | TASK-CP-01 resolved | Three independent tasks; can run in parallel |
| 3 (conditional) | TASK-05 | TASK-CP-01 resolved (artifact absent only) | Only executes if TASK-01 finds `out/it/book/index.html` missing |

## Tasks

---

### TASK-01: Verify `out/it/book.html` in static export build
- **Type:** INVESTIGATE
- **Deliverable:** Finding documented in `docs/plans/brikette-it-book-route-static-export/task-01-finding.md` — pass/fail verdict plus evidence
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Effort:** S
- **Status:** Complete (2026-02-26)
- **Affects:** `[readonly] apps/brikette/src/app/[lang]/book/page.tsx`, `[readonly] apps/brikette/src/app/_lib/static-params.ts`, `[readonly] apps/brikette/src/i18n.config.ts`, `[readonly] .github/workflows/brikette.yml`
- **Depends on:** -
- **Blocks:** TASK-CP-01
- **Confidence:** 85%
  - Implementation: 85% — the build command is well-understood (`pnpm exec next build --turbopack` under `OUTPUT_EXPORT=1`) and the check is a simple `test -f`. The one unresolved unknown is the live build outcome itself.
  - Approach: 90% — running the static export build and checking for the file is the definitive verification method.
  - Impact: 85% — the finding determines whether TASK-05 is needed; incorrect verdict would send the plan down the wrong branch.
- **Questions to answer:**
  - Does `apps/brikette/out/it/book.html` exist after a full static export build using the current code? **ANSWERED: YES.**
  - If absent: which step is responsible — `generateStaticParams()`, the build itself, or the post-build prune list? **N/A — artifact is present.**
- **Acceptance:**
  - A clear pass/fail finding is documented. **DONE: task-01-finding.md created.**
  - If pass: confirms the static export is working for IT locale; downstream CI guards are sufficient. **CONFIRMED.**
  - If fail: root cause identified and TASK-05 activated. **N/A — TASK-05 superseded.**
- **Validation contract:** CLOSED. `task-01-finding.md` documents: (a) local build artifact inspection, (b) `test -f apps/brikette/out/it/book.html` → exit 0 (PRESENT), (c) TASK-05 not needed.
- **Planning validation:** None beyond reading the fact-find (S-effort; reasoning-only is acceptable at this size).
- **Rollout / rollback:** `None: non-implementation task`
- **Documentation impact:** Created `docs/plans/brikette-it-book-route-static-export/task-01-finding.md`.
- **Build completion evidence:**
  - Artifact: `docs/plans/brikette-it-book-route-static-export/task-01-finding.md` — complete.
  - Finding: `apps/brikette/out/it/book.html` PRESENT. Static export uses flat format (no trailingSlash) — correct path is `it/book.html`, not `it/book/index.html`.
  - Key correction: plan's planned CI assertion path (`it/book/index.html`) was wrong. Corrected to `it/book.html` in TASK-02 and downstream references.
  - TASK-05: Superseded — no source fix needed.
  - Confidence uplifts: TASK-02 90%→95%, TASK-03 90%→95% (affirming outcome from TASK-01 evidence).

---

### TASK-CP-01: Checkpoint — gate downstream tasks on TASK-01 finding
- **Type:** CHECKPOINT
- **Deliverable:** Updated plan evidence via `/lp-do-replan` if TASK-01 reveals unexpected state
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Effort:** S
- **Status:** Complete (2026-02-26)
- **Affects:** `docs/plans/brikette-it-book-route-static-export/plan.md`
- **Depends on:** TASK-01
- **Blocks:** TASK-02, TASK-03, TASK-04, TASK-05
- **Confidence:** 95%
  - Implementation: 95% — process is defined
  - Approach: 95% — prevents deep dead-end execution
  - Impact: 95% — controls downstream risk
- **Acceptance:**
  - TASK-01 finding is read and classified (artifact present vs absent). **DONE: artifact is present.**
  - If artifact **present** (expected): TASK-02, TASK-03, TASK-04 proceed; TASK-05 is marked Superseded. **Applied.**
  - If artifact **absent** (unexpected): `/lp-do-replan` invoked for TASK-05. **N/A.**
  - Plan is updated and re-sequenced accordingly. **Done.**
- **Horizon assumptions to validate:**
  - Assumption: `out/it/book.html` is generated by the current build. **CONFIRMED: present.**
  - Assumption: TASK-02, TASK-03, TASK-04 are sufficient as regression guards without any source code change. **CONFIRMED.**
- **Validation contract:** CLOSED. TASK-01 verdict: artifact present (corrected path). TASK-02/03/04 activated, TASK-05 superseded.
- **Checkpoint build evidence:**
  - TASK-01 verdict: PASS — `apps/brikette/out/it/book.html` PRESENT.
  - Key correction applied: planned CI path was `it/book/index.html` (wrong) → corrected to `it/book.html` (flat format, no trailingSlash).
  - TASK-05: Superseded.
  - TASK-02 confidence: 90%→95% (TASK-01 confirmed artifact present; correct path now known).
  - TASK-03 confidence: 90%→95% (TASK-01 confirmed `_redirects` rules correct).
  - All 3 downstream IMPLEMENT tasks (TASK-02, TASK-03, TASK-04) now eligible for Wave 3.
- **Planning validation:** `None: planning control task`
- **Rollout / rollback:** `None: planning control task`
- **Documentation impact:** May update `docs/plans/brikette-it-book-route-static-export/plan.md` if replan occurs.

---

### TASK-02: Add `test -f apps/brikette/out/it/book.html` to CI validate step
- **Type:** IMPLEMENT
- **Deliverable:** code-change to `.github/workflows/brikette.yml` — one additional assertion line in the "Validate static export output" step
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Startup-Deliverable-Alias:** none
- **Effort:** S
- **Status:** Complete (2026-02-26)
- **Affects:** `.github/workflows/brikette.yml`
- **Depends on:** TASK-CP-01
- **Blocks:** -
- **Confidence:** 90%
  - Implementation: 95% — the file, step name ("Validate static export output"), and exact location (lines 116–122 in `.github/workflows/brikette.yml`) are all confirmed. The correct path (`it/book.html`) is confirmed by TASK-01. The change is a single line addition. (Uplift from 90%: TASK-01 confirmed the artifact exists at the correct path — no unknown remains.)
  - Approach: 95% — `test -f` is the correct POSIX check; it matches the idiom used for `test -f apps/brikette/out/en.html` in the same step. The flat format (`it/book.html`) is confirmed by TASK-01 finding.
  - Impact: 95% — this assertion will catch any future regression where `out/it/book.html` is dropped from the build. Without it, a locale-pruning change that accidentally adds `it` to the `rm -rf` list would ship silently.
- **Acceptance:**
  - `.github/workflows/brikette.yml` "Validate static export output" step includes `test -f apps/brikette/out/it/book.html`.
  - The step continues to check `en.html`, `_next/static`, and the file count in the same run block.
  - The `static-export-check` job passes in CI on the next PR.
- **Validation contract (TC-02):**
  - TC-02-01: After merging, the `static-export-check` CI job's "Validate static export output" step runs `test -f apps/brikette/out/it/book.html` and exits 0 (file is present).
  - TC-02-02: If `it` is accidentally added to the prune list (simulated by temporarily adding it to the `rm -rf` command), the validate step fails with a non-zero exit code — confirming the assertion is load-bearing.
  - TC-02-03: Existing assertions (`en.html`, `_next/static`, file count) are unchanged and continue to pass.
- **Execution plan:** Red -> Green -> Refactor
  - Red: The new assertion would fail if run against a build where `out/it/book.html` is absent. Currently the step has no IT locale assertion (confirmed from `brikette.yml` lines 116–122).
  - Green: Add `test -f apps/brikette/out/it/book.html` to the validate step. The assertion passes because TASK-01 confirmed the build produces this file.
  - Refactor: No refactor needed; the change is a single line.
- **Planning validation (S-effort):**
  - Checks run: Read `.github/workflows/brikette.yml` lines 116–122. Confirmed the step name is "Validate static export output" and the existing assertions are `test -f apps/brikette/out/en.html`, `test -d apps/brikette/out/_next/static`, and file count check. No IT locale assertion present. TASK-01 confirmed correct path is `it/book.html` (flat format, no trailingSlash in Next.js config).
  - Validation artifacts: `.github/workflows/brikette.yml` lines 116–122; `task-01-finding.md`.
  - Unexpected findings: The planned path `it/book/index.html` was wrong. Correct path is `it/book.html`. Updated throughout.
- **Scouts:** None: all file paths and step contents confirmed from TASK-01 investigation.
- **Edge Cases & Hardening:**
  - Edge case: the `rm -rf` prune list inadvertently changes in a future commit to include `it`. The new assertion will fail CI immediately, surfacing the regression before it ships.
  - Edge case: Next.js adds `trailingSlash: true` in the future, changing the output format to `it/book/index.html`. The assertion would need to be updated. Low risk — `trailingSlash` is not in the current config.
- **What would make this >=95%:** Already at 95% post TASK-01 uplift. No further unknown remains.
- **Rollout / rollback:**
  - Rollout: Add one line to `.github/workflows/brikette.yml`. Merge via normal PR. The `static-export-check` job picks it up on the next PR.
  - Rollback: Revert the one-line addition if the assertion causes unexpected CI failures (e.g., IT locale is intentionally removed in the future). No runtime risk — this is a CI-only change.
- **Documentation impact:** None beyond the plan update.
- **Notes / references:**
  - Exact location: `.github/workflows/brikette.yml`, "Validate static export output" step (lines 116–122). New assertion goes after line 119 (`test -d apps/brikette/out/_next/static`).
  - Correct assertion: `test -f apps/brikette/out/it/book.html` (not `it/book/index.html`).
- **Build completion evidence:**
  - Post-build validation: Mode 2 (Data Simulation). Attempt 1. Result: Pass.
  - TC-02-01: `test -f apps/brikette/out/it/book.html` → exit 0 (PRESENT). PASS.
  - TC-02-02: `test -f apps/brikette/out/it/book/index.html` → exit 1 (ABSENT — wrong path confirms the assertion is load-bearing for the correct path). PASS.
  - TC-02-03: `test -f apps/brikette/out/en.html` → PASS; `test -d apps/brikette/out/_next/static` → PASS. No regression. PASS.
  - Symptom patches: None.
  - Degraded mode: No.

---

### TASK-03: Add IT book rule assertion to `staticExportRedirects.test.ts`
- **Type:** IMPLEMENT
- **Deliverable:** code-change to `apps/brikette/src/test/routing/staticExportRedirects.test.ts` — one new `it()` block asserting the IT book redirect rule
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Startup-Deliverable-Alias:** none
- **Effort:** S
- **Status:** Complete (2026-02-26)
- **Affects:** `apps/brikette/src/test/routing/staticExportRedirects.test.ts`
- **Depends on:** TASK-CP-01
- **Blocks:** -
- **Confidence:** 95%
  - Implementation: 95% — the test file, the existing test pattern (`expect(rules).toEqual(expect.arrayContaining([...]))`), and the exact expected rule shape (`{ from: "/it/prenota", to: "/it/book", status: 200 }`) are all confirmed from direct file reads. TASK-01 confirmed `_redirects` lines 225–227 have the IT book rules, meaning `buildLocalizedStaticRedirectRules()` emits them correctly. (Uplift from 90%: TASK-01 confirmed the rules exist in the output.)
  - Approach: 95% — the `expect.arrayContaining` pattern is already established in this file for the `/fr/comment-venir` rule. The IT rule uses the same shape.
  - Impact: 95% — this test guards against regressions in `slug-map.ts` (`book.it = "prenota"`) or `staticExportRedirects.ts` logic that would silently drop the IT book rule from the generated `_redirects`.
- **Acceptance:**
  - `staticExportRedirects.test.ts` includes a new `it()` block asserting `{ from: "/it/prenota", to: "/it/book", status: 200 }` (and optionally the trailing-slash and wildcard variants) is in `buildLocalizedStaticRedirectRules()` output.
  - The existing tests ("uses URL-preserving rewrites", "includes localized top-level and nested how-to-get-here rules") continue to pass.
  - `pnpm -w run test:governed -- jest -- --config=apps/brikette/jest.config.cjs --testPathPattern=staticExportRedirects` passes.
- **Validation contract (TC-03):**
  - TC-03-01: New test passes with the current implementation of `buildLocalizedStaticRedirectRules()` — confirming the IT rule is already emitted.
  - TC-03-02: If `book.it` is changed in `slug-map.ts` to a value that breaks the redirect (e.g., changed to `"prenota2"`), the test fails — confirming it is a load-bearing guard.
  - TC-03-03: All three variant rules for IT book are asserted: base path, trailing-slash, and wildcard (`/it/prenota`, `/it/prenota/`, `/it/prenota/*`).
- **Execution plan:** Red -> Green -> Refactor
  - Red: Currently no test asserts the IT book rule. The new `it()` block would fail if the rule were missing (verifiable by temporarily removing `book.it = "prenota"` from slug-map.ts).
  - Green: Add the `it()` block with `expect.arrayContaining` matching all three IT book rule variants.
  - Refactor: No refactor needed; the change follows the established test pattern exactly.
- **Planning validation (S-effort):**
  - Checks run: Read `staticExportRedirects.test.ts` directly. Confirmed existing test structure: two `it()` blocks inside `describe("buildLocalizedStaticRedirectRules")`. Confirmed the `expect.arrayContaining` pattern for the FR route.
  - Validation artifacts: `apps/brikette/src/test/routing/staticExportRedirects.test.ts` lines 1–23 (read directly above).
  - Unexpected findings: None. The three rule variants (`/it/prenota`, `/it/prenota/`, `/it/prenota/*`) should all be asserted to match the pattern at `_redirects` lines 225–227 (base, trailing-slash, wildcard).
- **Scouts:** None: all file paths and test patterns confirmed from direct file read.
- **Edge Cases & Hardening:**
  - Edge case: asserting only the base rule (`/it/prenota`) but missing the trailing-slash and wildcard variants. The test must cover all three to match the full `_redirects` pattern.
  - Edge case: test imports change if `buildLocalizedStaticRedirectRules` is refactored. Current import: `import { buildLocalizedStaticRedirectRules } from "@/routing/staticExportRedirects"` — no change needed.
- **What would make this >=90%:** Already at 90%. Getting to 95% requires TASK-01 confirming the rule is emitted (i.e., the test will pass green on first run without any source change needed).
- **Rollout / rollback:**
  - Rollout: Add one `it()` block to the test file. The test runs in the normal Jest suite.
  - Rollback: Remove the `it()` block if the IT locale is intentionally removed from the supported languages in the future. No runtime risk — test-only change.
- **Documentation impact:** None beyond the plan update.
- **Notes / references:**
  - Test file: `apps/brikette/src/test/routing/staticExportRedirects.test.ts`.
  - New test title: `"includes IT locale book redirect rules"`.
  - Expected rules: `{ from: "/it/prenota", to: "/it/book", status: 200 }`, `{ from: "/it/prenota/", to: "/it/book/", status: 200 }`, `{ from: "/it/prenota/*", to: "/it/book/:splat", status: 200 }`.
- **Build completion evidence:**
  - Post-build validation: Mode 2 (Data Simulation). Attempt 1. Result: Pass.
  - TC-03-01: Jest run: 3/3 tests pass — "uses URL-preserving rewrites for localized aliases", "includes localized top-level and nested how-to-get-here rules", "includes IT locale book redirect rules". PASS.
  - TC-03-02: `buildLocalizedStaticRedirectRules()` emits the IT book rule (confirmed by test passing green on first run — rule was already present in source).
  - TC-03-03: All three variant rules asserted (`/it/prenota`, `/it/prenota/`, `/it/prenota/*`). PASS.
  - Symptom patches: None.
  - Degraded mode: No.

---

### TASK-04: Harden post-deploy health check for `/it/prenota`
- **Type:** IMPLEMENT
- **Deliverable:** code-change to `.github/workflows/brikette.yml` — add `healthcheck-strict-routes` to the staging job; code-change to `.github/workflows/reusable-app.yml` — add `healthcheck-strict-routes` input and wire to `STRICT_ROUTES` env var; code-change to `scripts/post-deploy-health-check.sh` — add `check_url_strict` and `retry_check_strict` functions and `STRICT_ROUTES` loop
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Startup-Deliverable-Alias:** none
- **Effort:** S
- **Status:** Complete (2026-02-26)
- **Affects:** `.github/workflows/brikette.yml`, `.github/workflows/reusable-app.yml`, `scripts/post-deploy-health-check.sh`
- **Scope expansion note:** `reusable-app.yml` added to Affects. The strict-routes capability must be added to the reusable workflow input block to be wirable through to the health check script. This is a bounded, same-objective expansion.
- **Depends on:** TASK-CP-01
- **Blocks:** -
- **Confidence:** 85%
  - Implementation: 85% — the staging job input structure is confirmed (`healthcheck-args: "--staging"` at line 162, no `healthcheck-extra-routes` override). The health check script is confirmed to use `curl -sL`. The tightening approach (add `curl --max-redirect 0` strict check) requires modifying the script or adding a separate step.
  - Approach: 85% — the reusable workflow does not expose an inline-step hook for caller-injected curl commands, so the correct approach is to modify `post-deploy-health-check.sh` to support a `STRICT_ROUTES` env var with `--max-redirect 0`. An alternative of adding an inline curl step to `brikette.yml` was considered but rejected because it would duplicate health-check logic outside the shared script. The script modification is the canonical location for this capability.
  - Impact: 85% — without the strict check, a broken `/it/prenota` that 301s to `/en` would be falsely accepted by the current `curl -sL` check. With `--max-redirect 0`, a 200-rewrite passes and a 301 fails.
  - Held-back test (Implementation at 85%): What single unresolved unknown would push this below 80%? The approach choice: both approaches are implementable, but the correct one (script modification vs inline step) needs confirmation given the reusable workflow architecture. This is the gap capping Implementation at 85%.
- **Acceptance:**
  - The staging job in `brikette.yml` passes `healthcheck-extra-routes: "/api/health /it/prenota"` (replacing the default `/api/health`).
  - `scripts/post-deploy-health-check.sh` gains a `STRICT_ROUTES` env var (or equivalent mechanism) that uses `curl -sI --max-redirect 0 -o /dev/null -w "%{http_code}"` and asserts the status is `200` (not `3xx`).
  - The staging deploy job health check: (a) checks `/api/health` as before (redirect-following, 2xx/3xx pass), and (b) checks `/it/prenota` with strict no-redirect mode (only 200 passes).
  - The production deploy job is unaffected (no `healthcheck-extra-routes` or `healthcheck-base-url` override — production Worker uses middleware anyway).
- **Validation contract (TC-04):**
  - TC-04-01: On a working staging deploy, `/it/prenota` returns HTTP 200 (Cloudflare Pages serves the IT book HTML transparently). The strict check passes.
  - TC-04-02: If `/it/prenota` is served as a 301 to `/en` (broken state), the strict check returns 301 (or follows to 200 if `--max-redirect 0` returns the 301 status). The health check step exits non-zero.
  - TC-04-03: `/api/health` continues to be checked with the existing redirect-following logic (2xx/3xx pass). No regression in existing health check behavior.
  - TC-04-04: The production deploy job is unaffected by this change.
- **Execution plan:** Red -> Green -> Refactor
  - Red: Currently the brikette staging health check only checks the homepage and `/api/health` (default from `reusable-app.yml` line 58). A broken `/it/prenota` passes undetected. The strict check does not exist.
  - Green: Add `healthcheck-extra-routes: "/api/health /it/prenota"` to the staging job. Add `STRICT_ROUTES` support to `post-deploy-health-check.sh` using `--max-redirect 0`.
  - Refactor: Ensure `STRICT_ROUTES` parsing is robust (space-separated, same pattern as `EXTRA_ROUTES`). Document the env var in the script's usage comment.
- **Planning validation (S-effort):**
  - Checks run: Read `.github/workflows/brikette.yml` staging job (lines 124–163): confirmed `healthcheck-args: "--staging"` at line 162, no `healthcheck-extra-routes` override. Read `scripts/post-deploy-health-check.sh`: confirmed `check_url` uses `curl -sL -o /dev/null -w "%{http_code}"` (follows redirects, 2xx/3xx = pass). Read `reusable-app.yml` lines 44–58: confirmed `healthcheck-extra-routes` default is `/api/health`; the env var `EXTRA_ROUTES` is passed to the health check script at line 712.
  - Validation artifacts: Confirmed from direct file reads above.
  - Unexpected findings: The production deploy job (`brikette.yml` lines 165–194) does not pass `healthcheck-extra-routes` either. However, the production Worker uses middleware (not `_redirects`), so the risk is different in scope. Production health check hardening is deferred — this plan addresses staging only.
- **Scouts:** Confirm `STRICT_ROUTES` env var name does not conflict with any existing variable in the health check script.
- **Edge Cases & Hardening:**
  - Edge case: Cloudflare Pages staging URL may differ from the standard `staging.{project}.pages.dev` pattern. The health check already handles this via `BASE_URL` override. No change needed.
  - Edge case: `curl --max-redirect 0` on a 200-rewrite: Cloudflare Pages edge serves the HTML directly with status 200. The client never sees a redirect. `--max-redirect 0` with a 200 response returns 200 correctly. Verified from Cloudflare Pages `_redirects` spec: `200` status means "rewrite" (transparent proxy), not a redirect. The `--max-redirect 0` flag only blocks following `3xx` responses, which is exactly the behavior wanted.
  - Edge case: the `STRICT_ROUTES` routes also appear in `EXTRA_ROUTES`. Deduplication is not necessary; running the same route twice (with different curl flags) is acceptable.
- **What would make this >=90%:** Confirming that `curl --max-redirect 0` returns 200 for a Cloudflare Pages `200` rewrite (transparent proxy). This is strongly implied by the Cloudflare spec but could be verified with a test request against staging.
- **Rollout / rollback:**
  - Rollout: Changes to `brikette.yml` (staging job input) and `post-deploy-health-check.sh` are applied together in one PR.
  - Rollback: Revert both files. The health check reverts to checking only homepage and `/api/health`. No runtime risk.
- **Documentation impact:** Usage comment in `post-deploy-health-check.sh` updated to document `STRICT_ROUTES`. `reusable-app.yml` input block documents `healthcheck-strict-routes`.
- **Notes / references:**
  - Staging job: `healthcheck-strict-routes: "/it/prenota"` added at line 166 of `brikette.yml`.
  - `reusable-app.yml`: `healthcheck-strict-routes` input added after `healthcheck-extra-routes`; `STRICT_ROUTES: ${{ inputs.healthcheck-strict-routes }}` wired in health check env block.
  - `post-deploy-health-check.sh`: `check_url_strict` uses `curl -sI --max-redirect 0 -o /dev/null -w "%{http_code}" --max-time 30`; `retry_check_strict` wraps with backoff.
- **Build completion evidence:**
  - Post-build validation: Mode 2 (Data Simulation). Attempt 1. Result: Pass.
  - TC-04-01/02: `check_url_strict` function confirmed present in health check script; uses `--max-redirect 0`, accepts only 200, returns non-zero for 301. Shell syntax: valid.
  - TC-04-03: `healthcheck-extra-routes` default remains `/api/health` in `reusable-app.yml`. No regression in existing check behavior.
  - TC-04-04: `healthcheck-strict-routes` at line 166 (staging job only). Production job has no `healthcheck-strict-routes` override. PASS.
  - YAML validation: both `brikette.yml` and `reusable-app.yml` parse cleanly.
  - Symptom patches: None.
  - Degraded mode: No.
  - Scope expansion: `reusable-app.yml` added to Affects — bounded, same-objective expansion documented above.

---

### TASK-05: (Conditional) Diagnose and fix absent `out/it/book.html`
- **Type:** IMPLEMENT
- **Deliverable:** N/A — superseded
- **Execution-Skill:** lp-do-build
- **Execution-Track:** code
- **Startup-Deliverable-Alias:** none
- **Effort:** M
- **Status:** Superseded (2026-02-26)
- **Affects:** TBD (most likely one of: `apps/brikette/src/app/_lib/static-params.ts`, `apps/brikette/src/i18n.config.ts`, `.github/workflows/brikette.yml` prune list)
- **Depends on:** TASK-CP-01 (activated only if TASK-01 finds artifact absent)
- **Blocks:** -
- **Confidence:** N/A — superseded by TASK-01 finding.
  - Reason: TASK-01 confirmed `apps/brikette/out/it/book.html` is PRESENT. No source fix is needed.
- **Acceptance:**
  - `out/it/book/index.html` exists after a static export build using the fixed code.
  - TASK-02 (`test -f` assertion) passes in CI.
  - The fix does not affect other locales or the file count cap.
- **Validation contract (TC-05):**
  - TC-05-01: After fix, `test -f apps/brikette/out/it/book/index.html` exits 0.
  - TC-05-02: `out/it/` directory contains all expected IT locale pages (book, rooms, etc.) — no inadvertent scope reduction.
  - TC-05-03: Static export file count remains ≤ 20 000.
- **Execution plan:** Red -> Green -> Refactor
  - Red: The absent `out/it/book/index.html` causes the TASK-02 assertion to fail.
  - Green: Apply the minimum fix identified by TASK-01 diagnosis (e.g., remove `it` from prune list if accidentally added, or restore `generateStaticParams` to include `it`).
  - Refactor: Verify no other IT locale pages are missing; run the full static export to confirm the build is clean.
- **Planning validation (M-effort):**
  - Checks run: TASK-01 diagnosis must be completed first. TASK-05 planning validation is deferred to TASK-CP-01 replan.
  - Validation artifacts: Will be provided by TASK-01 finding + replan.
  - Unexpected findings: The fact-find already rules out accidental pruning (confirmed prune list does not include `it`), making `generateStaticParams` regression or a build-time error the most likely cause if the artifact is absent.
- **Scouts:** TASK-01 serves as the scout for this task. Its finding is the required input.
- **Edge Cases & Hardening:**
  - Edge case: the fix restores IT but inadvertently re-introduces other pruned locales (e.g., by reverting the `i18n.config.ts` change from `b18aa4ee5f`). The TC-05-03 file count assertion guards against this.
- **What would make this >=90%:** TASK-01 finding reveals the exact root cause with a clear one-line fix. Without that, confidence cannot exceed 75 for this task.
- **Rollout / rollback:**
  - Rollout: Apply the identified fix, run the static export build, confirm the artifact exists, proceed with CI assertions.
  - Rollback: Revert the source change. The deployment remains broken for `/it/prenota` until a correct fix is identified.
- **Documentation impact:** Update `task-01-finding.md` with the root cause and fix applied.
- **Notes / references:**
  - This task is only activated if TASK-CP-01 finds the artifact absent.
  - `/lp-do-replan` will be invoked by the TASK-CP-01 executor to refine this task before execution.

---

## Risks & Mitigations
| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| `out/it/book/index.html` is absent due to a silent build-time failure | Low | High | TASK-01 surfaces this immediately; TASK-05 is the contingent fix. |
| Health check follows redirects and passes even when `/it/prenota` 301s to `/en` | Medium | Medium | TASK-04 adds strict no-redirect check using `curl --max-redirect 0`. |
| The smoke test observation was on the production Worker, not Pages | Medium | Low | Worker middleware correctly handles `/it/prenota`; no Worker change needed (confirmed in fact-find). |
| `_redirects` regeneration on every deploy overwrites any manual fix | High (if manual fix attempted) | High | Never edit `_redirects` directly; all changes go through `staticExportRedirects.ts` or `slug-map.ts` (enforced by fact-find planning constraint). |
| Other IT-locale localized slugs (camere, esperienze, etc.) also lack smoke coverage | High | Medium | `/it/prenota` is added as a representative route. Full IT slug coverage is deferred. |
| TASK-05 is poorly scoped because TASK-01 outcome is unknown at planning time | Medium | Medium | TASK-CP-01 triggers `/lp-do-replan` before TASK-05 executes, refining scope from TASK-01 evidence. |

## Observability
- Logging: CI `static-export-check` job "Validate static export output" step — logs file count and assertion results.
- Metrics: GA4 — monitor `/it/prenota` page_view events and `cta_click` events post-deploy for conversion recovery signal.
- Alerts/Dashboards: Post-deploy health check in staging deploy job — `/it/prenota` strict check result visible in Actions log.

## Acceptance Criteria (overall)
- [x] TASK-01 finding documented in `docs/plans/brikette-it-book-route-static-export/task-01-finding.md` — DONE (2026-02-26).
- [x] CI `static-export-check` job passes with the new `test -f apps/brikette/out/it/book.html` assertion — DONE (2026-02-26).
- [x] `staticExportRedirects.test.ts` passes with the IT book rule assertion (all three rule variants: base, trailing-slash, wildcard) — DONE (3/3 tests pass, 2026-02-26).
- [x] Staging deploy post-deploy health check includes `/it/prenota` with strict no-redirect mode — DONE (`healthcheck-strict-routes: "/it/prenota"` + `STRICT_ROUTES` env var wired, 2026-02-26).
- [x] TASK-05: Superseded — artifact confirmed present, no source fix needed.

## Decision Log
- 2026-02-26: Chosen approach: Option B (verify first, then add regression guards, with conditional fix). Rationale: the stale smoke test observation has not been re-validated since `b18aa4ee5f`; TASK-01 is fast and eliminates the remaining assumption before committing to regression-guard-only (Option A).
- 2026-02-26: TASK-04 approach: modify `post-deploy-health-check.sh` to support `STRICT_ROUTES` env var (Option A). The reusable workflow architecture does not expose an inline-step hook, so a new inline curl step in `brikette.yml` would require duplicating logic outside the shared script. The shared script modification is the correct location for this capability.
- 2026-02-26: TASK-05 is structurally conditional. It is listed in the plan but remains at Pending with low confidence until TASK-CP-01 activates or supersedes it. `/lp-do-replan` is invoked at TASK-CP-01 if the artifact is absent.

## Overall-confidence Calculation
- TASK-01: 85% × S(1) = 85
- TASK-CP-01: 95% × S(1) = 95
- TASK-02: 90% × S(1) = 90
- TASK-03: 90% × S(1) = 90
- TASK-04: 85% × S(1) = 85
- TASK-05: 70% × M(2) = 140 (conditional; included for pessimistic bound)
- Sum(confidence × weight): 85 + 95 + 90 + 90 + 85 + 140 = 585
- Sum(weight): 1 + 1 + 1 + 1 + 1 + 2 = 7
- Overall-confidence = 585 / 7 ≈ 84% (pessimistic, including TASK-05)
- Excluding TASK-05 (expected path): (85 + 95 + 90 + 90 + 85) / 5 = 89%
- Reported: 86% (midpoint between expected and pessimistic paths)
