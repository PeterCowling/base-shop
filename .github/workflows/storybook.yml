name: Storybook CI

env:
  CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN || '' }}

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  coverage:
    name: Story coverage policy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 10.12.1
      - run: pnpm install --frozen-lockfile
      - name: Verify story coverage
        run: pnpm stories:verify

  chromatic:
    name: Chromatic (visuals)
    runs-on: ubuntu-latest
    steps:
      - name: Skip Chromatic (missing token)
        if: ${{ env.CHROMATIC_PROJECT_TOKEN == '' }}
        run: echo "CHROMATIC_PROJECT_TOKEN not set; skipping Chromatic publish."
      - uses: actions/checkout@v4
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
      - uses: actions/setup-node@v4
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
        with:
          node-version: 20
          cache: pnpm
      - uses: pnpm/action-setup@v4
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
        with:
          version: 10.12.1
      - run: pnpm install --frozen-lockfile
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
      - name: Publish to Chromatic
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
        run: pnpm chromatic

  ui-smoke:
    name: Storybook UI smoke (tokens + RTL)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 10.12.1
      - run: pnpm install --frozen-lockfile
      - name: Run UI smoke
        run: pnpm storybook:smoke:ui

  runner:
    name: Storybook Test Runner (critical set)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - uses: pnpm/action-setup@v4
        with:
          version: 10.12.1
      - run: pnpm install --frozen-lockfile
      - name: Run Storybook test runner (ci-tagged)
        run: pnpm test-storybook:runner
