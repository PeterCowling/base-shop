name: Reusable App Pipeline

on:
  workflow_call:
    inputs:
      # Filter for pnpm commands, e.g. "@apps/cms" or "@apps/skylar"
      app-filter:
        required: true
        type: string
      # Command to build the app, e.g. "pnpm --filter @apps/skylar build"
      build-cmd:
        required: true
        type: string
      # Directory to archive/upload after build, e.g. "apps/skylar/out".
      # Leave empty if the deploy command handles its own build.
      artifact-path:
        required: false
        type: string
      # Command to deploy, e.g. "pnpm exec wrangler pages deploy ..."
      deploy-cmd:
        required: false
        type: string
      # Cloudflare project name (for environment context or logs)
      project-name:
        required: false
        type: string
      # GitHub "environment" name (used for URL display and any environment rules)
      environment-name:
        required: false
        type: string
        default: "production"
      # GitHub "environment" URL displayed in the Actions UI
      # (Useful when deploying preview branches or custom domains.)
      environment-url:
        required: false
        type: string
        default: ""
      # Extra args for scripts/post-deploy-health-check.sh (e.g. "--staging")
      healthcheck-args:
        required: false
        type: string
        default: ""
      # Optional override for the health check URL (e.g. custom domain)
      healthcheck-base-url:
        required: false
        type: string
        default: ""

    secrets:
      CLOUDFLARE_API_TOKEN:
        required: true
      CLOUDFLARE_ACCOUNT_ID:
        required: true
      TURBO_TOKEN:
        required: false
      SOPS_AGE_KEY:
        required: false

jobs:
  validate-and-build:
    name: Validate & build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Lint
        run: pnpm --filter ${{ inputs.app-filter }}... lint
        shell: bash

      - name: Typecheck
        run: pnpm exec turbo run typecheck --filter=${{ inputs.app-filter }}...
        shell: bash

      - name: Test
        run: pnpm --filter ${{ inputs.app-filter }} test
        shell: bash

      - name: Validate guide manifest (warn-only)
        if: ${{ inputs.app-filter == '@apps/brikette' }}
        run: |
          echo "::group::Guide Manifest Validation"
          pnpm --filter @apps/brikette validate-manifest --warn-only || true
          echo "::endgroup::"
        shell: bash
        continue-on-error: true

      - name: Guide coverage report
        if: ${{ inputs.app-filter == '@apps/brikette' }}
        run: |
          echo "::group::Guide Coverage Report"
          pnpm --filter @apps/brikette report-coverage || true
          echo "::endgroup::"
        shell: bash
        continue-on-error: true

      - name: Build
        run: ${{ inputs.build-cmd }}
        shell: bash

      - name: Upload Artifact
        if: ${{ inputs.artifact-path != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ inputs.project-name }}
          path: ${{ inputs.artifact-path }}
          retention-days: 1

  deploy:
    name: Deploy
    # Only deploy if a deploy command is provided AND we are on main or staging
    if: ${{ inputs.deploy-cmd != '' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') }}
    needs: validate-and-build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: ${{ inputs.environment-name }}
      url: ${{ inputs.environment-url != '' && inputs.environment-url || format('https://{0}.pages.dev', inputs.project-name) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-repo
        with:
          turbo-token: ${{ secrets.TURBO_TOKEN }}
          turbo-team: ${{ vars.TURBO_TEAM }}

      - name: Download Artifact
        if: ${{ inputs.artifact-path != '' }}
        uses: actions/download-artifact@v4
        with:
          name: build-artifact-${{ inputs.project-name }}
          path: ${{ inputs.artifact-path }}

      # ADMIN-04: Decrypt SOPS secrets before deploy
      - name: Decrypt secrets
        uses: ./.github/actions/decrypt-secrets
        with:
          sops-age-key: ${{ secrets.SOPS_AGE_KEY }}
          environment: "${{ github.ref_name == 'staging' && 'preview' || 'production' }}"

      # ADMIN-05: Validate environment before deploy
      - name: Validate deploy environment
        run: |
          chmod +x scripts/validate-deploy-env.sh
          ./scripts/validate-deploy-env.sh
        shell: bash

      - name: Deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: ${{ inputs.deploy-cmd }}
        shell: bash

      - name: Post-Deploy Health Check
        if: success() && inputs.project-name != ''
        run: |
          chmod +x scripts/post-deploy-health-check.sh
          ./scripts/post-deploy-health-check.sh ${{ inputs.project-name }} ${{ inputs.healthcheck-args }}
        shell: bash
        # NOTE: keep these env vars here so all app deploys get consistent behavior.
        # Apps can still override via the reusable-workflow inputs (BASE_URL) or by
        # passing EXTRA_ROUTES/MAX_RETRIES/RETRY_DELAY in their caller workflow.
        # (If you need per-app values, extend this reusable workflow rather than
        # copy-pasting it.)
        env:
          BASE_URL: ${{ inputs.healthcheck-base-url }}
          EXTRA_ROUTES: "/api/health"
          MAX_RETRIES: "10"
          RETRY_DELAY: "6"

      - name: Post-Deploy Cache Headers Check (Brikette)
        if: success() && inputs.app-filter == '@apps/brikette' && inputs.project-name != ''
        run: |
          chmod +x scripts/post-deploy-brikette-cache-check.sh
          ./scripts/post-deploy-brikette-cache-check.sh ${{ inputs.project-name }} ${{ inputs.healthcheck-args }}
        shell: bash
        env:
          BASE_URL: ${{ inputs.healthcheck-base-url }}
