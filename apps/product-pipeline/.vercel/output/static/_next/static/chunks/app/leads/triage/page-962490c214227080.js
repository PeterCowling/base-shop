(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[211],{7785:(e,t,s)=>{"use strict";s.d(t,{default:()=>p});var r=s(6586),l=s(7826),a=s(8902);function n(e){let{groups:t,strings:s,onHoldGroup:l}=e;return(0,r.jsxs)("section",{className:"pp-card p-6",children:[(0,r.jsxs)(a.BJ,{gap:2,children:[(0,r.jsx)("span",{className:"text-xs uppercase tracking-widest text-foreground/60",children:s.duplicate.label}),(0,r.jsx)("h2",{className:"text-xl font-semibold tracking-tight",children:s.duplicate.title})]}),(0,r.jsx)(a.BJ,{gap:4,className:"mt-4 text-sm",children:0===t.length?(0,r.jsx)("div",{className:"rounded-2xl border border-border-1 bg-surface-2 px-4 py-3 text-foreground/60",children:s.duplicate.empty}):t.map(e=>(0,r.jsxs)("div",{className:"rounded-3xl border border-border-1 bg-surface-2 p-4",children:[(0,r.jsxs)(a.d2,{justify:"between",alignY:"center",className:"gap-4",children:[(0,r.jsxs)(a.BJ,{gap:1,children:[(0,r.jsxs)("span",{className:"text-xs text-foreground/60",children:[s.duplicate.duplicateOf,": ",e.fingerprint]}),(0,r.jsxs)("span",{className:"text-sm font-semibold",children:[s.duplicate.primary,": ",e.primary.id]})]}),(0,r.jsx)("button",{className:"inline-flex min-h-12 min-w-12 items-center justify-center rounded-full border border-border-2 px-4 py-2 text-xs font-semibold",type:"button",onClick:()=>void l(e),children:s.duplicate.holdDuplicates})]}),(0,r.jsx)(a.BJ,{gap:2,className:"mt-4",children:e.members.map(e=>{var t,l,n,o;return(0,r.jsx)("div",{className:"rounded-2xl border border-border-1 bg-surface-1 px-3 py-2 text-xs",children:(0,r.jsxs)(a.d2,{justify:"between",alignY:"center",className:"gap-3",children:[(0,r.jsxs)("span",{className:"font-semibold",children:[e.id," - ",null!=(l=null!=(t=e.title)?t:e.url)?l:s.notAvailable]}),(0,r.jsxs)("span",{className:"text-foreground/60",children:[s.table.score,": ",(n=e.triageScore,o=s.notAvailable,null==n?o:String(n))]})]})},e.id)})})]},e.fingerprint))})]})}function o(e){let{strings:t,selectedCount:s,onApply:n}=e,[o,i]=(0,l.useState)({reasonCode:"low_signal",severity:"short_cooldown",whatWouldChange:t.cooldown.defaultWhatWouldChange,recheckDays:""}),[d,c]=(0,l.useState)(!1);(0,l.useEffect)(()=>{i(e=>({...e,whatWouldChange:e.whatWouldChange||t.cooldown.defaultWhatWouldChange}))},[t.cooldown.defaultWhatWouldChange]);let u=(0,l.useCallback)(async e=>{if(e.preventDefault(),0!==s){c(!0);try{await n(o)}finally{c(!1)}}},[o,n,s]),p=d||0===s,x=[{value:"low_signal",label:t.options.reasonLowSignal},{value:"hazmat_keyword",label:t.options.reasonHazmatKeyword},{value:"price_too_low",label:t.options.reasonPriceTooLow},{value:"price_too_high",label:t.options.reasonPriceTooHigh},{value:"price_high",label:t.options.reasonPriceHigh},{value:"short_title",label:t.options.reasonShortTitle},{value:"duplicate_existing",label:t.options.reasonDuplicateExisting},{value:"duplicate_batch",label:t.options.reasonDuplicateBatch},{value:"policy_blocked",label:t.options.reasonPolicyBlocked}],m=[{value:"short_cooldown",label:t.options.severityShort},{value:"long_cooldown",label:t.options.severityLong},{value:"permanent",label:t.options.severityPermanent}];return(0,r.jsxs)("section",{className:"pp-card p-6",children:[(0,r.jsxs)(a.BJ,{gap:2,children:[(0,r.jsx)("span",{className:"text-xs uppercase tracking-widest text-foreground/60",children:t.cooldown.label}),(0,r.jsx)("h2",{className:"text-xl font-semibold tracking-tight",children:t.cooldown.title})]}),(0,r.jsxs)("form",{className:"mt-4 grid gap-4 md:grid-cols-2",onSubmit:u,children:[(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.cooldown.reason,(0,r.jsx)("select",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:o.reasonCode,onChange:e=>i(t=>({...t,reasonCode:e.target.value})),disabled:p,children:x.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.cooldown.severity,(0,r.jsx)("select",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:o.severity,onChange:e=>i(t=>({...t,severity:e.target.value})),disabled:p,children:m.map(e=>(0,r.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60 md:col-span-2",children:[t.cooldown.whatWouldChange,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:o.whatWouldChange,onChange:e=>i(t=>({...t,whatWouldChange:e.target.value})),disabled:p,type:"text"})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.cooldown.recheckDays,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:o.recheckDays,onChange:e=>i(t=>({...t,recheckDays:e.target.value})),disabled:p,type:"number",min:1,step:1})]}),(0,r.jsxs)(a.d2,{justify:"between",alignY:"center",className:"gap-3 md:col-span-2",children:[(0,r.jsx)("span",{className:"text-xs text-foreground/60",children:0===s?t.cooldown.noSelection:t.cooldown.apply}),(0,r.jsx)("button",{className:"min-h-12 min-w-12 rounded-full bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground disabled:cursor-not-allowed disabled:opacity-60",type:"submit",disabled:p||!o.whatWouldChange.trim(),children:t.actions.rejectCooldown})]})]})]})}function i(e){let{strings:t,draftFilters:s,promotionLimit:l,message:n,loading:o,runningStageP:i,eligibleCount:d,promotionValid:c,onDraftChange:u,onPromotionLimitChange:p,onApply:x,onReset:m,onRunStageP:h,onPromoteTop:g}=e,b=i||0===d;return(0,r.jsxs)("section",{className:"pp-card p-6",children:[(0,r.jsxs)(a.BJ,{gap:2,children:[(0,r.jsx)("span",{className:"text-xs uppercase tracking-widest text-foreground/60",children:t.filters.label}),(0,r.jsx)("h2",{className:"text-xl font-semibold tracking-tight",children:t.filters.title})]}),(0,r.jsxs)("div",{className:"mt-4 grid gap-4 md:grid-cols-3",children:[(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.filters.source,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:s.source,onChange:e=>u({...s,source:e.target.value}),disabled:o,type:"text"})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.filters.sourceContext,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:s.sourceContext,onChange:e=>u({...s,sourceContext:e.target.value}),disabled:o,type:"text"})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.filters.search,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:s.search,onChange:e=>u({...s,search:e.target.value}),disabled:o,type:"text"})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.filters.status,(0,r.jsxs)("select",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:s.status,onChange:e=>u({...s,status:e.target.value}),disabled:o,children:[(0,r.jsx)("option",{value:"",children:t.options.all}),(0,r.jsx)("option",{value:"NEW",children:t.options.statusNew}),(0,r.jsx)("option",{value:"ON_HOLD",children:t.options.statusHold}),(0,r.jsx)("option",{value:"PROMOTED",children:t.options.statusPromoted}),(0,r.jsx)("option",{value:"REJECTED",children:t.options.statusRejected})]})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.filters.triageBand,(0,r.jsxs)("select",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:s.triageBand,onChange:e=>u({...s,triageBand:e.target.value}),disabled:o,children:[(0,r.jsx)("option",{value:"",children:t.options.all}),(0,r.jsx)("option",{value:"high",children:t.options.triageHigh}),(0,r.jsx)("option",{value:"medium",children:t.options.triageMedium}),(0,r.jsx)("option",{value:"low",children:t.options.triageLow})]})]}),(0,r.jsxs)("label",{className:"text-xs uppercase tracking-widest text-foreground/60",children:[t.actions.promoteCount,(0,r.jsx)("input",{className:"mt-2 w-full rounded-2xl border border-border-1 bg-surface-2 px-3 py-2 text-sm text-foreground shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/30",value:l,onChange:e=>p(e.target.value),disabled:o,type:"number",min:1})]})]}),(0,r.jsxs)(a.d2,{justify:"between",alignY:"center",className:"mt-4 gap-3",children:[(0,r.jsx)("span",{className:"text-xs text-foreground/60",children:null!=n?n:t.notAvailable}),(0,r.jsxs)(a.d2,{gap:2,alignY:"center",children:[(0,r.jsx)("button",{className:"min-h-12 min-w-12 rounded-full border border-border-2 px-4 py-2 text-sm",type:"button",onClick:x,disabled:o,children:t.filters.apply}),(0,r.jsx)("button",{className:"min-h-12 min-w-12 rounded-full border border-border-2 px-4 py-2 text-sm",type:"button",onClick:m,disabled:o,children:t.filters.reset}),(0,r.jsx)("button",{className:"min-h-12 min-w-12 rounded-full bg-primary px-4 py-2 text-sm font-semibold text-primary-foreground disabled:cursor-not-allowed disabled:opacity-60",type:"button",onClick:h,disabled:b,children:t.actions.runStageP}),(0,r.jsx)("button",{className:"min-h-12 min-w-12 rounded-full border border-border-2 px-4 py-2 text-sm font-semibold disabled:cursor-not-allowed disabled:opacity-60",type:"button",onClick:g,disabled:b||!c,children:t.actions.promoteTop})]})]})]})}function d(e){let{strings:t,leads:s,loading:l,selectedSet:a,allSelected:n,onToggleSelectAll:o,onToggleSelected:i,duplicateLookup:d}=e;return(0,r.jsxs)("section",{className:"pp-card p-6",children:[(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("span",{className:"text-xs uppercase tracking-widest text-foreground/60",children:t.results.label}),(0,r.jsx)("h2",{className:"text-xl font-semibold tracking-tight",children:t.results.title})]}),(0,r.jsx)("div",{className:"mt-4 overflow-hidden rounded-2xl border border-border-1",children:(0,r.jsxs)("table",{className:"pp-table","aria-busy":l,children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:(0,r.jsx)("input",{type:"checkbox","aria-label":t.table.select,checked:n,onChange:o})}),(0,r.jsx)("th",{children:t.table.lead}),(0,r.jsx)("th",{children:t.table.source}),(0,r.jsx)("th",{children:t.table.context}),(0,r.jsx)("th",{children:t.table.triage}),(0,r.jsx)("th",{children:t.table.score}),(0,r.jsx)("th",{children:t.table.status}),(0,r.jsx)("th",{children:t.table.duplicate}),(0,r.jsx)("th",{children:t.table.reasons})]})}),(0,r.jsx)("tbody",{children:l?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:9,className:"px-4 py-6 text-sm text-foreground/60",children:t.messages.loading})}):0===s.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:9,className:"px-4 py-6 text-sm text-foreground/60",children:t.messages.empty})}):s.map(e=>{var s,l,n,o,c,u,p;let x=null!=(n=null!=(l=e.title)?l:e.url)?n:t.notAvailable,m=null!=(o=e.source)?o:t.notAvailable,h=null!=(c=e.sourceContext)?c:t.notAvailable,g=e.triageBand?e.triageBand.toUpperCase():t.notAvailable,b=null!==e.triageScore&&void 0!==e.triageScore?String(e.triageScore):t.notAvailable,f=null!=(u=e.status)?u:t.notAvailable,y=null!=(p=null==(s=e.triageReasons)?void 0:s.join(", "))?p:t.notAvailable,v=d.get(e.id),j=v?v.isPrimary?t.duplicate.primary:"".concat(t.duplicate.duplicateOf," ").concat(v.primaryId):t.notAvailable;return(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:(0,r.jsx)("input",{type:"checkbox","aria-label":t.table.select,checked:a.has(e.id),onChange:()=>i(e.id)})}),(0,r.jsx)("td",{className:"font-semibold",children:x}),(0,r.jsx)("td",{className:"text-sm text-foreground/70",children:m}),(0,r.jsx)("td",{className:"text-sm text-foreground/70",children:h}),(0,r.jsx)("td",{children:(0,r.jsx)("span",{className:"rounded-full border border-border-2 px-2 py-1 text-xs",children:g})}),(0,r.jsx)("td",{className:"font-semibold",children:b}),(0,r.jsx)("td",{children:(0,r.jsx)("span",{className:"text-xs text-foreground/60",children:f})}),(0,r.jsx)("td",{className:"text-xs text-foreground/60",children:j}),(0,r.jsx)("td",{className:"text-xs text-foreground/60",children:y})]},e.id)})})]})})]})}let c={source:"",sourceContext:"",status:"",triageBand:"",search:""};function u(e){var t;let s=null!=(t=e.fingerprint)?t:null;return{...e,fingerprint:null!=s?s:function(e){if(e.url)try{let t=new URL(e.url),s=t.hostname.replace(/^www\./,""),r=t.pathname.replace(/\/+$/,"");return"url:".concat(s).concat(r).toLowerCase()}catch(e){}if(e.title){let t=e.title.toLowerCase().replace(/[^a-z0-9]+/g," ").trim();return t?"title:".concat(t):null}return null}({title:e.title,url:e.url})}}function p(e){let{strings:t}=e,[s,a]=(0,l.useState)([]),[p,x]=(0,l.useState)(!0),[m,h]=(0,l.useState)(!1),[g,b]=(0,l.useState)(null),[f,y]=(0,l.useState)([]),[v,j]=(0,l.useState)(c),[w,N]=(0,l.useState)(c),[C,k]=(0,l.useState)("5"),S=(0,l.useMemo)(()=>(function(e){let t=Number.parseInt(e,10);if(Number.isFinite(t)&&!(t<=0))return t})(C),[C]),P=(0,l.useCallback)(async()=>{x(!0);try{let e=new URLSearchParams;e.set("limit","200"),v.source&&e.set("source",v.source),v.sourceContext&&e.set("source_context",v.sourceContext),v.status&&e.set("status",v.status),v.triageBand&&e.set("triage_band",v.triageBand),v.search&&e.set("q",v.search);let t=await fetch("/api/leads?".concat(e.toString()));if(!t.ok)return;let s=await t.json();if(s.ok&&Array.isArray(s.leads)){a(s.leads);let e=new Set(s.leads.map(e=>e.id));y(t=>t.filter(t=>e.has(t)))}}catch(e){console.error(e),b(t.messages.error)}finally{x(!1)}},[v,t.messages.error]);(0,l.useEffect)(()=>{P()},[P]);let _=(0,l.useMemo)(()=>s.map(u),[s]),O=(0,l.useMemo)(()=>(function(e){var t,s;let r=new Map;for(let s of e){if(!s.fingerprint)continue;let e=null!=(t=r.get(s.fingerprint))?t:[];e.push(s),r.set(s.fingerprint,e)}let l=[];for(let[e,t]of r.entries()){if(t.length<2)continue;let r=[...t].sort((e,t)=>{var s,r,l,a;let n=null!=(s=e.triageScore)?s:-1/0,o=null!=(r=t.triageScore)?r:-1/0;if(n!==o)return o-n;let i=null!=(l=e.createdAt)?l:"",d=null!=(a=t.createdAt)?a:"";return i.localeCompare(d)}),a=null!=(s=r[0])?s:t[0];a&&l.push({fingerprint:e,primary:a,members:r})}return l})(_),[_]),A=(0,l.useMemo)(()=>{let e=new Map;for(let t of _)t.duplicateOf&&e.set(t.id,{primaryId:t.duplicateOf,isPrimary:!1});for(let t of O)for(let s of t.members)e.set(s.id,{primaryId:t.primary.id,isPrimary:s.id===t.primary.id});return e},[O,_]),D=(0,l.useMemo)(()=>s.filter(e=>"NEW"===e.status||"ON_HOLD"===e.status).map(e=>e.id),[s]),T=(0,l.useMemo)(()=>new Set(f),[f]),W=s.length>0&&s.every(e=>T.has(e.id)),B=(0,l.useCallback)(()=>{y(e=>{if(0===s.length)return e;let t=s.map(e=>e.id);return t.every(t=>e.includes(t))?[]:t})},[s]),L=(0,l.useCallback)(e=>{y(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),E=(0,l.useCallback)(async()=>{if(0!==D.length){h(!0),b(t.messages.running);try{await fetch("/api/stages/p/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leadIds:D})}),b(t.messages.runComplete)}catch(e){console.error(e),b(t.messages.error)}finally{h(!1),await P()}}},[D,P,t.messages]),J=(0,l.useCallback)(async()=>{if(0!==D.length){h(!0),b(t.messages.running);try{await fetch("/api/stages/p/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({leadIds:D,promotionLimit:S})}),b(t.messages.runComplete)}catch(e){console.error(e),b(t.messages.error)}finally{h(!1),await P()}}},[D,P,S,t.messages]),H=(0,l.useCallback)(()=>{j(w)},[w]),M=(0,l.useCallback)(()=>{N(c),j(c)},[]),R=(0,l.useCallback)(async(e,t)=>{await fetch("/api/leads/".concat(e),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:t})})},[]),I=(0,l.useCallback)(async e=>{for(let t of e.members.filter(t=>t.id!==e.primary.id))await R(t.id,"ON_HOLD");await P()},[P,R]),Y=(0,l.useCallback)(async e=>{if(0===f.length)return void b(t.cooldown.noSelection);let s=0,r=function(e){let t=Number.parseInt(e,10);if(Number.isFinite(t)&&!(t<=0))return t}(e.recheckDays);for(let t of _){if(!T.has(t.id)||!t.fingerprint)continue;let l={fingerprint:t.fingerprint,reasonCode:e.reasonCode,severity:e.severity,whatWouldChange:e.whatWouldChange,...r?{recheckAfterDays:r}:{},snapshot:{leadId:t.id,source:t.source,title:t.title}};if((await fetch("/api/cooldowns",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})).ok){let r="permanent"===e.severity?"REJECTED":"ON_HOLD";await R(t.id,r),s+=1}}b(s>0?t.cooldown.success:t.cooldown.error),y([]),await P()},[_,P,f.length,T,t.cooldown,R]),z=(0,l.useMemo)(()=>[..._].sort((e,t)=>{var s,r;let l=null!=(s=e.triageScore)?s:-1/0;return(null!=(r=t.triageScore)?r:-1/0)-l}),[_]);return(0,r.jsxs)("div",{className:"grid gap-6",children:[(0,r.jsx)(i,{strings:t,draftFilters:w,promotionLimit:C,message:g,loading:p,runningStageP:m,eligibleCount:D.length,promotionValid:!!S,onDraftChange:N,onPromotionLimitChange:k,onApply:H,onReset:M,onRunStageP:E,onPromoteTop:J}),(0,r.jsx)(d,{strings:t,leads:z,loading:p,selectedSet:T,allSelected:W,onToggleSelectAll:B,onToggleSelected:L,duplicateLookup:A}),(0,r.jsx)(o,{strings:t,selectedCount:f.length,onApply:Y}),(0,r.jsx)(n,{groups:O,strings:t,onHoldGroup:I})]})}},8269:(e,t,s)=>{Promise.resolve().then(s.bind(s,7785)),Promise.resolve().then(s.bind(s,6423)),Promise.resolve().then(s.bind(s,368)),Promise.resolve().then(s.bind(s,8634)),Promise.resolve().then(s.bind(s,5016)),Promise.resolve().then(s.bind(s,9602)),Promise.resolve().then(s.bind(s,9633)),Promise.resolve().then(s.bind(s,1875)),Promise.resolve().then(s.bind(s,6884)),Promise.resolve().then(s.bind(s,5216)),Promise.resolve().then(s.bind(s,124)),Promise.resolve().then(s.bind(s,4274))}},e=>{var t=t=>e(e.s=t);e.O(0,[2827,9683,7106,4668,8902,9956,2459,7358],()=>t(8269)),_N_E=e.O()}]);