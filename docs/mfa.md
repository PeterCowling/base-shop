Type: Guide
Status: Active
Domain: Auth
Last-reviewed: 2025-12-02

# Multi-Factor Authentication (MFA)

This guide describes how the platform uses Time-based One-Time Passwords (TOTP) to protect customer accounts.

## CustomerMfa model

`CustomerMfa` stores MFA details for each customer:

| Field | Type | Description |
| --- | --- | --- |
| `customerId` | string | Unique customer identifier |
| `secret` | string | Shared TOTP secret |
| `enabled` | boolean | Indicates whether MFA is active |

## TOTP basics

TOTP generates short-lived numeric codes using a shared secret and the current time, typically in 30â€‘second steps. Authenticator apps (Google Authenticator, Authy, etc.) read an `otpauth://` URI to set up the secret, often via scanning a QR code.

## Core functions

### `enrollMfa`

`enrollMfa(customerId)` creates or updates a `CustomerMfa` record with a new secret and returns that secret along with an `otpauth` URI suitable for QR code generation.

```ts
import { enrollMfa } from "@acme/auth/mfa";

const { secret, otpauth } = await enrollMfa(customer.id);
// display a QR code based on `otpauth` to the user
```

### `verifyMfa`

`verifyMfa(customerId, token)` checks a token generated by the user's authenticator app. If the token is valid and MFA is not yet enabled, the corresponding record is updated to set `enabled` to `true`.

```ts
import { verifyMfa } from "@acme/auth/mfa";

const valid = await verifyMfa(customer.id, token);
if (!valid) {
  throw new Error("Invalid MFA code");
}
```

### `isMfaEnabled`

`isMfaEnabled(customerId)` returns whether the customer has MFA enabled.

```ts
import { isMfaEnabled } from "@acme/auth/mfa";

if (await isMfaEnabled(customer.id)) {
  // require MFA before continuing
}
```

## Example flow

1. **Enroll:** Call `enrollMfa` and present the `otpauth` URI as a QR code for the customer to scan.
2. **Verify:** Prompt for a TOTP code and call `verifyMfa`. A valid token enables MFA for the account.
3. **Check:** Use `isMfaEnabled` to gate sensitive actions on the customer account.
