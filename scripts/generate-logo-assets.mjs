/**
 * Shared logo asset generator for the startup loop.
 *
 * Reads brand parameters from CLI flags, writes SVG source files, renders
 * rasters via Playwright + sharp, and writes a site.webmanifest.
 *
 * Usage:
 *   node scripts/generate-logo-assets.mjs \
 *     --app-dir apps/caryina \
 *     --name Caryina \
 *     --icon-char y \
 *     --primary "#E29CA2" \
 *     --accent "#ABC4AF" \
 *     --bg "#FAF9F7" \
 *     --font-family "Cormorant Garamond"
 *
 * All flags are required except --bg-dark (defaults to a dark variant of --bg)
 * and --font-weight-main (defaults to 500) / --font-weight-accent (defaults to 300).
 *
 * Outputs written to <app-dir>/public/:
 *   logo-wordmark.svg        — full wordmark SVG (live text, Google Fonts)
 *   logo-icon.svg            — icon character SVG (live text, Google Fonts)
 *   favicon.svg              — copy of logo-icon.svg
 *   apple-touch-icon.png     — 180×180 PNG
 *   icon-192.png             — 192×192 PNG
 *   icon-512.png             — 512×512 PNG
 *   og-image.png             — 1200×630 PNG
 *   og-image.webp            — 1200×630 WebP (quality 92)
 *   site.webmanifest         — PWA manifest JSON
 */

import { chromium } from "playwright";
import sharp from "sharp";
import { writeFileSync, copyFileSync, mkdirSync, existsSync } from "fs";
import { resolve, join } from "path";
import { fileURLToPath } from "url";

// ---------------------------------------------------------------------------
// Argument parsing
// ---------------------------------------------------------------------------

function parseArgs(argv) {
  const args = {};
  for (let i = 0; i < argv.length; i++) {
    const key = argv[i];
    if (key.startsWith("--")) {
      const name = key.slice(2);
      const value = argv[i + 1];
      if (value !== undefined && !value.startsWith("--")) {
        args[name] = value;
        i++;
      } else {
        args[name] = true;
      }
    }
  }
  return args;
}

function usage() {
  console.log(`
Usage: node scripts/generate-logo-assets.mjs [flags]

Required:
  --app-dir <path>        Path to the Next.js app (e.g. apps/caryina)
  --name <string>         Full business name for the wordmark (e.g. Caryina)
  --icon-char <char>      Single character for the icon mark (e.g. y)
  --primary <hex>         Primary brand colour (e.g. "#E29CA2")
  --accent <hex>          Accent colour for the icon character (e.g. "#ABC4AF")
  --bg <hex>              Background colour (e.g. "#FAF9F7")
  --font-family <string>  Google Fonts family name (e.g. "Cormorant Garamond")

Optional:
  --bg-dark <hex>         Dark background colour (default: derived from --bg)
  --weight-main <num>     Font weight for main letters (default: 500)
  --weight-accent <num>   Font weight for icon character (default: 300)
  --letter-spacing <num>  Letter spacing in px at 46px font size (default: 7)
  --help                  Show this help

Example:
  node scripts/generate-logo-assets.mjs \\
    --app-dir apps/caryina \\
    --name Caryina \\
    --icon-char y \\
    --primary "#E29CA2" \\
    --accent "#ABC4AF" \\
    --bg "#FAF9F7" \\
    --font-family "Cormorant Garamond"
`);
}

// ---------------------------------------------------------------------------
// SVG generation
// ---------------------------------------------------------------------------

function buildWordmarkSvg({ name, iconChar, primary, accent, bg, fontFamily, weightMain, weightAccent, letterSpacing }) {
  const encodedFamily = encodeURIComponent(fontFamily);
  const iconIdx = name.indexOf(iconChar);
  const prefix = iconIdx >= 0 ? name.slice(0, iconIdx) : name;
  const suffix = iconIdx >= 0 ? name.slice(iconIdx + 1) : "";
  const hasAccent = iconIdx >= 0 && iconChar.length === 1;

  const mainTspan = `<tspan font-weight="${weightMain}" fill="${primary}">${prefix}</tspan>`;
  const accentTspan = hasAccent
    ? `<tspan font-weight="${weightAccent}" fill="${accent}">${iconChar}</tspan>`
    : "";
  const suffixTspan =
    suffix.length > 0
      ? `<tspan font-weight="${weightMain}" fill="${primary}">${suffix}</tspan>`
      : "";

  return `<?xml version="1.0" encoding="UTF-8"?>
<!--
  ${name} wordmark — generated by scripts/generate-logo-assets.mjs
  Font: ${fontFamily} (Google Fonts — confirm licence before trademark use)
-->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 88" role="img" aria-label="${name}">
  <title>${name}</title>
  <defs>
    <style><![CDATA[
      @import url('https://fonts.googleapis.com/css2?family=${encodedFamily}:wght@${weightAccent};${weightMain}&display=swap');
    ]]></style>
  </defs>
  <rect width="320" height="88" fill="${bg}"/>
  <text
    font-family="'${fontFamily}', Georgia, serif"
    font-size="46"
    letter-spacing="${letterSpacing}"
    x="20"
    y="59"
  >${mainTspan}${accentTspan}${suffixTspan}</text>
</svg>
`;
}

function buildIconSvg({ iconChar, accent, bg, fontFamily, weightAccent }) {
  const encodedFamily = encodeURIComponent(fontFamily);
  return `<?xml version="1.0" encoding="UTF-8"?>
<!--
  ${iconChar} icon mark — generated by scripts/generate-logo-assets.mjs
-->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" role="img" aria-label="${iconChar}">
  <title>${iconChar}</title>
  <defs>
    <style><![CDATA[
      @import url('https://fonts.googleapis.com/css2?family=${encodedFamily}:wght@${weightAccent}&display=swap');
    ]]></style>
  </defs>
  <rect width="200" height="200" fill="${bg}"/>
  <text
    font-family="'${fontFamily}', Georgia, serif"
    font-weight="${weightAccent}"
    font-size="140"
    fill="${accent}"
    text-anchor="middle"
    x="102"
    y="158"
  >${iconChar}</text>
</svg>
`;
}

// ---------------------------------------------------------------------------
// Raster rendering
// ---------------------------------------------------------------------------

async function renderSvgToPng(browser, svgContent, width, height) {
  const page = await browser.newPage();
  await page.setViewportSize({ width, height });

  await page.setContent(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: ${width}px; height: ${height}px; overflow: hidden; }
        img { width: 100%; height: 100%; display: block; }
      </style>
    </head>
    <body>
      <img src="data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgContent)}" />
    </body>
    </html>
  `);

  await page.waitForFunction(() => document.fonts.ready);
  await page.waitForTimeout(500);

  const buffer = await page.screenshot({ type: "png" });
  await page.close();
  return buffer;
}

async function renderOgImage(browser, { name, iconChar, primary, accent, bg, fontFamily, weightMain, weightAccent }) {
  const iconIdx = name.indexOf(iconChar);
  const prefix = iconIdx >= 0 ? name.slice(0, iconIdx) : name;
  const suffix = iconIdx >= 0 ? name.slice(iconIdx + 1) : "";
  const hasAccent = iconIdx >= 0 && iconChar.length === 1;
  const encodedFamily = encodeURIComponent(`${fontFamily}:wght@${weightAccent};${weightMain}`);

  const page = await browser.newPage();
  await page.setViewportSize({ width: 1200, height: 630 });

  await page.setContent(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=${encodedFamily}&display=swap" rel="stylesheet">
      <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
          width: 1200px; height: 630px;
          background: ${bg};
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        }
        .wordmark {
          font-family: '${fontFamily}', Georgia, serif;
          font-size: 96px;
          letter-spacing: 14px;
          white-space: nowrap;
        }
        .main { font-weight: ${weightMain}; color: ${primary}; }
        .accent { font-weight: ${weightAccent}; color: ${accent}; }
      </style>
    </head>
    <body>
      <span class="wordmark">
        <span class="main">${prefix}</span>${hasAccent ? `<span class="accent">${iconChar}</span><span class="main">${suffix}</span>` : ""}
      </span>
    </body>
    </html>
  `);

  await page.waitForFunction(() => document.fonts.ready);
  await page.waitForTimeout(600);

  const buffer = await page.screenshot({ type: "png" });
  await page.close();
  return buffer;
}

// ---------------------------------------------------------------------------
// Manifest
// ---------------------------------------------------------------------------

function buildManifest({ name, primary, bg }) {
  const shortName = name.length > 12 ? name.slice(0, 12) : name;
  return JSON.stringify(
    {
      short_name: shortName,
      name,
      icons: [
        { src: "/favicon.svg", type: "image/svg+xml", sizes: "any" },
        { src: "/apple-touch-icon.png", type: "image/png", sizes: "180x180" },
        { src: "/icon-192.png", type: "image/png", sizes: "192x192" },
        { src: "/icon-512.png", type: "image/png", sizes: "512x512" },
      ],
      start_url: "/",
      display: "standalone",
      theme_color: primary,
      background_color: bg,
    },
    null,
    2
  );
}

// ---------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------

async function main() {
  const args = parseArgs(process.argv.slice(2));

  if (args.help) {
    usage();
    process.exit(0);
  }

  const required = ["app-dir", "name", "icon-char", "primary", "accent", "bg", "font-family"];
  const missing = required.filter((k) => !args[k]);
  if (missing.length > 0) {
    console.error(`Missing required flags: ${missing.map((k) => `--${k}`).join(", ")}`);
    usage();
    process.exit(1);
  }

  const appDir = resolve(args["app-dir"]);
  const name = args["name"];
  const iconChar = args["icon-char"];
  const primary = args["primary"];
  const accent = args["accent"];
  const bg = args["bg"];
  const fontFamily = args["font-family"];
  const weightMain = args["weight-main"] ?? "500";
  const weightAccent = args["weight-accent"] ?? "300";
  const letterSpacing = args["letter-spacing"] ?? "7";

  const publicDir = join(appDir, "public");
  if (!existsSync(publicDir)) {
    mkdirSync(publicDir, { recursive: true });
  }

  console.log(`Generating logo assets for "${name}" → ${appDir}`);

  // Write SVG source files
  console.log("Writing logo-wordmark.svg...");
  const wordmarkSvg = buildWordmarkSvg({ name, iconChar, primary, accent, bg, fontFamily, weightMain, weightAccent, letterSpacing });
  writeFileSync(join(publicDir, "logo-wordmark.svg"), wordmarkSvg);

  console.log("Writing logo-icon.svg...");
  const iconSvg = buildIconSvg({ iconChar, accent, bg, fontFamily, weightAccent });
  writeFileSync(join(publicDir, "logo-icon.svg"), iconSvg);

  // Copy favicon.svg
  console.log("Copying favicon.svg...");
  copyFileSync(join(publicDir, "logo-icon.svg"), join(publicDir, "favicon.svg"));

  // Write manifest
  console.log("Writing site.webmanifest...");
  writeFileSync(join(publicDir, "site.webmanifest"), buildManifest({ name, primary, bg }));

  // Render rasters
  const browser = await chromium.launch();
  try {
    console.log("Rendering apple-touch-icon.png (180×180)...");
    const icon180 = await renderSvgToPng(browser, iconSvg, 180, 180);
    writeFileSync(join(publicDir, "apple-touch-icon.png"), icon180);

    console.log("Rendering icon-192.png (192×192)...");
    const icon192 = await sharp(icon180).resize(192, 192).png().toBuffer();
    writeFileSync(join(publicDir, "icon-192.png"), icon192);

    console.log("Rendering icon-512.png (512×512)...");
    const icon512 = await renderSvgToPng(browser, iconSvg, 512, 512);
    writeFileSync(join(publicDir, "icon-512.png"), icon512);

    console.log("Rendering og-image.png (1200×630)...");
    const ogPng = await renderOgImage(browser, { name, iconChar, primary, accent, bg, fontFamily, weightMain, weightAccent });
    writeFileSync(join(publicDir, "og-image.png"), ogPng);

    console.log("Converting og-image to WebP...");
    const ogWebp = await sharp(ogPng).webp({ quality: 92 }).toBuffer();
    writeFileSync(join(publicDir, "og-image.webp"), ogWebp);
  } finally {
    await browser.close();
  }

  console.log(`
Done. Files written to ${publicDir}/:
  logo-wordmark.svg
  logo-icon.svg
  favicon.svg
  apple-touch-icon.png  (180×180)
  icon-192.png          (192×192)
  icon-512.png          (512×512)
  og-image.png          (1200×630)
  og-image.webp         (1200×630)
  site.webmanifest

To wire into Next.js layout.tsx, add to the metadata export:
  icons: { icon: '/favicon.svg', apple: '/apple-touch-icon.png' },
  manifest: '/site.webmanifest',
  openGraph: { images: [{ url: '/og-image.png', width: 1200, height: 630 }] },
  twitter: { card: 'summary_large_image', images: ['/og-image.png'] },
`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
